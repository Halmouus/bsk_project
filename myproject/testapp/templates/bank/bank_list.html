{% extends 'base.html' %}
{% block content %}
<div class="container-fluid px-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Bank Accounts</h2>
        <button class="btn btn-primary" data-toggle="modal" data-target="#bankAccountModal">
            <i class="fas fa-plus"></i> New Bank Account
        </button>
    </div>

    <!-- Accounts Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Bank</th>
                            <th>Account Number</th>
                            <th>Type</th>
                            <th>City</th>
                            <th>Status</th>
                            <th>Current Account</th>
                            <th>Check Discount</th>
                            <th>LCN Discount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tbody>
                            {% for account in accounts %}
                            <tr>
                                <td>{{ account.get_bank_display }}</td>
                                <td>{{ account.account_number }}</td>
                                <td>{{ account.get_account_type_display }}</td>
                                <td>{{ account.city }}</td>
                                <td>
                                    <span class="badge {% if account.is_active %}badge-success{% else %}badge-danger{% endif %}">
                                        {{ account.is_active|yesno:"Active,Inactive" }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge {% if account.is_current %}badge-primary{% else %}badge-secondary{% endif %}">
                                        {{ account.is_current|yesno:"Yes,No" }}
                                    </span>
                                </td>
                                <td>
                                    {% if account.has_check_discount_line %}
                                        <span class="badge badge-info">
                                            {{ account.check_discount_line_amount|default:0|floatformat:2 }} MAD
                                        </span>
                                    {% else %}
                                        <span class="badge badge-secondary">No</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if account.has_lcn_discount_line %}
                                        <span class="badge badge-info">
                                            {{ account.lcn_discount_line_amount|default:0|floatformat:2 }} MAD
                                        </span>
                                    {% else %}
                                        <span class="badge badge-secondary">No</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-primary" onclick="editBankAccount('{{ account.id }}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteBankAccount('{{ account.id }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                                <td style="display:none">
                                    Check line: {{ account.get_available_check_discount_line }}
                                    LCN line: {{ account.get_available_lcn_discount_line }}
                                    Raw check amount: {{ account.check_discount_line_amount }}
                                    Raw lcn amount: {{ account.lcn_discount_line_amount }}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="text-center">No bank accounts found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Bank Account Modal -->
<div class="modal fade" id="bankAccountModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">New Bank Account</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="bankAccountForm">
                    {% csrf_token %}
                    <input type="hidden" id="accountId">
                    
                    <!-- Basic Information -->
                    <div class="card mb-3">
                        <div class="card-header">
                            Basic Information
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Bank</label>
                                        <select class="form-control" id="bank" required>
                                            {% for code, name in bank_choices %}
                                            <option value="{{ code }}">{{ name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Account Number</label>
                                        <input type="text" class="form-control" id="accountNumber" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Accounting Number</label>
                                        <input type="text" class="form-control" id="accountingNumber" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Journal Number</label>
                                        <input type="text" class="form-control" id="journalNumber" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>City</label>
                                        <input type="text" class="form-control" id="city" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Account Type</label>
                                        <select class="form-control" id="accountType" required>
                                            <option value="national">National</option>
                                            <option value="international">International</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mt-4">
                                        <input type="checkbox" class="form-check-input" id="isActive" checked>
                                        <label class="form-check-label">Active Account</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="isCurrent">
                                        <label class="form-check-label">Current Account</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Parameters -->
                    <div class="card mb-3">
                        <div class="card-header">
                            Financial Parameters
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Bank Overdraft</label>
                                        <input type="number" class="form-control" id="bankOverdraft" step="0.01" min="0">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Overdraft Fee (%)</label>
                                        <input type="number" class="form-control" id="overdraftFee" step="0.01" min="0">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input type="checkbox" class="form-check-input" id="hasCheckDiscountLine">
                                        <label class="form-check-label">Has Check Discount Line</label>
                                    </div>
                                    <div class="form-group check-discount-amount d-none">
                                        <label>Check Discount Line Amount</label>
                                        <input type="number" class="form-control" id="checkDiscountLineAmount" step="0.01" min="0">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input type="checkbox" class="form-check-input" id="hasLcnDiscountLine">
                                        <label class="form-check-label">Has LCN Discount Line</label>
                                    </div>
                                    <div class="form-group lcn-discount-amount d-none">
                                        <label>LCN Discount Line Amount</label>
                                        <input type="number" class="form-control" id="lcnDiscountLineAmount" step="0.01" min="0">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Stamp Fee per Receipt</label>
                                        <input type="number" class="form-control" id="stampFeePerReceipt" step="0.01" min="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveBankAccount">Save</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const BankAccountManager = {
    init() {
        this.bindEvents();
        this.setupValidation();
    },

    bindEvents() {
        $('#saveBankAccount').on('click', () => this.saveBankAccount());
        
        // Toggle discount line amount inputs
        $('#hasCheckDiscountLine').change(function() {
            $('.check-discount-amount').toggleClass('d-none', !this.checked);
            if (this.checked) {
                $('#checkDiscountLineAmount').prop('required', true);
            } else {
                $('#checkDiscountLineAmount').prop('required', false).val('');
            }
        });

        $('#hasLcnDiscountLine').change(function() {
            $('.lcn-discount-amount').toggleClass('d-none', !this.checked);
            if (this.checked) {
                $('#lcnDiscountLineAmount').prop('required', true);
            } else {
                $('#lcnDiscountLineAmount').prop('required', false).val('');
            }
        });

        // Reset form on modal close
        $('#bankAccountModal').on('hidden.bs.modal', () => {
            this.resetForm();
        });
    },

    setupValidation() {
        const form = document.getElementById('bankAccountForm');
        
        // Add validation for numeric fields
        ['bankOverdraft', 'overdraftFee', 'checkDiscountLineAmount', 
         'lcnDiscountLineAmount', 'stampFeePerReceipt'].forEach(id => {
            const input = document.getElementById(id);
            input.addEventListener('input', () => {
                const value = parseFloat(input.value);
                if (value < 0) {
                    input.setCustomValidity('Value must be positive');
                } else {
                    input.setCustomValidity('');
                }
            });
        });
    },

    async saveBankAccount() {
        const form = document.getElementById('bankAccountForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const data = {
            bank: $('#bank').val(),
            account_number: $('#accountNumber').val(),
            accounting_number: $('#accountingNumber').val(),
            journal_number: $('#journalNumber').val(),
            city: $('#city').val(),
            account_type: $('#accountType').val(),
            is_active: $('#isActive').prop('checked'),
            is_current: $('#isCurrent').prop('checked'),
            bank_overdraft: $('#bankOverdraft').val() || null,
            overdraft_fee: $('#overdraftFee').val() || null,
            has_check_discount_line: $('#hasCheckDiscountLine').prop('checked'),
            check_discount_line_amount: $('#hasCheckDiscountLine').prop('checked') ? 
                $('#checkDiscountLineAmount').val() : null,
            has_lcn_discount_line: $('#hasLcnDiscountLine').prop('checked'),
            lcn_discount_line_amount: $('#hasLcnDiscountLine').prop('checked') ? 
                $('#lcnDiscountLineAmount').val() : null,
            stamp_fee_per_receipt: $('#stampFeePerReceipt').val() || null
        };

        const id = $('#accountId').val();
        const url = id ? 
            `/testapp/bank-accounts/${id}/edit/` : 
            '/testapp/bank-accounts/create/';
        const method = id ? 'POST' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (response.ok) {
                $('#bankAccountModal').modal('hide');
                showToast('Success', result.message);
                location.reload();
            } else {
                showToast('Error', result.message);
            }
        } catch (error) {
            showToast('Error', 'Failed to save bank account');
            console.error('Error:', error);
        }
    },

    resetForm() {
        const form = document.getElementById('bankAccountForm');
        form.reset();
        $('#accountId').val('');
        $('#modalTitle').text('New Bank Account');
        $('.check-discount-amount, .lcn-discount-amount').addClass('d-none');
        $('#checkDiscountLineAmount, #lcnDiscountLineAmount').prop('required', false);
    }
};

// Initialize when document is ready
$(document).ready(function() {
    BankAccountManager.init();
});

// Global functions for edit and delete
function editBankAccount(id) {
    fetch(`/testapp/bank-accounts/${id}/edit/`)
        .then(response => response.json())
        .then(data => {
            $('#accountId').val(id);
            $('#modalTitle').text('Edit Bank Account');
            
            // Fill in the form
            $('#bank').val(data.bank);
            $('#accountNumber').val(data.account_number);
            $('#accountingNumber').val(data.accounting_number);
            $('#journalNumber').val(data.journal_number);
            $('#city').val(data.city);
            $('#accountType').val(data.account_type);
            $('#isActive').prop('checked', data.is_active);
            $('#isCurrent').prop('checked', data.is_current);
            $('#bankOverdraft').val(data.bank_overdraft);
            $('#overdraftFee').val(data.overdraft_fee);
            $('#hasCheckDiscountLine').prop('checked', data.has_check_discount_line).trigger('change');
            $('#checkDiscountLineAmount').val(data.check_discount_line_amount);
            $('#hasLcnDiscountLine').prop('checked', data.has_lcn_discount_line).trigger('change');
            $('#lcnDiscountLineAmount').val(data.lcn_discount_line_amount);
            $('#stampFeePerReceipt').val(data.stamp_fee_per_receipt);
            
            $('#bankAccountModal').modal('show');
        })
        .catch(error => {
            showToast('Error', 'Failed to load bank account details');
            console.error('Error:', error);
        });
}

function deleteBankAccount(id) {
    if (!confirm('Are you sure you want to delete this bank account?')) {
        return;
    }

    fetch(`/testapp/bank-accounts/${id}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                showToast('Success', result.message);
                location.reload();
            } else {
                showToast('Error', result.message);
            }
        })
        .catch(error => {
            showToast('Error', 'Failed to delete bank account');
            console.error('Error:', error);
        });
}

function showToast(title, message) {
    // Implementation remains the same as before
}
</script>
{% endblock %}