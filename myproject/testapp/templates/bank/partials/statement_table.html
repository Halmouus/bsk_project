{% load accounting_filters %} 

{% for entry in entries %}
    {% if entry.type == 'BANK_FEE' %}
        <tr class="fee-row" data-fee-id="{{ entry.source_id }}">
            <td>
                {% if entry.can_transfer %}
                <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input record-checkbox" 
                           id="record{{ entry.source_id }}"
                           data-amount="{{ entry.credit }}"
                           data-source-type="{{ entry.source_type }}"
                           data-source-id="{{ entry.source_id }}"
                           data-date="{{ entry.date|date:'Y-m-d' }}"
                           data-label="{{ entry.label }}"
                           data-reference="{{ entry.reference }}">
                    <label class="custom-control-label" for="record{{ entry.source_id }}"></label>
                </div>
                {% endif %}
                {% if entry.is_transferred %}
                <span class="badge badge-info" title="Transferred">
                    <i class="fas fa-exchange-alt"></i>
                </span>
                {% endif %}
            </td>
            <td>{{ entry.date|date:"Y-m-d" }}</td>
            <td>
                {{ entry.label }}
                {% if entry.is_expandable %}
                <button class="btn btn-sm btn-link toggle-fee-details">
                    <i class="fas fa-chevron-down"></i>
                </button>
                {% endif %}
            </td>
            <td>
                <span class="badge badge-warning">
                    {{ entry.type }}
                </span>
            </td>
            <td class="text-right text-danger">{{ entry.debit|format_balance }}</td>
            <td class="text-right text-success">{{ entry.credit|format_balance }}</td>
            <td>{{ entry.reference }}</td>
            <td class="text-right">{{ entry.balance|format_balance }}</td>
            <td>
                <div class="btn-group">
                    {% if entry.can_delete %}
                    <button class="btn btn-sm btn-danger" onclick="deleteBankFee('{{ entry.source_id }}')">
                        <i class="fas fa-trash"></i>
                    </button>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% if entry.is_expandable %}
        <tr class="fee-details-row d-none" data-fee-id="{{ entry.source_id }}">
            <td colspan="8">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Fee Type:</strong><br>
                                {{ entry.details.fee_type }}
                            </div>
                            <div class="col-md-3">
                                <strong>Raw Amount:</strong><br>
                                {{ entry.details.raw_amount|format_balance }}
                            </div>
                            <div class="col-md-3">
                                <strong>VAT Rate:</strong><br>
                                {{ entry.details.vat_rate }}%
                            </div>
                            <div class="col-md-3">
                                <strong>VAT Included:</strong><br>
                                {{ entry.details.vat_included|yesno:"Yes,No" }}
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <strong>VAT Amount:</strong><br>
                                {{ entry.details.vat_amount|format_balance }}
                            </div>
                            <div class="col-md-4">
                                <strong>Total Amount:</strong><br>
                                {{ entry.details.total_amount|format_balance }}
                            </div>
                            <div class="col-md-4">
                                <strong>Related Presentation:</strong><br>
                                {{ entry.details.related_presentation|default:"None" }}
                            </div>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
        {% endif %}
    {% else %}
        <tr>
            <td>
                {% if entry.can_transfer %}
                <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input record-checkbox" 
                           id="record{{ entry.source_id }}"
                           data-amount="{{ entry.credit }}"
                           data-source-type="{{ entry.source_type }}"
                           data-source-id="{{ entry.source_id }}"
                           data-date="{{ entry.date|date:'Y-m-d' }}"
                           data-label="{{ entry.label }}"
                           data-reference="{{ entry.reference }}">
                    <label class="custom-control-label" for="record{{ entry.source_id }}"></label>
                </div>
                {% endif %}
                {% if entry.is_transferred %}
                <span class="badge badge-info" title="Transferred">
                    <i class="fas fa-exchange-alt"></i>
                </span>
                {% endif %}
            </td>
            <td>{{ entry.date|date:"Y-m-d" }}</td>
            <td>{{ entry.label }}</td>
            <td>
                <span class="badge badge-{{ entry.type|lower }}">
                    {{ entry.type }}
                </span>
            </td>
            <td class="text-right text-danger">
                {% if entry.debit %}{{ entry.debit|format_balance }}{% endif %}
            </td>
            <td class="text-right text-success">
                {% if entry.credit %}{{ entry.credit|format_balance }}{% endif %}
            </td>
            <td>{{ entry.reference }}</td>
            <td class="text-right {% if entry.balance > 0 %}text-success{% else %}text-danger{% endif %}">
                {{ entry.balance|format_balance }}
            </td>
            <td>
                {% if entry.source_type == 'presentation_receipt' %}
                <button class="btn btn-sm btn-info" onclick="viewPresentation('{{ entry.source_id }}')">
                    <i class="fas fa-eye"></i>
                </button>
                {% endif %}
            </td>
        </tr>
    {% endif %}
{% empty %}
    <tr>
        <td colspan="8" class="text-center">No entries found</td>
    </tr>
{% endfor %}