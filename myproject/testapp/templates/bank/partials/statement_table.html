{% load accounting_filters %} 

{% for entry in entries %}
<tr class="record-row {% if entry.type != 'BALANCE' %}hoverable{% endif %}" 
    data-record-id="{{ entry.display_id|default:entry.source_id }}" 
    data-type="{{ entry.type|lower }}">
    <td>
        {% if entry.can_transfer %}
        <div class="custom-control custom-checkbox">
            <input type="checkbox" class="custom-control-input record-checkbox" 
                   id="record{{ entry.source_id }}"
                   data-amount="{{ entry.credit }}"
                   data-source-type="{{ entry.source_type }}"
                   data-source-id="{{ entry.source_id }}"
                   data-date="{{ entry.date|date:'Y-m-d' }}"
                   data-label="{{ entry.label }}"
                   data-reference="{{ entry.reference }}">
            <label class="custom-control-label" for="record{{ entry.source_id }}"></label>
        </div>
        {% endif %}
        {% if entry.is_transferred %}
        <span class="badge badge-info" title="Transferred">
            <i class="fas fa-exchange-alt"></i>
        </span>
        {% endif %}
    </td>
    <td>{{ entry.date|date:"Y-m-d" }}</td>
    <td>
        {{ entry.label }}
    </td>
    <td>
        <span class="badge badge-{{ entry.type|lower }}">
            {{ entry.type }}
        </span>
    </td>
    <td class="text-right text-danger">
        {% if entry.debit %}{{ entry.debit|format_balance }}{% endif %}
    </td>
    <td class="text-right text-success">
        {% if entry.credit %}{{ entry.credit|format_balance }}{% endif %}
    </td>
    <td>{{ entry.reference }}</td>
    <td class="text-right {% if entry.balance > 0 %}text-success{% else %}text-danger{% endif %}">
        {{ entry.balance|format_balance }}
    </td>
    <td>
        <!-- Add a toggle button to show the details -->
        {% if entry.type != 'BALANCE' %}
            <button class="btn btn-sm btn-link toggle-details" title="Show Details">
                <i class="fas fa-chevron-down"></i>
            </button>
        {% endif %}

        <!-- Add your existing action buttons if needed -->
        {% if entry.can_delete %}
            {% if entry.type == 'BANK_FEE' %}
                <button class="btn btn-sm btn-danger" onclick="deleteBankFee('{{ entry.source_id }}')">
                    <i class="fas fa-trash"></i>
                </button>
            {% else %}
                <button class="btn btn-sm btn-danger" onclick="deleteTransfer('{{ entry.source_id }}')">
                    <i class="fas fa-trash"></i>
                </button>
            {% endif %}
        {% endif %}
    </td>
</tr>

<!-- The details row: hidden by default -->
<tr class="details-row d-none" data-record-id="{{ entry.display_id|default:entry.source_id }}">
    <td colspan="9">
        <div class="card">
            <div class="card-body">
                {% if entry.type == 'BANK_FEE' %}
                    <!-- Bank fee details -->
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Fee Type:</strong><br>
                            {{ entry.details.fee_type }}
                        </div>
                        <div class="col-md-3">
                            <strong>Raw Amount:</strong><br>
                            {{ entry.details.raw_amount|format_balance }}
                        </div>
                        <div class="col-md-3">
                            <strong>VAT Rate:</strong><br>
                            {{ entry.details.vat_rate }}%
                        </div>
                        <div class="col-md-3">
                            <strong>VAT Included:</strong><br>
                            {{ entry.details.vat_included|yesno:"Yes,No" }}
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <strong>VAT Amount:</strong><br>
                            {{ entry.details.vat_amount|format_balance }}
                        </div>
                        <div class="col-md-4">
                            <strong>Total Amount:</strong><br>
                            {{ entry.details.total_amount|format_balance }}
                        </div>
                        <div class="col-md-4">
                            <strong>Related Presentation:</strong><br>
                            {{ entry.details.related_presentation|default:"None" }}
                        </div>
                    </div>
                {% elif entry.type == 'CASH' %}
                    <div class="row">
                        <div class="col-md-4">
                            <div class="detail-item">
                                <div class="detail-label"><i class="fas fa-building me-2"></i>Entity</div>
                                <div class="detail-value">{{ entry.entity.name }}</div>
                                <small class="text-muted">{{ entry.entity.ice_code }}</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-item">
                                <div class="detail-label"><i class="fas fa-user me-2"></i>Client</div>
                                <div class="detail-value">{{ entry.client.name }}</div>
                                <small class="text-muted">{{ entry.client.client_code }}</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-item">
                                <div class="detail-label"><i class="fas fa-calendar me-2"></i>Operation Date</div>
                                <div class="detail-value">{{ entry.operation_date|date:"Y-m-d" }}</div>
                            </div>
                        </div>
                    </div>
                {% elif entry.type == 'TRANSFER' %}
                    <div class="row">
                        <div class="col-md-3">
                            <div class="detail-item">
                                <div class="detail-label"><i class="fas fa-building me-2"></i>Entity</div>
                                <div class="detail-value">{{ entry.entity.name }}</div>
                                <small class="text-muted">{{ entry.entity.ice_code }}</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="detail-item">
                                <div class="detail-label"><i class="fas fa-user me-2"></i>Client</div>
                                <div class="detail-value">{{ entry.client.name }}</div>
                                <small class="text-muted">{{ entry.client.client_code }}</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="detail-item">
                                <div class="detail-label"><i class="fas fa-calendar me-2"></i>Operation Date</div>
                                <div class="detail-value">{{ entry.operation_date|date:"Y-m-d" }}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="detail-item">
                                <div class="detail-label"><i class="fas fa-calendar-check me-2"></i>Transfer Date</div>
                                <div class="detail-value">{{ entry.transfer_date|date:"Y-m-d" }}</div>
                            </div>
                        </div>
                    </div>
                {% elif entry.type == 'INTERBANK_TRANSFER_OUT' or entry.type == 'INTERBANK_TRANSFER_IN' %}
                    <div class="row">
                        <div class="col-md-4">
                            <div class="detail-item">
                                <div class="detail-label"><i class="fas fa-university me-2"></i>From Bank</div>
                                <div class="detail-value">{{ entry.from_bank.bank }} - {{ entry.from_bank.account_number }}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-item">
                                <div class="detail-label"><i class="fas fa-university me-2"></i>To Bank</div>
                                <div class="detail-value">{{ entry.to_bank.bank }} - {{ entry.to_bank.account_number }}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-item">
                                <div class="detail-label"><i class="fas fa-calendar me-2"></i>Operation Date</div>
                                <div class="detail-value">{{ entry.date|date:"Y-m-d" }}</div>
                            </div>
                        </div>
                    </div>
                {% elif 'REVERSAL' in entry.type %}
                    <div class="row">
                        <div class="col-md-4">
                            <div class="detail-item">
                                <div class="detail-label"><i class="fas fa-building me-2"></i>Entity</div>
                                <div class="detail-value">{{ entry.entity.name }}</div>
                                <small class="text-muted">{{ entry.entity.ice_code }}</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-item">
                                <div class="detail-label"><i class="fas fa-user me-2"></i>Client</div>
                                <div class="detail-value">{{ entry.client.name }}</div>
                                <small class="text-muted">{{ entry.client.client_code }}</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-item">
                                <div class="detail-label"><i class="fas fa-university me-2"></i>Issuing Bank</div>
                                <div class="detail-value">{{ entry.issuing_bank_display }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <div class="detail-item">
                                <div class="detail-label"><i class="fas fa-hashtag me-2"></i>Reference</div>
                                <div class="detail-value">{{ entry.reference }}</div>
                                <small class="text-muted">Original Discount: {{ entry.discount_reference }}</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-item">
                                <div class="detail-label"><i class="fas fa-calendar me-2"></i>Due Date</div>
                                <div class="detail-value">{{ entry.due_date|date:"Y-m-d" }}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-item">
                                <div class="detail-label"><i class="fas fa-info-circle me-2"></i>Status</div>
                                <div class="detail-value">
                                    <span class="badge badge-{{ entry.status|lower }}">{{ entry.status }}</span>
                                    {% if entry.rejection_cause %}
                                        <br><small class="text-danger mt-1">{{ entry.rejection_cause_display }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% elif 'CHECK' in entry.type or 'LCN' in entry.type %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <strong>Entity:</strong><br>
                                {{ entry.entity.name }} ({{ entry.entity.ice_code }})
                            </div>
                            <div class="mb-3">
                                <strong>Client:</strong><br>
                                {{ entry.client.name }} ({{ entry.client.client_code }})
                            </div>
                            <div class="mb-3">
                                <strong>Due Date:</strong><br>
                                {{ entry.due_date|date:"Y-m-d" }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <strong>Issuing Bank:</strong><br>
                                {{ entry.issuing_bank_display }}
                            </div>
                            <div class="mb-3">
                                <strong>Operation Details:</strong><br>
                                {% if entry.type == 'CHECK_DISCOUNT' or entry.type == 'LCN_DISCOUNT' %}
                                    Discount Date: {{ entry.date|date:"Y-m-d" }}<br>
                                    {% if entry.presentation_reference %}
                                        Presentation: {{ entry.presentation_reference }}
                                    {% endif %}
                                {% elif entry.type == 'CHECK_COLLECTION' or entry.type == 'LCN_COLLECTION' %}
                                    Collection Date: {{ entry.date|date:"Y-m-d" }}<br>
                                    {% if entry.presentation_reference %}
                                        Presentation: {{ entry.presentation_reference }}
                                    {% endif %}
                                {% endif %}
                            </div>
                            {% if entry.status %}
                            <div class="mb-3">
                                <strong>Status:</strong><br>
                                <span class="badge badge-{{ entry.status|lower }}">
                                    {{ entry.status }}
                                </span>
                                {% if entry.rejection_cause %}
                                    <br><small class="text-danger">{{ entry.rejection_cause_display }}</small>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </td>
</tr>
{% empty %}
<tr>
    <td colspan="9" class="text-center">No entries found</td>
</tr>
{% endfor %}
