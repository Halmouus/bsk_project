{% extends 'base.html' %}
{% load accounting_filters %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>{{ bank_account.bank }} - {{ bank_account.account_number }} Statement</h2>
        <div class="d-flex gap-2">
            <!-- Transfer Button -->
            <button id="transferBtn" class="btn btn-primary" disabled>
                <i class="fas fa-exchange-alt me-2"></i> Transfer Selected
            </button>
            <!-- Add button to header section -->
            <button class="btn btn-info ms-2" id="addBankFee">
                <i class="fas fa-coins me-2"></i>
                Add Bank Fee
            </button>
            <!-- Filter Form -->
            <form class="form-inline" id="statementFilterForm">
                <div class="input-group">
                    <input type="date" class="form-control" name="start_date" id="startDate">
                    <input type="date" class="form-control" name="end_date" id="endDate">
                    <button type="submit" class="btn btn-primary">Apply</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Total Debit</h5>
                    <p class="card-text text-danger h4" id="total-debit">{{ total_debit|format_balance }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Total Credit</h5>
                    <p class="card-text text-success h4" id="total-credit">{{ total_credit|format_balance }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Balance</h5>
                    <p class="card-text h4 {% if final_balance > 0 %}text-success{% else %}text-danger{% endif %}" id="final-balance">
                        {{ final_balance|format_balance }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Statement Table -->
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="selectAll">
                            <label class="custom-control-label" for="selectAll"></label>
                        </div>
                    </th>
                    <th>Date</th>
                    <th>Label</th>
                    <th>Type</th>
                    <th class="text-right">Debit</th>
                    <th class="text-right">Credit</th>
                    <th>Reference</th>
                    <th class="text-right">Balance</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="statementTableBody">
                {% for entry in entries %}
                {% if entry.type == 'BANK_FEE' %}
                <tr class="fee-row" data-fee-id="{{ entry.source_id }}">
                    <td>
                        {% if entry.can_transfer %}
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input record-checkbox" 
                                id="record{{ entry.source_id }}"
                                data-amount="{{ entry.credit }}"
                                data-source-type="{{ entry.source_type }}"
                                data-source-id="{{ entry.source_id }}"
                                data-date="{{ entry.date|date:'Y-m-d' }}"
                                data-label="{{ entry.label }}"
                                data-reference="{{ entry.reference }}">
                            <label class="custom-control-label" for="record{{ entry.source_id }}"></label>
                        </div>
                        {% endif %}
                        {% if entry.is_transferred %}
                        <span class="badge badge-info" title="Transferred">
                            <i class="fas fa-exchange-alt"></i>
                        </span>
                        {% endif %}
                    </td>
                    <td>{{ entry.date|date:"Y-m-d" }}</td>
                    <td>
                        {{ entry.label }}
                        {% if entry.is_expandable %}
                        <button class="btn btn-sm btn-link toggle-fee-details">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge badge-warning">
                            {{ entry.type }}
                        </span>
                    </td>
                    <td class="text-right text-danger">{{ entry.debit|format_balance }}</td>
                    <td class="text-right text-success">{{ entry.credit|format_balance }}</td>
                    <td>{{ entry.reference }}</td>
                    <td class="text-right">{{ entry.balance|format_balance }}</td>
                    <td>
                        <div class="btn-group">
                            {% if entry.can_delete %}
                            <button class="btn btn-sm btn-danger" onclick="deleteBankFee('{{ entry.source_id }}')">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% if entry.is_expandable %}
                <tr class="fee-details-row d-none" data-fee-id="{{ entry.source_id }}">
                    <td colspan="8">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <strong>Fee Type:</strong><br>
                                        {{ entry.details.fee_type }}
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Raw Amount:</strong><br>
                                        {{ entry.details.raw_amount|format_balance }}
                                    </div>
                                    <div class="col-md-3">
                                        <strong>VAT Rate:</strong><br>
                                        {{ entry.details.vat_rate }}%
                                    </div>
                                    <div class="col-md-3">
                                        <strong>VAT Included:</strong><br>
                                        {{ entry.details.vat_included|yesno:"Yes,No" }}
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <strong>VAT Amount:</strong><br>
                                        {{ entry.details.vat_amount|format_balance }}
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Total Amount:</strong><br>
                                        {{ entry.details.total_amount|format_balance }}
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Related Presentation:</strong><br>
                                        {{ entry.details.related_presentation|default:"None" }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% else %}
                <tr>
                    <td>
                        {% if entry.can_transfer %}
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input record-checkbox" 
                                   id="record{{ entry.source_id }}"
                                   data-amount="{{ entry.credit }}"
                                   data-source-type="{{ entry.source_type }}"
                                   data-source-id="{{ entry.source_id }}"
                                   data-date="{{ entry.date|date:'Y-m-d' }}"
                                   data-label="{{ entry.label }}"
                                   data-reference="{{ entry.reference }}">
                            <label class="custom-control-label" for="record{{ entry.source_id }}"></label>
                        </div>
                        {% endif %}
                        {% if entry.is_transferred %}
                        <span class="badge badge-info" title="Transferred">
                            <i class="fas fa-exchange-alt"></i>
                        </span>
                        {% endif %}
                    </td>
                    <td>{{ entry.date|date:"Y-m-d" }}</td>
                    <td>{{ entry.label }}</td>
                    <td>
                        <span class="badge badge-{{ entry.type|lower }}">
                            {{ entry.type }}
                        </span>
                    </td>
                    <td class="text-right text-danger">
                        {% if entry.debit %}{{ entry.debit|format_balance }}{% endif %}
                    </td>
                    <td class="text-right text-success">
                        {% if entry.credit %}{{ entry.credit|format_balance }}{% endif %}
                    </td>
                    <td>{{ entry.reference }}</td>
                    <td class="text-right {% if entry.balance > 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ entry.balance|format_balance }}
                    </td>
                    <td>
                        <div class="btn-group">
                            {% if entry.can_delete %}
                                {% if entry.type == 'BANK_FEE' %}
                                    <button class="btn btn-sm btn-danger" onclick="deleteBankFee('{{ entry.source_id }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                {% else %}
                                    <button class="btn btn-sm btn-danger" onclick="deleteTransfer('{{ entry.source_id }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                {% endif %}
                            {% endif %}
                            {% if entry.source_type == 'presentation_receipt' %}
                            <button class="btn btn-sm btn-info" onclick="viewPresentation('{{ entry.source_id }}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% else %}
                            <button class="btn btn-sm btn-info" 
                                    onclick="viewReceipt('{{ entry.source_type }}', '{{ entry.source_id }}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center">No entries found for this period</td>
                </tr>
                {% endfor %}
            </tbody>
            

<!-- Transfer Modal -->
<div class="modal fade" id="transferModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt me-2"></i>
                    Create Interbank Transfer
                </h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="transferForm">
                    {% csrf_token %}
                    <!-- Transfer Details -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Transfer To</label>
                                        <select class="form-control" id="toBankAccount" required>
                                            <option value="">Select Bank Account</option>
                                            {% for account in bank_accounts %}
                                                {% if account.id != bank_account.id %}
                                                    <option value="{{ account.id }}">
                                                        {{ account.bank }} - {{ account.account_number }}
                                                    </option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Transfer Date</label>
                                        <input type="date" class="form-control" id="transferDate" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Label</label>
                                        <input type="text" class="form-control" id="transferLabel" 
                                               value="Interbank Transfer">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Records -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Selected Records</h6>
                            <span class="text-primary">
                                Total: <strong id="selectedTotal">0.00</strong> MAD
                            </span>
                        </div>
                        <div class="card-body">
                            <div id="selectedRecordsList" class="list-group list-group-flush">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveTransfer">
                    <i class="fas fa-save me-2"></i>
                    Create Transfer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bank Fee Modal -->
<div class="modal fade" id="bankFeeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-coins me-2"></i>
                    Record Bank Fee
                </h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="bankFeeForm">
                    {% csrf_token %}
                    <!-- Fee Details -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Fee Type</label>
                                        <select class="form-control" id="feeType" required>
                                            <option value="">Select Fee Type</option>
                                            {% for fee_type in fee_types %}
                                            <option value="{{ fee_type.id }}">
                                                {{ fee_type.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Date</label>
                                        <input type="date" class="form-control" id="feeDate" required>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mt-3">
                                <label>Related Presentation</label>
                                <input type="text" class="form-control" id="relatedPresentation" placeholder="Search by reference...">
                            </div>
                        </div>
                    </div>

                    <!-- Amount Details -->
                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Fee Amount</label>
                                        <input type="number" class="form-control" id="rawAmount" 
                                               step="0.01" min="0.01" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>VAT Rate (%)</label>
                                        <select class="form-control" id="vatRate">
                                            <option value="">No VAT</option>
                                            <option value="20">20%</option>
                                            <option value="16">16%</option>
                                            <option value="11">11%</option>
                                            <option value="10" selected>10%</option>
                                            <option value="7">7%</option>
                                            <option value="0">0%</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-check mt-3">
                                <input type="checkbox" class="form-check-input" id="vatIncluded">
                                <label class="form-check-label" for="vatIncluded">
                                    VAT Included in Amount
                                </label>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>VAT Amount</label>
                                        <input type="number" class="form-control" id="vatAmount" 
                                               step="0.01" min="0" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Total Amount</label>
                                        <input type="number" class="form-control" id="totalAmount" 
                                               step="0.01" min="0.01" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveBankFee">
                    <i class="fas fa-save me-2"></i>
                    Record Fee
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<style>
    /* Fee Row Styling */
    .fee-row {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .fee-row:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }

    .fee-row .toggle-fee-details {
        padding: 0;
        margin-left: 8px;
        color: #6c757d;
        transition: transform 0.3s;
    }

    /* Details Row Styling */
    .fee-details-row {
        background-color: #f8f9fa;
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .fee-details-row .card {
        border: none;
        margin: 0;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }

    .fee-details-row .card-body {
        padding: 1.5rem;
    }

    .fee-details-row strong {
        color: #6c757d;
        font-size: 0.875rem;
    }

    /* Button Spacing & Styling */
    .btn-group {
        gap: 0.5rem;
    }

    .btn-group > .btn {
        border-radius: 0.375rem !important;
        margin: 0;
    }

    /* Modal Enhancements */
    .modal-content {
        border: none;
        border-radius: 0.5rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    .modal-header {
        background: linear-gradient(45deg, #4e73df, #224abe);
        color: white;
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
        padding: 1.5rem;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        padding: 1rem 1.5rem;
        background-color: #f8f9fa;
        border-bottom-left-radius: 0.5rem;
        border-bottom-right-radius: 0.5rem;
    }

    /* Form Styling */
    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-control {
        border-radius: 0.375rem;
        padding: 0.625rem 0.875rem;
        border-color: #e2e8f0;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-control:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.15);
    }

    /* Table Enhancements */
    .table {
        margin-bottom: 0;
    }

    .table th {
        font-weight: 600;
        color: #4a5568;
        border-top: none;
        padding: 1rem;
    }

    .table td {
        padding: 1rem;
        vertical-align: middle;
    }

    /* Badge Enhancements */
    .badge {
        padding: 0.5em 0.75em;
        font-weight: 500;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.025em;
    }
</style>

{% block extra_js %}
<script>
$(document).ready(function() {
    // ===== Bank Fee Management =====
    $('#addBankFee').click(function() {
        $('#feeDate').val(new Date().toISOString().split('T')[0]);
        $('#bankFeeModal').modal('show');
    });

    // Initialize presentation autocomplete
    $("#relatedPresentation").autocomplete({
        minLength: 2,
        source: function(request, response) {
            $.ajax({
                url: '{% url "presentation-autocomplete" %}',
                dataType: 'json',
                data: { term: request.term },
                success: function(data) {
                    response($.map(data.results, function(item) {
                        return {
                            label: item.text,
                            value: item.id
                        };
                    }));
                }
            });
        },
        select: function(event, ui) {
            $(this).val(ui.item.label);
            $(this).data('selected-id', ui.item.value);
            return false;
        }
    });

    // ===== VAT Calculations =====
    function calculateAmounts() {
        const rawAmount = parseFloat($('#rawAmount').val()) || 0;
        const vatRate = parseFloat($('#vatRate').val()) || 0;
        const vatIncluded = $('#vatIncluded').prop('checked');

        let vatAmount = 0;
        let totalAmount = 0;

        if (vatRate === 0) {
            totalAmount = rawAmount;
        } else if (vatIncluded) {
            const vatMultiplier = (vatRate / 100) + 1;
            const rawAmountCalculated = rawAmount / vatMultiplier;
            vatAmount = rawAmount - rawAmountCalculated;
            totalAmount = rawAmount;
            $('#rawAmount').val(rawAmountCalculated.toFixed(2));
        } else {
            vatAmount = rawAmount * (vatRate / 100);
            totalAmount = rawAmount + vatAmount;
        }

        $('#vatAmount').val(vatAmount.toFixed(2));
        $('#totalAmount').val(totalAmount.toFixed(2));
    }

    $('#rawAmount, #vatRate').on('input change', calculateAmounts);
    $('#vatIncluded').on('change', calculateAmounts);

    // ===== Fee Row Collapsing =====
    $(document).on('click', '.fee-row', function(e) {
        // Don't trigger if clicking button
        if ($(e.target).closest('.btn-group').length || $(e.target).is('input')) {
            return;
        }
        
        const feeId = $(this).data('fee-id');
        const detailsRow = $(`.fee-details-row[data-fee-id="${feeId}"]`);
        const icon = $(this).find('.toggle-fee-details i');
        
        detailsRow.toggleClass('d-none');
        icon.toggleClass('fa-chevron-down fa-chevron-up');
    });

    // ===== Bank Fee Creation =====
    $('#saveBankFee').click(async function() {
        if (!$('#bankFeeForm')[0].checkValidity()) {
            $('#bankFeeForm')[0].reportValidity();
            return;
        }

        const data = {
            bank_account: '{{ bank_account.id }}',
            fee_type: $('#feeType').val(),
            date: $('#feeDate').val(),
            related_presentation: $('#relatedPresentation').data('selected-id'),
            raw_amount: $('#rawAmount').val(),
            vat_rate: $('#vatRate').val(),
            vat_included: $('#vatIncluded').prop('checked'),
            vat_amount: $('#vatAmount').val(),
            total_amount: $('#totalAmount').val()
        };

        try {
            const response = await fetch('{% url "create-bank-fee" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                $('#bankFeeModal').modal('hide');
                showToast('Bank fee recorded successfully', 'success');
                location.reload();
            } else {
                showToast(result.message || 'Failed to record bank fee', 'error');
            }
        } catch (error) {
            console.error('Fee creation error:', error);
            showToast('Failed to record bank fee', 'error');
        }
    });

    // ===== Date Range Filtering =====
$('#startDate, #endDate').on('change', function() {
    const startDate = $('#startDate').val();
    const endDate = $('#endDate').val();
    
    // Don't filter if one date is set and the other isn't
    if ((startDate && !endDate) || (!startDate && endDate)) {
        return;
    }
    
    // Don't filter if end date is before start date
    if (startDate && endDate && startDate > endDate) {
        showToast('Start date must be before end date', 'error');
        return;
    }

    console.log('Applying filters:', { startDate, endDate });

    // Show loading state
    $('#statementTableBody').html('<tr><td colspan="9" class="text-center"><div class="spinner-border text-primary" role="status"></div></td></tr>');
    
    $.ajax({
        url: window.location.pathname,
        method: 'GET',
        data: startDate || endDate ? {
            start_date: startDate,
            end_date: endDate
        } : {},
        success: function(response) {
            if (response && response.html) {
                $('#statementTableBody').html(response.html);
            }
            
            if (response && response.totals) {
                // Update summary cards using your format_balance filter
                $('#total-debit').text(formatBalance(response.totals.debit));
                $('#total-credit').text(formatBalance(response.totals.credit));
                
                const balance = response.totals.balance;
                const balanceElement = $('#final-balance');
                balanceElement.text(formatBalance(Math.abs(balance)));
                balanceElement
                    .removeClass('text-success text-danger')
                    .addClass(parseFloat(balance) >= 0 ? 'text-success' : 'text-danger');
            }
        },

        
        
        error: function(xhr, status, error) {
            console.error('Filter error details:', {
                status: xhr.status,
                statusText: xhr.statusText,
                responseText: xhr.responseText,
                error: error
            });
            
            let message = 'Failed to filter statement';
            try {
                const response = JSON.parse(xhr.responseText);
                message = response.error || message;
            } catch(e) {
                console.error('Error parsing response:', e);
            }
            showToast(message, 'error');
        }
    });
});

// Remove the form submit handler since we're using change events
$('#statementFilterForm').on('submit', function(e) {
    e.preventDefault();
});
    // ===== Transfer Management =====
    let selectedRecords = new Map();
    
    $('.record-checkbox').change(function() {
        const $checkbox = $(this);
        const recordData = {
            source_type: $checkbox.data('source-type'),
            source_id: $checkbox.data('source-id'),
            amount: $checkbox.data('amount'),
            date: $checkbox.data('date'),
            label: $checkbox.data('label'),
            reference: $checkbox.data('reference')
        };
        
        if (this.checked) {
            selectedRecords.set(recordData.source_id, recordData);
        } else {
            selectedRecords.delete(recordData.source_id);
        }
        
        updateSelectionUI();
    });
    
    $('#selectAll').change(function() {
        $('.record-checkbox:not(:disabled)').prop('checked', this.checked).trigger('change');
    });
    
    function updateSelectionUI() {
        const totalAmount = Array.from(selectedRecords.values())
            .reduce((sum, record) => sum + parseFloat(record.amount), 0);
            
        $('#transferBtn').prop('disabled', selectedRecords.size === 0);
        $('#selectedTotal').text(totalAmount.toFixed(2));
        
        const $list = $('#selectedRecordsList');
        $list.empty();
        
        selectedRecords.forEach(record => {
            $list.append(`
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <div class="font-weight-bold">${record.label}</div>
                        <small class="text-muted">
                            ${record.date} | Ref: ${record.reference}
                        </small>
                    </div>
                    <span class="text-success">${parseFloat(record.amount).toFixed(2)} MAD</span>
                </div>
            `);
        });
    }
    
    $('#transferBtn').click(function() {
        $('#transferDate').val(new Date().toISOString().split('T')[0]);
        $('#transferModal').modal('show');
    });
    
    $('#saveTransfer').click(async function() {
        if (!$('#transferForm')[0].checkValidity()) {
            $('#transferForm')[0].reportValidity();
            return;
        }
        
        const data = {
            from_bank: '{{ bank_account.id }}',
            to_bank: $('#toBankAccount').val(),
            date: $('#transferDate').val(),
            label: $('#transferLabel').val(),
            records: Array.from(selectedRecords.values())
        };
        
        try {
            const response = await fetch('{% url "create-transfer" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                $('#transferModal').modal('hide');
                showToast('Transfer created successfully', 'success');
                location.reload();
            } else {
                showToast(result.message || 'Failed to create transfer', 'error');
            }
        } catch (error) {
            console.error('Transfer creation error:', error);
            showToast('Failed to create transfer', 'error');
        }
    });

    // Reset modals on hide
    $('#bankFeeModal').on('hidden.bs.modal', function() {
        $('#bankFeeForm')[0].reset();
        $('#relatedPresentation').val('').data('selected-id', '');
        $('#vatAmount').prop('readonly', true);
        $('#vatIncluded').prop('disabled', false);
        $('.is-invalid').removeClass('is-invalid');
    });

    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip();
});

// ===== Global Functions =====
function showToast(message, type = 'success') {
    const toast = `
        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-delay="3000">
            <div class="toast-header bg-${type} text-white">
                <strong class="mr-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                <button type="button" class="ml-2 mb-1 close" data-dismiss="toast">&times;</button>
            </div>
            <div class="toast-body">${message}</div>
        </div>
    `;
    
    const container = $('<div class="toast-container position-fixed top-0 right-0 p-3"></div>')
        .append(toast)
        .appendTo('body');
        
    $('.toast').toast('show').on('hidden.bs.toast', () => container.remove());
}

function deleteBankFee(feeId) {
    if (!confirm('Are you sure you want to delete this bank fee?')) {
        return;
    }
    
    fetch(`/testapp/bank-accounts/fees/${feeId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            showToast('Bank fee deleted successfully', 'success');
            location.reload();
        } else {
            throw new Error(result.message || 'Failed to delete bank fee');
        }
    })
    .catch(error => {
        console.error('Fee deletion error:', error);
        showToast(error.message || 'Failed to delete bank fee', 'error');
    });
}

function deleteTransfer(transferId) {
    if (!confirm('Are you sure you want to delete this transfer? This will make the transferred records available for transfer again.')) {
        return;
    }
    
    fetch(`/testapp/bank-accounts/transfers/${transferId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            showToast('Transfer deleted successfully', 'success');
            location.reload();
        } else {
            throw new Error(result.message || 'Failed to delete transfer');
        }
    })
    .catch(error => {
        console.error('Transfer deletion error:', error);
        showToast(error.message || 'Failed to delete transfer', 'error');
    });
}

function formatBalance(value) {
    return new Intl.NumberFormat('fr-MA', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(value);
}
</script>
{% endblock %}