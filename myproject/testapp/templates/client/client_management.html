{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/client.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row mt-4">
        <div class="col">
            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs nav-fill border-0" id="clientTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active custom-tab" id="clients-tab" data-toggle="tab" href="#clients" role="tab">
                        <i class="fas fa-users me-2"></i>Clients
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link custom-tab" id="entities-tab" data-toggle="tab" href="#entities" role="tab">
                        <i class="fas fa-building me-2"></i>Entities
                    </a>
                </li>
            </ul>

            <!-- Tabs Content -->
            <div class="tab-content mt-4" id="clientTabsContent">
                <!-- Clients Tab -->
                <div class="tab-pane fade show active" id="clients" role="tabpanel">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">
                            <i class="fas fa-users text-primary me-2"></i>Clients Management
                        </h2>
                        <button type="button" class="btn btn-primary btn-lg shadow-sm rounded-pill" 
                                data-toggle="modal" data-target="#clientModal">
                            <i class="fas fa-plus-circle me-2"></i>Add New Client
                        </button>
                    </div>

                    <!-- Clients Table -->
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="clientsTable">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>Client Code</th>
                                            <th>Name</th>
                                            <th>Created At</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="clientsTableBody">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Entities Tab -->
                <div class="tab-pane fade" id="entities" role="tabpanel">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">
                            <i class="fas fa-building text-primary me-2"></i>Entities Management
                        </h2>
                        <button type="button" class="btn btn-primary btn-lg shadow-sm rounded-pill" 
                                data-toggle="modal" data-target="#entityModal">
                            <i class="fas fa-plus-circle me-2"></i>Add New Entity
                        </button>
                    </div>

                    <!-- Entities Table -->
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="entitiesTable">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>Name</th>
                                            <th>ICE Code</th>
                                            <th>Accounting Code</th>
                                            <th>City</th>
                                            <th>Phone</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="entitiesTableBody">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'client/components/client_modal.html' %}
{% include 'client/components/entity_modal.html' %}


<script>

    console.log('Initializing client management module...');

    // Validation configurations
    const ValidationConfig = {
        clientCode: {
            minLength: 5,
            maxLength: 10,
            pattern: /^\d+$/,
            messages: {
                pattern: 'Only digits are allowed',
                minLength: 'Must be at least 5 digits',
                maxLength: 'Cannot exceed 10 digits'
            }
        },
        iceCode: {
            length: 15,
            pattern: /^\d+$/,
            inputPattern: /[0-9]/,  // Add this - for single digit validation
            messages: {
                pattern: 'Only digits are allowed',
                length: 'Must be exactly 15 digits'
            }
        },
        accountingCode: {
            minLength: 5,
            maxLength: 7,
            pattern: /^\d+$/,  // Just check for digits initially
            messages: {
                pattern: 'Only digits are allowed',
                minLength: 'Must be at least 5 digits',
                maxLength: 'Cannot exceed 7 digits'
            }
        },
        name: {
            pattern: /^[a-zA-Z\s]+$/,
            messages: {
                pattern: 'Only letters and spaces allowed'
            }
        }
    };

    class FormValidator {
        constructor(formId, config) {
            this.form = document.getElementById(formId);
            this.config = config;
            console.log(`Initializing validator for form: ${formId}`);
            this.setupValidation();
        }

        setupValidation() {
            const inputs = this.form.querySelectorAll('input[data-validate]');
            inputs.forEach(input => {
                console.log(`Setting up validation for: ${input.id}`);
                this.setupInputValidation(input);
            });
        }

        setupInputValidation(input) {
            const validationType = input.dataset.validate;
            const rules = this.config[validationType];

            // Real-time validation
            input.addEventListener('input', (e) => {
                console.log(`Input event on ${input.id}`);
                this.validateInput(input, rules);
            });

            // Blur validation
            input.addEventListener('blur', (e) => {
                console.log(`Blur event on ${input.id}`);
                this.validateInput(input, rules, true);
            });

            // Prevent invalid characters
            input.addEventListener('keypress', (e) => {
                if (rules.pattern && !String.fromCharCode(e.charCode).match(rules.pattern)) {
                    e.preventDefault();
                }
            });

             // Prevent invalid characters and enforce length
    input.addEventListener('keypress', (e) => {
        // Check max length for ICE code
        if (validationType === 'iceCode' && input.value.length >= 15) {
            e.preventDefault();
            return;
        }

        // Special handling for first character of accounting code
        if (validationType === 'accountingCode') {
            if (input.value.length === 0 && e.key !== '3') {
                e.preventDefault();
                return;
            }
            if (input.value.length >= 7) {
                e.preventDefault();
                return;
            }
        }

        // Use inputPattern for digit validation
        if (!e.key.match(rules.inputPattern)) {
            e.preventDefault();
        }
    });
        }

        validateInput(input, rules, isBlur = false) {
            const value = input.value.trim();
            let isValid = true;
            let message = '';

            // Add validating class during check
            input.classList.add('is-validating');

            // Required field validation
            if (input.required && !value) {
                isValid = false;
                message = 'This field is required';
                this.updateValidationUI(input, false, message);
                return false;
            }

            // Special validation for accounting code
            if (input.dataset.validate === 'accountingCode') {
                if (!value.startsWith('3')) {
                    isValid = false;
                    message = 'Must start with 3';
                }
            }

            // Uniqueness check for client_code and accounting_code on blur
            if (isBlur && (input.id === 'clientCode' || input.id === 'accountingCode' || input.id === 'iceCode')) {
                fetch(`/testapp/api/validate/${input.id}/${value}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.available) {
                            isValid = false;
                            message = `This ${input.id.replace('Code', ' code')} already exists`;
                            this.updateValidationUI(input, false, message, true);
                        }
                    })
                    .catch(error => {
                        console.error(`Error checking ${input.id} uniqueness:`, error);
                    });
            }

            // Pattern validation
            if (rules.pattern && !value.match(rules.pattern)) {
                isValid = false;
                message = rules.messages.pattern;
            }

            // Length validation
            if (rules.length && value.length !== rules.length) {
                isValid = false;
                message = rules.messages.length;
            }

            if (rules.minLength && value.length < rules.minLength) {
                isValid = false;
                message = rules.messages.minLength;
            }

            if (rules.maxLength && value.length > rules.maxLength) {
                isValid = false;
                message = rules.messages.maxLength;
            }

            // Update UI with validation result
            setTimeout(() => {
                input.classList.remove('is-validating');
                this.updateValidationUI(input, isValid, message, isBlur);
                this.checkFormValidity();
            }, 300);

            return isValid;
        }

        checkFormValidity() {
            let isValid = true;
            const formId = this.formId;
            const form = document.querySelector(`#${formId}:not(.d-none), #${formId}:not(.hide)`);
            
            if (!form) {
                console.debug(`Form ${formId} not found or not visible`);
                return true;
            }
            
            const inputs = form.querySelectorAll('input[data-validate]');
            
            inputs.forEach(input => {
                // Check for empty required fields
                if (input.required && !input.value.trim()) {
                    isValid = false;
                    return;
                }
                
                // Check for validation state
                if (input.classList.contains('is-invalid') || 
                    (input.required && !input.classList.contains('is-valid'))) {
                    isValid = false;
                    return;
                }
            });
            
            // Update save button state
            const saveButton = form.querySelector('button[type="submit"]');
            if (saveButton) {
                saveButton.disabled = !isValid;
                console.debug(`Form ${formId} validity: ${isValid}`);
            }
            
            return isValid;
        }

        updateValidationUI(input, isValid, message, isBlur) {
            const feedback = input.nextElementSibling;
            
            if (isValid) {
                input.classList.remove('is-invalid');
                input.classList.add('is-valid');
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.classList.remove('show');
                }
            } else if (isBlur || input.value.length > 0) {
                input.classList.remove('is-valid');
                input.classList.add('is-invalid');
                if (feedback) {
                    feedback.textContent = message;
                    feedback.classList.add('show');
                }
            }
        }

        validateForm() {
            let isValid = true;
            const inputs = this.form.querySelectorAll('input[data-validate]');
            
            inputs.forEach(input => {
                const validationType = input.dataset.validate;
                const rules = this.config[validationType];
                if (!this.validateInput(input, rules, true)) {
                    isValid = false;
                }
            });

            return isValid;
        }
    }

    // Client Management class
    class ClientManagement {
        constructor() {
            console.log('Initializing ClientManagement');
            this.initializeValidators();
            this.bindEvents();
            this.loadClients();
            this.loadEntities();
        }

        initializeValidators() {
            this.clientValidator = new FormValidator('clientForm', ValidationConfig);
            this.entityValidator = new FormValidator('entityForm', ValidationConfig);
        }
        // Event Binding
        bindEvents() {
            $('#saveClientBtn').on('click', () => this.saveClient());
            $('#saveEntityBtn').on('click', () => this.saveEntity());
            
            // Reset forms on modal close
            $('#clientModal').on('hidden.bs.modal', () => this.resetForm('clientForm'));
            $('#entityModal').on('hidden.bs.modal', () => this.resetForm('entityForm'));
            
            // Tab change handlers
            $('#clientTabs a[data-toggle="tab"]').on('shown.bs.tab', (e) => {
                if (e.target.id === 'clients-tab') {
                    this.loadClients();
                } else {
                    this.loadEntities();
                }
            });
        }

        // Client Operations
        async loadClients() {
            console.log('Loading clients...');
            try {
                const response = await fetch('/testapp/api/clients/');
                const data = await response.json();
                
                const tbody = $('#clientsTableBody');
                tbody.empty();
                
                data.clients.forEach(client => {
                    const formattedDate = this.formatDate(client.created_at);
                    tbody.append(`
                        <tr class="fade-in">
                            <td>${client.client_code}</td>
                            <td>${client.name}</td>
                            <td>${formattedDate}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-2" 
                                        onclick="window.clientManagement.editClient('${client.id}', '${client.name}', '${client.client_code}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger me-2" 
                                        onclick="window.clientManagement.deleteClient('${client.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <a href="/testapp/clients/${client.id}/card/" 
                                   class="btn btn-sm btn-outline-info">
                                    <i class="fas fa-chart-line me-1"></i> Sales Card
                                </a>
                            </td>
                        </tr>
                    `);
                    console.log('Client loaded:', client, formattedDate);
                });
            } catch (error) {
                console.error('Error loading clients:', error);
                this.showToast('Error', 'Failed to load clients');
            }
        }

        async saveClient() {
            console.log('Saving client...');
            if (!this.clientValidator.validateForm()) {
                console.log('Client form validation failed');
                return;
            }

            const formData = {
                name: $('#clientName').val().trim(),
                client_code: $('#clientCode').val().trim()
            };

            const id = $('#clientId').val();
            const method = id ? 'PUT' : 'POST';
            const url = id ? 
                `/testapp/api/clients/${id}/update/` : 
                '/testapp/api/clients/create/';

            try {
                const response = await this.sendRequest(url, method, formData);
                if (response.ok) {
                    const result = await response.json();
                    console.log('Client saved successfully:', result);
                    $('#clientModal').modal('hide');
                    await this.loadClients();
                    this.showToast('Success', 'Client saved successfully');
                }
            } catch (error) {
                console.error('Error saving client:', error);
                this.showToast('Error', error.message);
            }
        }

        editClient(id, name, client_code) {
            console.log('Editing client:', id);
            $('#clientId').val(id);
            $('#clientName').val(name);
            $('#clientCode').val(client_code);
            $('#clientModalTitle .title-text').text('Edit Client');
            $('#clientModal').modal('show');
        }

        async deleteClient(id) {
            if (!confirm('Are you sure you want to delete this client?')) {
                return;
            }

            try {
                const response = await this.sendRequest(
                    `/testapp/api/clients/${id}/delete/`,
                    'DELETE'
                );
                if (response.ok) {
                    await this.loadClients();
                    this.showToast('Success', 'Client deleted successfully');
                }
            } catch (error) {
                console.error('Error deleting client:', error);
                this.showToast('Error', error.message);
            }
        }

        // Entity Operations
        async loadEntities() {
            console.log('Loading entities...');
            try {
                const response = await fetch('/testapp/api/entities/');
                const data = await response.json();
                
                const tbody = $('#entitiesTableBody');
                tbody.empty();
                
                data.entities.forEach(entity => {
                    tbody.append(`
                        <tr class="fade-in">
                            <td>${entity.name}</td>
                            <td>${entity.ice_code}</td>
                            <td>${entity.accounting_code}</td>
                            <td>${entity.city || '-'}</td>
                            <td>${entity.phone_number || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-2" 
                                        onclick="window.clientManagement.editEntity('${entity.id}', ${JSON.stringify(entity)})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="window.clientManagement.deleteEntity('${entity.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                });
            } catch (error) {
                console.error('Error loading entities:', error);
                this.showToast('Error', 'Failed to load entities');
            }
        }

        async saveEntity() {
            console.log('Saving entity...');
            if (!this.entityValidator.validateForm()) {
                console.log('Entity form validation failed');
                return;
            }

            const formData = {
                name: $('#entityName').val().trim(),
                ice_code: $('#iceCode').val().trim(),
                accounting_code: $('#accountingCode').val().trim(),
                city: $('#city').val().trim(),
                phone_number: $('#phoneNumber').val().trim()
            };

            const id = $('#entityId').val();
            const method = id ? 'PUT' : 'POST';
            const url = id ? 
                `/testapp/api/entities/${id}/update/` : 
                '/testapp/api/entities/create/';

            try {
                const response = await this.sendRequest(url, method, formData);
                if (response.ok) {
                    const result = await response.json();
                    console.log('Entity saved successfully:', result);
                    $('#entityModal').modal('hide');
                    await this.loadEntities();
                    this.showToast('Success', 'Entity saved successfully');
                }
            } catch (error) {
                console.error('Error saving entity:', error);
                this.showToast('Error', error.message);
            }
        }

        editEntity(id, entityData) {
            console.log('Editing entity:', id);
            $('#entityId').val(id);
            $('#entityName').val(entityData.name);
            $('#iceCode').val(entityData.ice_code);
            $('#accountingCode').val(entityData.accounting_code);
            $('#city').val(entityData.city || '');
            $('#phoneNumber').val(entityData.phone_number || '');
            $('#entityModalTitle .title-text').text('Edit Entity');
            $('#entityModal').modal('show');
        }

        async deleteEntity(id) {
            if (!confirm('Are you sure you want to delete this entity?')) {
                return;
            }

            try {
                const response = await this.sendRequest(
                    `/testapp/api/entities/${id}/delete/`,
                    'DELETE'
                );
                if (response.ok) {
                    await this.loadEntities();
                    this.showToast('Success', 'Entity deleted successfully');
                }
            } catch (error) {
                console.error('Error deleting entity:', error);
                this.showToast('Error', error.message);
            }
        }

        // Utility Methods
        formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                console.error('Error formatting date:', e);
                return dateString;
            }
        }

        async sendRequest(url, method, data = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            };

            if (data && method !== 'GET') {
                options.body = JSON.stringify(data);
            }

            const response = await fetch(url, options);
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Request failed');
            }
            return response;
        }

        resetForm(formId) {
            console.log(`Resetting form: ${formId}`);
            const form = document.getElementById(formId);
            form.reset();
            
            const inputs = form.querySelectorAll('.form-control');
            inputs.forEach(input => {
                input.classList.remove('is-valid', 'is-invalid', 'is-validating');
                const feedback = input.nextElementSibling;
                if (feedback) {
                    feedback.classList.remove('show');
                }
            });

            // Reset titles
            if (formId === 'clientForm') {
                $('#clientModalTitle .title-text').text('Add New Client');
                $('#clientId').val('');
            } else {
                $('#entityModalTitle .title-text').text('Add New Entity');
                $('#entityId').val('');
            }
        }

        showToast(title, message) {
            // You can replace this with your preferred notification library
            alert(`${title}: ${message}`);
        }
    }

    // Initialize when document is ready
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Initializing client management module');
        window.clientManagement = new ClientManagement();
    });

</script>
{% endblock %}