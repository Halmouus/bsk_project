{% extends 'base.html' %}
{% load presentation_filters %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Presentations</h2>
        <div class="btn-group">
            <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                <i class="fas fa-plus"></i> New Presentation
            </button>
            <div class="dropdown-menu dropdown-menu-right">
                <a class="dropdown-item" href="#" onclick="startPresentation('check')">
                    <i class="fas fa-money-check"></i> Present Checks
                </a>
                <a class="dropdown-item" href="#" onclick="startPresentation('lcn')">
                    <i class="fas fa-file-invoice-dollar"></i> Present LCNs
                </a>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <select class="form-control" id="typeFilter">
                        <option value="">All Types</option>
                        <option value="COLLECTION">Collection</option>
                        <option value="DISCOUNT">Discount</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-control" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="presented">Presented</option>
                        <option value="paid">Paid</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-control" id="bankFilter">
                        <option value="">All Banks</option>
                        {% for account in bank_accounts %}
                        <option value="{{ account.id }}">
                            {{ account.bank }} - {{ account.account_number }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" id="searchPresentation" 
                           placeholder="Search by reference...">
                </div>
            </div>
        </div>
    </div>

    <!-- Presentations Table -->
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Bank Account</th>
                    <th>Bank Reference</th>
                    <th>Total Amount</th>
                    <th>Receipt Count</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for presentation in presentations %}
                <tr>
                    <td>{{ presentation.date|date:"Y-m-d" }}</td>
                    <td>{{ presentation.get_presentation_type_display }}</td>
                    <td>{{ presentation.bank_account.bank }} - {{ presentation.bank_account.account_number }}</td>
                    <td>{{ presentation.bank_reference|default:"-" }}</td>
                    <td class="text-right">{{ presentation.total_amount|floatformat:2 }}</td>
                    <td class="text-center">{{ presentation.receipt_count }}</td>
                    <td>
                        <span class="badge badge-{{ presentation.status|status_badge }}">
                            {{ presentation.get_status_display }}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-info" onclick="viewPresentation('{{ presentation.id }}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="editPresentation('{{ presentation.id }}')"
                                    {% if presentation.status == 'paid' %}disabled{% endif %}>
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deletePresentation('{{ presentation.id }}')"
                                    {% if presentation.status != 'pending' %}disabled{% endif %}>
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="text-center">No presentations found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Create/Edit Presentation Modal -->
<div class="modal fade" id="presentationModal" tabindex="-1">
    <div class="modal-dialog modal-xl"> <!-- Made larger for better receipt selection view -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <span id="modalTitleText">Create Presentation</span>
                </h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="presentationForm">
                    <!-- Step indicator -->
                    <div class="mb-4">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span class="step-indicator active">1. Basic Info</span>
                            <span class="step-indicator">2. Select Receipts</span>
                            <span class="step-indicator">3. Review</span>
                        </div>
                    </div>

                    <!-- Step 1: Basic Info -->
                    <div id="step1" class="step-content">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Presentation Type</label>
                                    <select class="form-control" id="presentationType" required>
                                        <option value="COLLECTION">Collection</option>
                                        <option value="DISCOUNT">Discount</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Bank Account</label>
                                    <select class="form-control" id="bankAccount" required>
                                        {% for account in bank_accounts %}
                                        <option value="{{ account.id }}">
                                            {{ account.bank }} - {{ account.account_number }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" class="form-control" id="presentationDate" 
                                           value="{% now 'Y-m-d' %}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Notes</label>
                                    <textarea class="form-control" id="presentationNotes" rows="1"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Receipt Selection -->
                    <div id="step2" class="step-content d-none">
                        <div class="receipt-selection-container">
                            <!-- Receipts will be loaded here -->
                        </div>
                    </div>

                    <!-- Step 3: Review -->
                    <div id="step3" class="step-content d-none">
                        <div class="review-summary">
                            <!-- Summary will be populated dynamically -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="prevStep" style="display: none">
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button type="button" class="btn btn-primary" id="nextStep">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
                <button type="button" class="btn btn-success" id="savePresentation" style="display: none">
                    <i class="fas fa-save"></i> Create Presentation
                </button>
            </div>
        </div>
    </div>
</div>


<!-- View Presentation Modal -->
<div class="modal fade" id="viewPresentationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Content will be loaded dynamically -->
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function showError(error) {
    console.error(error);
    alert('An error occurred: ' + error);
}
function showSuccess(message) {
    console.log(message);
    alert('Succes!: ' + message);
}
const PresentationManager = {
    currentStep: 1,
    totalSteps: 3,
    receiptType: null,
    selectedReceipts: [],

    init() {
        this.bindEvents();
        this.setupValidation();
    },

    bindEvents() {
        $('#nextStep').on('click', () => this.nextStep());
        $('#prevStep').on('click', () => this.previousStep());
        $('#savePresentation').on('click', () => this.savePresentation());
    },

    setupValidation() {
        // Add validation for required fields
        $('#presentationForm input[required], #presentationForm select[required]')
            .on('input change', () => this.validateCurrentStep());
    },

    startPresentation(type) {
        this.receiptType = type;
        this.currentStep = 1;
        this.selectedReceipts = [];
        
        // Update modal title
        $('#modalTitleText').text(`Create ${type.toUpperCase()} Presentation`);
        
        // Reset form
        $('#presentationForm')[0].reset();
        
        // Show first step
        this.showStep(1);
        
        // Show modal
        $('#presentationModal').modal('show');
    },

    async loadAvailableReceipts() {
        try {
            const response = await $.get('/testapp/presentations/available-receipts/', {
                type: this.receiptType
            });
            
            $('.receipt-selection-container').html(response.html);
            this.initializeReceiptSelection();
        } catch (error) {
            showError('Failed to load available receipts');
        }
    },

    initializeReceiptSelection() {
        // Initialize receipt selection handlers
        $('.receipt-checkbox').on('change', () => this.updateSelectionSummary());
        $('#selectAll').on('change', (e) => {
            $('.receipt-checkbox').prop('checked', e.target.checked);
            this.updateSelectionSummary();
        });
    },

    updateSelectionSummary() {
        const selected = $('.receipt-checkbox:checked');
        const count = selected.length;
        const total = Array.from(selected)
            .reduce((sum, cb) => sum + parseFloat($(cb).data('amount')), 0);

        $('#selectedCount').text(count);
        $('#selectedAmount').text(total.toFixed(2));

        // Enable/disable next button based on selection
        $('#nextStep').prop('disabled', count === 0);
    },

    validateCurrentStep() {
        let isValid = true;
        
        if (this.currentStep === 1) {
            // Check required fields in step 1
            $('#step1 [required]').each(function() {
                if (!$(this).val()) {
                    isValid = false;
                    return false; // break
                }
            });
        } else if (this.currentStep === 2) {
            // Check if at least one receipt is selected
            isValid = $('.receipt-checkbox:checked').length > 0;
        }

        $('#nextStep').prop('disabled', !isValid);
        return isValid;
    },

    updateProgressBar() {
        const progress = ((this.currentStep - 1) / (this.totalSteps - 1)) * 100;
        $('.progress-bar').css('width', `${progress}%`);
        
        // Update step indicators
        $('.step-indicator').removeClass('active');
        $(`.step-indicator:nth-child(${this.currentStep})`).addClass('active');
    },

    showStep(step) {
        $('.step-content').addClass('d-none');
        $(`#step${step}`).removeClass('d-none');
        
        // Update buttons
        $('#prevStep').toggle(step > 1);
        $('#nextStep').toggle(step < this.totalSteps);
        $('#savePresentation').toggle(step === this.totalSteps);
        
        // Load receipts if moving to step 2
        if (step === 2) {
            this.loadAvailableReceipts();
        } else if (step === 3) {
            this.showReviewStep();
        }
        
        this.currentStep = step;
        this.updateProgressBar();
        this.validateCurrentStep();
    },

    showReviewStep() {
        const selected = $('.receipt-checkbox:checked');
        const count = selected.length;
        const total = Array.from(selected)
            .reduce((sum, cb) => sum + parseFloat($(cb).data('amount')), 0);

        const summary = `
            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Presentation Summary</h6>
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Type</dt>
                        <dd class="col-sm-8">${$('#presentationType option:selected').text()}</dd>
                        
                        <dt class="col-sm-4">Bank Account</dt>
                        <dd class="col-sm-8">${$('#bankAccount option:selected').text()}</dd>
                        
                        <dt class="col-sm-4">Date</dt>
                        <dd class="col-sm-8">${$('#presentationDate').val()}</dd>
                        
                        <dt class="col-sm-4">Receipts</dt>
                        <dd class="col-sm-8">${count} ${this.receiptType}(s)</dd>
                        
                        <dt class="col-sm-4">Total Amount</dt>
                        <dd class="col-sm-8">${total.toFixed(2)} MAD</dd>
                    </dl>
                </div>
            </div>
        `;

        $('.review-summary').html(summary);
    },

    nextStep() {
        if (this.validateCurrentStep()) {
            this.showStep(this.currentStep + 1);
        }
    },

    previousStep() {
        if (this.currentStep > 1) {
            this.showStep(this.currentStep - 1);
        }
    },

    async savePresentation() {
        try {
            const data = {
                presentation_type: $('#presentationType').val(),
                date: $('#presentationDate').val(),
                bank_account: $('#bankAccount').val(),
                notes: $('#presentationNotes').val(),
                receipt_type: this.receiptType,
                receipt_ids: $('.receipt-checkbox:checked').map(function() {
                    return $(this).val();
                }).get()
            };
            console.log('Sending data:', data);
            const response = await $.ajax({
                url: '/testapp/presentations/create/',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data)
            });

            if (response.status === 'success') {
                $('#presentationModal').modal('hide');
                showSuccess('Presentation created successfully');
                location.reload();
            } else {
                showError(response.message);
            }
        } catch (error) {
            console.error('Creation error:', error);
            const errorMessage = error.responseJSON?.message || 'Failed to create presentation';
            showError(errorMessage);
        }
    }
};

// Add these functions after PresentationManager

async function viewPresentation(id) {
    try {
        const response = await $.get(`/testapp/presentations/${id}/`);
        $('#viewPresentationModal .modal-content').html(response);
        $('#viewPresentationModal').modal('show');
    } catch (error) {
        showError('Failed to load presentation details');
    }
}

async function editPresentation(id) {
    try {
        const data = {
            bank_reference: $('#bankReference').val(),
            status: $('#presentationStatus').val(),
            notes: $('#presentationNotes').val()  // If you have this field
        };
        
        console.log('Sending edit request:', {
            id: id,
            data: data,
            url: `/testapp/presentations/${id}/edit/`
        });

        const response = await fetch(`/testapp/presentations/${id}/edit/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        });

        const responseData = await response.json();
        console.log('Edit response:', responseData);

        if (!response.ok) {
            throw new Error(responseData.message || 'Failed to edit presentation');
        }

        showSuccess('Presentation updated successfully');
        $('#viewPresentationModal').modal('hide');
        location.reload();

    } catch (error) {
        console.error('Edit error:', error);
        showError(error.message || 'Failed to edit presentation');
    }
}

async function deletePresentation(id) {
    console.log('Delete initiated for presentation:', id);

    try {
        if (!confirm('Are you sure you want to delete this presentation?')) {
            console.log('Delete cancelled by user');
            return;
        }
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        console.log('CSRF token obtained:', csrfToken ? 'Yes' : 'No');

        const response = await fetch(`/testapp/presentations/${id}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        });

        console.log('Delete response status:', response.status);
        const data = await response.json();
        console.log('Delete response data:', data);

        if (response.ok) {
            showSuccess('Presentation deleted successfully');
            location.reload();
        } else {
            throw new Error(data.message || 'Failed to delete presentation');
        }
    } catch (error) {
        console.error('Delete error:', error);
        showError(error.message || 'Failed to delete presentation');
    }
}

// Initialize on document ready
$(document).ready(function() {
    PresentationManager.init();
});

// Global function to start presentation creation
function startPresentation(type) {
    PresentationManager.startPresentation(type);
}

// Handle receipt status updates
$(document).on('click', '.update-receipt-status', function() {
    const $button = $(this);
    const receiptId = $button.data('receipt-id');
    
    if (!confirm('This action cannot be undone. Continue?')) {
        return;
    }

    console.log('Updating receipt status:', receiptId);
    
    $.ajax({
        url: `/testapp/presentations/${presentationId}/edit/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        contentType: 'application/json',
        data: JSON.stringify({
            receipt_id: receiptId,
            receipt_status: 'paid'
        }),
        success: function(response) {
            console.log('Status updated:', response);
            $button.prop('disabled', true).text('Paid');
        },
        error: function(xhr) {
            console.error('Update failed:', xhr.responseText);
            showToast('Failed to update status', 'error');
        }
    });
});
</script>
{% endblock %}