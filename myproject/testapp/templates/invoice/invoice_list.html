{% extends 'base.html' %}
{% load humanize %}

{% block title %}Invoice List{% endblock %}

{% block content %}
<script>
    console.log("Script block loaded");
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM loaded");
    
        // Initialize Select2
        try {
            $('#supplier-filter').select2({
                placeholder: 'Select supplier',
                allowClear: true,
                ajax: {
                    url: "{% url 'supplier-autocomplete' %}",
                    dataType: 'json',
                    delay: 250,
                    processResults: function(data) {
                        return {
                            results: data.map(item => ({
                                id: item.value,
                                text: item.label
                            }))
                        };
                    }
                }
            });
            console.log("Select2 initialized");
        } catch (e) {
            console.error("Error initializing Select2:", e);
        }
    
        // Filter functionality
        const applyButton = document.getElementById('apply-filters');
        if (applyButton) {
            applyButton.addEventListener('click', function(e) {
                e.preventDefault();
                // Debug: Log all form elements
                const form = document.getElementById('filter-form');
                console.log("All form elements:", form.elements);
                console.log("Apply button clicked");

                // Get all form values including checkboxes and select2
                const filters = {};
                
                // Get standard form inputs
                const formData = new FormData(document.getElementById('filter-form'));
                
                // Debug log
                console.log("Form data before processing:", Object.fromEntries(formData));

                // Process each form element
                $('#filter-form').find('input, select').each(function() {
                    const input = $(this);
                    const name = input.attr('name');
                    
                    if (!name) return; // Skip if no name attribute

                    if (input.is(':checkbox')) {
                        // Only add checked checkboxes
                        if (input.is(':checked')) {
                            filters[name] = input.val();
                        }
                    } else if (input.hasClass('select2-hidden-accessible')) {
                        // Handle Select2 inputs
                        const value = input.val();
                        if (value) {
                            filters[name] = value;
                        }
                    } else {
                        // Handle regular inputs
                        const value = input.val();
                        if (value) {
                            filters[name] = value;
                        }
                    }
                });

                // Debug logs
                console.log("Final filters object:", filters);
                
                // Apply filters
                const searchParams = new URLSearchParams(filters);
                window.location.search = searchParams.toString();
            });
        } else {
            console.error("Apply button not found");
        }
            // Update URL without refreshing page
            
        // Reset filters
        const resetButton = document.getElementById('reset-filters');
        if (resetButton) {
            resetButton.addEventListener('click', function(e) {
                e.preventDefault();
                console.log("Reset clicked");
                
                // Reset form
                document.getElementById('filter-form').reset();
                
                // Reset Select2 fields
                $('.select2-hidden-accessible').val(null).trigger('change');
                
                // Uncheck all checkboxes
                $('input[type="checkbox"]').prop('checked', false);
                
                // Clear URL parameters and reload
                window.history.pushState({}, '', `${window.location.pathname}?${urlParams.toString()}`);
            });
        }

        // Initialize filters from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        for (let [key, value] of urlParams.entries()) {
            const input = document.querySelector(`[name="${key}"]`);
            if (input) {
                if (input.type === 'checkbox') {
                    input.checked = value === '1';
                } else if ($(input).hasClass('select2-hidden-accessible')) {
                    // For Select2, we need to create the option and set it
                    const select2Input = $(input);
                    select2Input.append(new Option(value, value, true, true)).trigger('change');
                } else {
                    input.value = value;
                }
            }
        }

        // Debug log for URL parameters
        console.log("URL parameters:", Object.fromEntries(urlParams));
    
        // Show/hide filter panel
        $('#toggle-filters').click(function(e) {
            $('.filter-panel').slideToggle();
            $(this).find('i').toggleClass('fa-filter fa-filter-slash');
        });
    });
</script>
    
<h1>Invoice List</h1>
<a href="{% url 'invoice-create' %}" class="btn btn-primary">Add New Invoice</a>

<div class="filter-section mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-outline-secondary" id="toggle-filters">
            <i class="fas fa-filter"></i> Filters
            <span class="badge badge-primary ml-2 active-filters-count" style="display:none">0</span>
        </button>
        <div class="active-filters">
            <span class="results-count"></span>
        </div>
    </div>

    <div class="filter-panel card" {% if not active_filters %}style="display:none"{% endif %}>
        <div class="card-body">
            <form id="filter-form" class="row">
                <!-- Date Range Filter -->
                <div class="col-md-6 col-lg-3 mb-3">
                    <label>Date Range</label>
                    <div class="input-group">
                        <input type="date" class="form-control" name="date_from" id="date-from">
                        <div class="input-group-prepend input-group-append">
                            <span class="input-group-text">to</span>
                        </div>
                        <input type="date" class="form-control" name="date_to" id="date-to">
                    </div>
                </div>

                <!-- Supplier Filter -->
                <div class="col-md-6 col-lg-3 mb-3">
                    <label>Supplier</label>
                    <select class="form-control" name="supplier" id="supplier-filter">
                        <option value="">All Suppliers</option>
                    </select>
                </div>

                <!-- Payment Status Filter -->
                <div class="col-md-6 col-lg-3 mb-3">
                    <label>Payment Status</label>
                    <select class="form-control" name="payment_status" id="payment-status">
                        <option value="">All</option>
                        <option value="not_paid">Not Paid</option>
                        <option value="partially_paid">Partially Paid</option>
                        <option value="paid">Paid</option>
                    </select>
                </div>

                <!-- Amount Range Filter -->
                <div class="col-md-6 col-lg-3 mb-3">
                    <label>Amount Range</label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="amount_min" id="amount-min" placeholder="Min">
                        <div class="input-group-prepend input-group-append">
                            <span class="input-group-text">to</span>
                        </div>
                        <input type="number" class="form-control" name="amount_max" id="amount-max" placeholder="Max">
                    </div>
                </div>

                <!-- Export Status Filter -->
                <div class="col-md-6 col-lg-3 mb-3">
                    <label>Export Status</label>
                    <select class="form-control" name="export_status" id="export-status">
                        <option value="">All</option>
                        <option value="exported">Exported</option>
                        <option value="not_exported">Not Exported</option>
                    </select>
                </div>

                <!-- Document Type Filter -->
                <div class="col-md-6 col-lg-3 mb-3">
                    <label>Document Type</label>
                    <select class="form-control" name="document_type" id="document-type">
                        <option value="">All</option>
                        <option value="invoice">Invoice</option>
                        <option value="credit_note">Credit Note</option>
                    </select>
                </div>
                
                
                <!-- Product Filter -->
                <div class="col-md-6 col-lg-3 mb-3">
                    <label>Product</label>
                    <select class="form-control" name="product" id="product-filter">
                        <option value="">All Products</option>
                    </select>
                </div>
                
                <!-- Payment Status Checks -->
                <div class="col-md-6 col-lg-3 mb-3">
                    <label>Payment Checks</label>
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="pending-checks" name="has_pending_checks" value="1">
                        <label class="custom-control-label" for="pending-checks">Has Pending Checks</label>
                    </div>
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="delivered-unpaid" name="has_delivered_unpaid" value="1">
                        <label class="custom-control-label" for="delivered-unpaid">Has Delivered Unpaid Checks</label>
                    </div>
                </div>
                
                <!-- Energy Filter -->
                <div class="col-md-6 col-lg-3 mb-3">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="is-energy" name="is_energy" value="1">
                        <label class="custom-control-label" for="is-energy">Energy Supplier</label>
                    </div>
                </div>
                
                <!-- Credit Note Status -->
                <div class="col-md-6 col-lg-3 mb-3">
                    <label>Credit Note Status</label>
                    <select class="form-control" name="credit_note_status">
                        <option value="">All</option>
                        <option value="has_credit_notes">Has Credit Notes</option>
                        <option value="no_credit_notes">No Credit Notes</option>
                        <option value="partially_credited">Partially Credited</option>
                    </select>
                </div>
                
                <!-- Due Date Range -->
                <div class="col-md-6 col-lg-3 mb-3">
                    <label>Due Date Range</label>
                    <div class="input-group">
                        <input type="date" class="form-control" name="due_date_from">
                        <div class="input-group-prepend input-group-append">
                            <span class="input-group-text">to</span>
                        </div>
                        <input type="date" class="form-control" name="due_date_to">
                    </div>
                </div>

                <!-- Overdue Filter -->
                <div class="col-md-6 col-lg-3 mb-3">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="is-overdue" name="is_overdue" value="1">
                        <label class="custom-control-label" for="is-overdue">Overdue Invoices</label>
                    </div>
                </div>
                <div class="active-filters-tags">
                    <!-- Active filter tags will be inserted here -->
                </div>
             <div class="d-flex justify-content-between mt-3">
                 <div>
                     <button class="btn btn-primary" id="apply-filters">
                        <i class="fas fa-check"></i> Apply Filters Not Working
                    </button>
                    <button class="btn btn-secondary ml-2" id="reset-filters">
                        <i class="fas fa-times"></i> Reset
                    </button>
                </div>
            </div>
            <div class="col-12">  <!-- Add this wrapper div -->
                <button type="button" id="apply-filters" class="btn btn-primary">
                    Apply Filters Working !
                </button>
            </div>
        </form>
        </div>
    </div>
</div>

<div class="table-responsive" id="invoice-table-wrapper">
    <table class="table mt-4 table-hover">
        <thead>
            <tr>
                <th>Export</th>
                <th>Date</th>
                <th>Reference</th>
                <th>Supplier</th>
                <th>Fiscal Label</th>
                <th>Raw Amount</th>
                <th>Tax Rate (%)</th>
                <th>Tax Amount</th>
                <th>Total Amount (Incl. Tax)</th>
                <th>Status</th>
                <th>Actions</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            {% for invoice in invoices %}
                {% if invoice.type == 'invoice' %}
                    <tr class="{% if invoice.payment_status == 'paid' %}table-success{% elif invoice.exported_at %}table-light{% endif %}">
                        <td>
                            {% if invoice.exported_at %}
                                <span class="text-muted">
                                    Exported {{ invoice.exported_at|date:"d-m-Y" }}
                                    <button type="button" 
                                            class="btn btn-warning btn-sm unexport-btn ml-2" 
                                            data-invoice-id="{{ invoice.id }}">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                </span>
                            {% else %}
                                <input type="checkbox" 
                                    name="invoice_ids" 
                                    value="{{ invoice.id }}" 
                                    class="export-checkbox"
                                    {% if invoice.payment_status == 'paid' %}disabled{% endif %}>
                            {% endif %}
                        </td>
                                <td>{{ invoice.date }}</td>
                                <td>{{ invoice.ref }}</td>
                                <td>{{ invoice.supplier.name }}</td>
                                <td>{{ invoice.fiscal_label }}</td>
                                <td>{{ invoice.raw_amount|floatformat:2|intcomma }}</td>
                                <td>
                                    {% with invoice.products.all|length as product_count %}
                                        {% for product in invoice.products.all %}
                                            {{ product.vat_rate }}{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    {% endwith %}
                                </td>
                                <td>
                                    {% if invoice.total_tax_amount %}
                                        {{ invoice.total_tax_amount|floatformat:2|intcomma }}
                                    {% else %}
                                        <strong>Tax Missing</strong>
                                    {% endif %}
                                </td>                
                                <td class="text-right">
                                    {{ invoice.total_amount|floatformat:2|intcomma }}
                                    {% if invoice.credit_notes.exists %}
                                        <br>
                                        <small class="text-muted">
                                            Net: {{ invoice.net_amount|floatformat:2|intcomma }}
                                        </small>
                                        <button class="btn btn-link btn-sm p-0 ml-1 toggle-credit-notes" 
                                                data-invoice="{{ invoice.id }}">
                                            <i class="fas fa-receipt"></i>
                                        </button>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if invoice.payment_status == 'paid' %}
                                        <span class="badge badge-success">
                                            <i class="fas fa-lock"></i> Paid
                                        </span>
                                    {% else %}
                                        {% if invoice.credit_notes.exists %}
                                            <span class="badge badge-info">
                                                Partially Credited
                                                <small>({{ invoice.credit_notes.count }} note{{ invoice.credit_notes.count|pluralize }})</small>
                                            </span>
                                        {% endif %}
                                        <span class="badge {% if invoice.payment_status == 'partially_paid' %}badge-warning{% else %}badge-danger{% endif %}">
                                            {% if invoice.payment_status == 'partially_paid' %}
                                                Partially Paid 
                                                <small>({{ invoice.payments_summary.percentage_paid|floatformat:1 }}%)</small>
                                            {% else %}
                                                Not Paid
                                            {% endif %}
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if not invoice.payment_status == 'paid' %}
                                        <a href="{% url 'invoice-update' invoice.pk %}" 
                                        class="btn btn-warning {% if invoice.exported_at %}disabled{% endif %}">
                                            <i class="fas fa-edit"></i> Edit
                                        </a>
                                        <a href="{% url 'invoice-delete' invoice.pk %}" 
                                        class="btn btn-danger {% if invoice.exported_at %}disabled{% endif %}">
                                            Delete
                                        </a>
                                        <button class="btn btn-info btn-sm" 
                                                data-toggle="modal" 
                                                data-target="#creditNoteModal" 
                                                data-invoice-id="{{ invoice.id }}"
                                                {% if not invoice.can_be_credited %}disabled{% endif %}>
                                            <i class="fas fa-reply"></i> Credit Note
                                        </button>
                                    {% else %}
                                        <button class="btn btn-secondary" disabled>
                                            <i class="fas fa-lock"></i> Paid
                                        </button>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-info" data-toggle="modal" data-target="#invoiceDetailsModal" data-invoice="{{ invoice.pk }}">Details</button>
                                    <button class="btn btn-info btn-sm"                             
                                            data-toggle="modal" 
                                            data-target="#paymentDetailsModal"
                                            data-invoice="{{ invoice.pk }}">
                                        Payment Details
                                    </button>
                                    <button class="btn btn-info btn-sm accounting-summary-btn" 
                                            data-invoice-id="{{ invoice.id }}" 
                                            title="Show Accounting Summary">
                                        <i class="fas fa-book"></i>
                                    </button>
                                </td>
                            </tr>
                        </tr>
                    {% if invoice.credit_notes.exists %}
                        <tr class="credit-notes-row d-none bg-light" data-parent="{{ invoice.id }}">
                            <td colspan="12">
                                <div class="ml-4">
                                    <h6 class="mb-3">
                                        <i class="fas fa-receipt"></i> 
                                        Credit Notes for Invoice {{ invoice.ref }}
                                    </h6>
                                    <table class="table table-sm">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>Date</th>
                                                <th>Reference</th>
                                                <th>Products</th>
                                                <th class="text-right">Amount</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for credit_note in invoice.credit_notes.all %}
                                                <tr>
                                                    <td>{{ credit_note.date|date:"Y-m-d" }}</td>
                                                    <td>{{ credit_note.ref }}</td>
                                                    <td>
                                                        {% for product in credit_note.products.all %}
                                                            {{ product.product.name }} ({{ product.quantity }})
                                                            {% if not forloop.last %}, {% endif %}
                                                        {% endfor %}
                                                    </td>
                                                    <td class="text-right text-danger">
                                                        -{{ credit_note.total_amount|floatformat:2|intcomma }}
                                                    </td>
                                                    <td>
                                                        <span class="badge badge-info">
                                                            <i class="fas fa-receipt"></i> Credit Note
                                                        </span>
                                                        {% if credit_note.exported_at %}
                                                            <span class="badge badge-secondary">
                                                                <i class="fas fa-file-export"></i> Exported
                                                            </span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-info"
                                                                data-toggle="modal" 
                                                                data-target="#invoiceDetailsModal" 
                                                                data-invoice="{{ credit_note.id }}">
                                                            <i class="fas fa-info-circle"></i> Details
                                                        </button>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                            <tr class="font-weight-bold">
                                                <td colspan="3" class="text-right">Net Balance:</td>
                                                <td class="text-right">{{ invoice.net_amount|floatformat:2|intcomma }}</td>
                                                <td colspan="2"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                    {% endif %}

                {% endif %}

            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Export Button -->
<div class="d-flex justify-content-end mt-3">
    <button type="button" 
            id="export-selected" 
            class="btn btn-primary" 
            disabled>
        Export Selected
    </button>
</div>

<!-- Modal Template for Invoice Details -->
<div class="modal fade" id="invoiceDetailsModal" tabindex="-1" role="dialog" aria-labelledby="invoiceDetailsModalLabel">
    <div class="modal-dialog modal-lg" role="document"> <!-- Added modal-lg for larger modal -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="invoiceDetailsModalLabel">Invoice Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body modal-scrollable-content">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Unit Price</th>
                            <th>Quantity</th>
                            <th>VAT Rate</th>
                            <th>Reduction Rate</th>
                            <th>Raw Price</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-details-table">
                        <!-- Filled by JavaScript -->
                    </tbody>
                </table>
                <div id="vat-summary"></div>
                <div id="total-amount-summary"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Details Modal -->
<div class="modal fade" id="paymentDetailsModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Payment Details</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Amount Due</h6>
                                <h4 id="amount-due" class="card-title"></h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Amount Paid</h6>
                                <h4 id="amount-paid" class="card-title"></h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Amount to Issue</h6>
                                <h4 id="amount-to-issue" class="card-title"></h4>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="progress mb-4" style="height: 25px;">
                    <div id="payment-progress" 
                         class="progress-bar" 
                         role="progressbar" 
                         style="width: 0%"></div>
                </div>

                <!-- Detailed Breakdown -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <p class="mb-1">Pending Payments:</p>
                        <h5 id="pending-amount"></h5>
                    </div>
                    <div class="col-md-4">
                        <p class="mb-1">Delivered Payments:</p>
                        <h5 id="delivered-amount"></h5>
                    </div>
                    <div class="col-md-4">
                        <p class="mb-1">Remaining to Pay:</p>
                        <h5 id="remaining-amount"></h5>
                    </div>
                </div>

                <!-- Checks Table -->
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Reference</th>
                                <th>Amount</th>
                                <th>Created</th>
                                <th>Delivered</th>
                                <th>Paid</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="payment-checks-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Credit Note Modal -->
<div class="modal fade" id="creditNoteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Credit Note</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Credit Note Info -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="credit-note-ref">Credit Note Reference *</label>
                        <input type="text" id="credit-note-ref" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label for="credit-note-date">Date *</label>
                        <input type="date" id="credit-note-date" class="form-control" required>
                    </div>
                </div>

                <!-- Original Invoice Info -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Original Invoice</h6>
                                <div id="original-invoice-details"></div>
                            </div>
                            <div class="col-md-6">
                                <h6>Net Balance After Credit</h6>
                                <div id="net-balance-details"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Selection -->
                <form id="credit-note-form">
                    <input type="hidden" id="original-invoice-id">
                    <table class="table" id="products-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Original Qty</th>
                                <th>Already Credited</th>
                                <th>Available</th>
                                <th>Credit Qty</th>
                                <th>Unit Price</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                            <tr>
                                <th colspan="6" class="text-right">Total Credit Amount:</th>
                                <th class="text-right" id="total-credit-amount">0.00</th>
                            </tr>
                        </tfoot>
                    </table>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-credit-note">Create Credit Note</button>
            </div>
        </div>
    </div>
</div>

<!-- Accounting Summary Modal -->
<div class="modal fade" id="accountingSummaryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-book"></i> Accounting Summary
                </h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="accordion" id="accountingEntries">
                    <!-- Original Invoice Section -->
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Original Invoice Entries</h6>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-striped mb-0">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Account</th>
                                        <th>Label</th>
                                        <th class="text-right">Debit</th>
                                        <th class="text-right">Credit</th>
                                        <th>Reference</th>
                                        <th>Journal</th>
                                    </tr>
                                </thead>
                                <tbody id="originalEntries"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Credit Notes Section (shown only if exists) -->
                    <div id="creditNotesSection" class="card mt-3 d-none">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">Credit Note Entries</h6>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-striped mb-0">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Account</th>
                                        <th>Label</th>
                                        <th class="text-right">Debit</th>
                                        <th class="text-right">Credit</th>
                                        <th>Reference</th>
                                        <th>Journal</th>
                                    </tr>
                                </thead>
                                <tbody id="creditNoteEntries"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Net Effect Section -->
                    <div class="card mt-3">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">Net Effect</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <h6>Original Amount</h6>
                                    <p id="originalTotal" class="h4"></p>
                                </div>
                                <div class="col-md-4">
                                    <h6>Credit Notes</h6>
                                    <p id="creditTotal" class="h4 text-danger"></p>
                                </div>
                                <div class="col-md-4">
                                    <h6>Net Amount</h6>
                                    <p id="netTotal" class="h4 font-weight-bold"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- JavaScript time!!! -->
<script>

    // 1. Utility Functions - These are used throughout the code
    const Utils = {
        formatMoney: function(amount) {
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'MAD',
                minimumFractionDigits: 2
            }).format(amount);
        },
        
        getProgressBarClass: function(percentage) {
            if (percentage >= 100) return 'bg-success';
            if (percentage > 50) return 'bg-warning';
            return 'bg-danger';
        },
        
        getStatusBadgeClass: function(status) {
            return {
                'pending': 'secondary',
                'delivered': 'warning',
                'paid': 'success',
                'cancelled': 'danger'
            }[status] || 'secondary';
        },
        
        formatStatus: function(status) {
            return status.charAt(0).toUpperCase() + status.slice(1);
        }
    };

    // 2. Modal Handlers - All modal-related functions
    const ModalHandlers = {
        // Invoice Details Modal
        loadInvoiceDetails: function(invoiceId) {
            $.ajax({
                url: "{% url 'invoice-details' %}",
                data: { 'invoice_id': invoiceId },
                success: function(data) {
                    $('#invoice-details-table').empty();
                    data.products.forEach(product => {
                        $('#invoice-details-table').append(`
                            <tr>
                                <td>${product.name}</td>
                                <td>${product.unit_price}</td>
                                <td>${product.quantity}</td>
                                <td>${product.vat_rate}</td>
                                <td>${product.reduction_rate}</td>
                                <td>${product.raw_price}</td>
                            </tr>
                        `);
                    });
                    
                    $('#vat-summary').empty();
                    data.vat_subtotals.forEach(vatSubtotal => {
                        $('#vat-summary').append(
                            `<p><strong>Subtotal for VAT ${vatSubtotal.vat_rate}:</strong> ${vatSubtotal.subtotal}</p>`
                        );
                    });
                    
                    $('#total-amount-summary').html(`
                        <strong>Total Raw Amount:</strong> ${data.total_raw_amount}<br>
                        <strong>Total VAT Amount:</strong> ${data.total_vat}<br>
                        <strong>Total Amount (Including Tax):</strong> ${data.total_amount}
                    `);
                }
            });
        },

        // Payment Details Modal
        loadPaymentDetails: function(invoiceId) {
            $.get(`/testapp/invoices/${invoiceId}/payment-details/`, function(data) {
                const details = data.payment_details;
                $('#amount-due').text(Utils.formatMoney(details.total_amount));
                $('#amount-paid').text(Utils.formatMoney(details.paid_amount));
                $('#amount-to-issue').text(Utils.formatMoney(details.amount_to_issue));

                const progressBar = $('#payment-progress');
                progressBar
                    .css('width', `${details.payment_percentage}%`)
                    .text(`${details.payment_percentage.toFixed(1)}%`)
                    .removeClass('bg-success bg-warning bg-danger')
                    .addClass(Utils.getProgressBarClass(details.payment_percentage));

                $('#pending-amount').text(Utils.formatMoney(details.pending_amount));
                $('#delivered-amount').text(Utils.formatMoney(details.delivered_amount));
                $('#remaining-amount').text(Utils.formatMoney(details.remaining_to_pay));

                ModalHandlers.updateChecksTable(data.checks);
            });
        },

        updateChecksTable: function(checks) {
            const tbody = $('#payment-checks-tbody');
            tbody.empty();

            checks.forEach(check => {
                tbody.append(`
                    <tr>
                        <td>${check.reference}</td>
                        <td>${Utils.formatMoney(check.amount)}</td>
                        <td>${check.created_at}</td>
                        <td>${check.delivered_at || '-'}</td>
                        <td>${check.paid_at || '-'}</td>
                        <td>
                            <span class="badge badge-${Utils.getStatusBadgeClass(check.status)}">
                                ${Utils.formatStatus(check.status)}
                            </span>
                        </td>
                    </tr>
                `);
            });
        },

        showAccountingSummary: function(invoiceId) {
            $.ajax({
                url: `/testapp/invoices/${invoiceId}/accounting-summary/`,
                method: 'GET',
                success: function(data) {
                    // Populate the modal
                    $('#originalEntries').empty();
                    data.original_entries.forEach(entry => {
                        $('#originalEntries').append(ModalHandlers.createAccountingRow(entry));
                    });

                    if (data.credit_note_entries.length > 0) {
                        $('#creditNotesSection').removeClass('d-none');
                        $('#creditNoteEntries').empty();
                        data.credit_note_entries.forEach(entry => {
                            $('#creditNoteEntries').append(ModalHandlers.createAccountingRow(entry));
                        });
                    } else {
                        $('#creditNotesSection').addClass('d-none');
                    }

                    $('#originalTotal').text(Utils.formatMoney(data.totals.original));
                    $('#creditTotal').text(Utils.formatMoney(data.totals.credit_notes));
                    $('#netTotal').text(Utils.formatMoney(data.totals.net));

                    $('#accountingSummaryModal').modal('show');
                },
                error: function(xhr) {
                    alert('Failed to load accounting summary: ' + xhr.responseText);
                }
            });
        },

        createAccountingRow: function(entry) {
            return `
                <tr>
                    <td>${entry.date}</td>
                    <td>${entry.account_code}</td>
                    <td>${entry.label}</td>
                    <td class="text-right">${entry.debit ? Utils.formatMoney(entry.debit) : ''}</td>
                    <td class="text-right">${entry.credit ? Utils.formatMoney(entry.credit) : ''}</td>
                    <td>${entry.reference}</td>
                    <td>${entry.journal}</td>
                </tr>
            `;
        }

    };

    // 3. Credit Note Handlers
    const CreditNoteHandlers = {
        // Store the initial net amount for calculations
        initialNetAmount: 0,

        initializeQuantityHandlers: function() {
            $('.credit-quantity').on('input', function() {
                const quantity = parseFloat($(this).val()) || 0;
                const available = parseFloat($(this).data('available'));
                
                if (quantity > available) {
                    $(this).val(available);
                    return;
                }
                
                CreditNoteHandlers.updateSubtotalsAndTotal();
            });
        },

        updateNetBalance: function(creditAmount) {
            $('#net-balance-details').html(`
                <p><strong>Original Amount:</strong> ${Utils.formatMoney(this.initialNetAmount)}</p>
                <p><strong>Credit Amount:</strong> ${Utils.formatMoney(creditAmount)}</p>
                <p class="font-weight-bold">Net Balance: ${Utils.formatMoney(this.initialNetAmount - creditAmount)}</p>
            `);
        },

        updateSubtotalsAndTotal: function() {
            let total = 0;
            $('.credit-quantity').each(function() {
                const quantity = parseFloat($(this).val()) || 0;
                const unitPrice = parseFloat($(this).data('unit-price'));
                const subtotal = quantity * unitPrice;
                
                $(this).closest('tr').find('.subtotal').text(Utils.formatMoney(subtotal));
                total += subtotal;
            });

            $('#total-credit-amount').text(Utils.formatMoney(total));
            this.updateNetBalance(total);
        },

        saveCreditNote: function() {
            if (!$('#credit-note-ref').val()) {
                alert('Please enter a credit note reference');
                return;
            }

            const products = [];
            $('.credit-quantity').each(function() {
                const quantity = parseFloat($(this).val()) || 0;
                if (quantity > 0) {
                    products.push({
                        product_id: $(this).data('product-id'),
                        quantity: quantity
                    });
                }
            });
            
            if (products.length === 0) {
                alert('Please select at least one product to credit');
                return;
            }

            $.ajax({
                url: '/testapp/invoices/create-credit-note/',
                method: 'POST',
                data: JSON.stringify({
                    original_invoice_id: $('#original-invoice-id').val(),
                    ref: $('#credit-note-ref').val(),
                    date: $('#credit-note-date').val(),
                    products: products
                }),
                contentType: 'application/json',
                success: function(response) {
                    location.reload();
                },
                error: function(xhr) {
                    alert('Error creating credit note: ' + xhr.responseText);
                }
            });
        }
    };

    // 4. Filter Handlers
    const FilterHandlers = {
        updateActiveFilters: function() {
            const activeFilters = [];
            const filterLabels = {
                date_from: 'From',
                date_to: 'To',
                supplier: 'Supplier',
                payment_status: 'Payment Status',
                amount_min: 'Min Amount',
                amount_max: 'Max Amount',
                export_status: 'Export Status',
                document_type: 'Document Type'
            };

            // Build URL parameters
            const urlParams = new URLSearchParams();
            
            $('#filter-form').serializeArray().forEach(function(item) {
                if (item.value) {
                    urlParams.append(item.name, item.value);
                    activeFilters.push({
                        name: filterLabels[item.name],
                        value: item.value,
                        param: item.name
                    });
                }
            });



            // Update filter count badge
            const filterCount = activeFilters.length;
            const countBadge = $('.active-filters-count');
            if (filterCount > 0) {
                countBadge.text(filterCount).show();
            } else {
                countBadge.hide();
            }

            // Update filter tags
            const tagsHtml = activeFilters.map(filter => `
                <span class="badge badge-info mr-2">
                    ${filter.name}: ${filter.value}
                    <button type="button" class="close ml-1" 
                            data-param="${filter.param}" 
                            aria-label="Remove filter">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </span>
            `).join('');

            $('.active-filters-tags').html(tagsHtml);
        },

        applyFilters: function() {
            const filters = {};
            const formData = $('#filter-form').serializeArray();
            console.log("Form data being submitted:", formData); // Debug log

            $('#filter-form').serializeArray().forEach(function(item) {
                if (item.value) {
                    filters[item.name] = item.value;
                }
            });

            console.log("Final filters object:", filters); // Debug log
            window.location.search = new URLSearchParams(filters).toString();
        },

        resetFilters: function() {
            $('#filter-form')[0].reset();
            $('#supplier-filter').val(null).trigger('change');
            window.location.search = '';
        }
    };

    
    document.addEventListener('DOMContentLoaded', function () {

    // Initialize Modal Events

 // Accounting summary button handler
 $(document).on('click', '.accounting-summary-btn', function() {
        const invoiceId = $(this).data('invoice-id');
        if (!invoiceId) {
            alert('Invoice ID is missing.');
            return;
        }
        ModalHandlers.showAccountingSummary(invoiceId);
    });

    // Credit note toggle handler
    $('.toggle-credit-notes').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const invoiceId = $(this).data('invoice');
        const icon = $(this).find('i');
        const creditNotesRow = $(`.credit-notes-row[data-parent="${invoiceId}"]`);
        
        creditNotesRow.toggleClass('d-none');
        icon.toggleClass('fa-receipt fa-times-circle');
    });

    // Make sure toggle works for dynamically loaded content
    $(document).on('click', '.toggle-credit-notes', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const invoiceId = $(this).data('invoice');
        const icon = $(this).find('i');
        const creditNotesRow = $(`.credit-notes-row[data-parent="${invoiceId}"]`);
        
        creditNotesRow.toggleClass('d-none');
        icon.toggleClass('fa-receipt fa-times-circle');
    });



    $('#invoiceDetailsModal').on('show.bs.modal', function(event) {
        const invoiceId = $(event.relatedTarget).data('invoice');
        ModalHandlers.loadInvoiceDetails(invoiceId);
    });

    $('#paymentDetailsModal').on('show.bs.modal', function(event) {
        const invoiceId = $(event.relatedTarget).data('invoice');
        ModalHandlers.loadPaymentDetails(invoiceId);
    });

    // Initialize Credit Note Events
    $('#creditNoteModal').on('show.bs.modal', function(event) {
        const invoiceId = $(event.relatedTarget).data('invoice-id');
        if (!invoiceId) {
            console.error('No Invoice ID found!');
            return;
        }

        $('#original-invoice-id').val(invoiceId);
        $('#credit-note-date').val(new Date().toISOString().split('T')[0]);

        $.ajax({
            url: `/testapp/invoices/${invoiceId}/credit-note-details/`,
            method: 'GET',
            success: function(data) {
                // Store initial net amount
                CreditNoteHandlers.initialNetAmount = data.invoice.total_amount - data.invoice.credited_amount;
                
                // Update UI
                $('#original-invoice-details').html(`
                    <p><strong>Reference:</strong> ${data.invoice.ref}</p>
                    <p><strong>Date:</strong> ${data.invoice.date}</p>
                    <p data-amount="${data.invoice.total_amount}">
                        <strong>Total Amount:</strong> ${Utils.formatMoney(data.invoice.total_amount)}
                    </p>
                    <p><strong>Already Credited:</strong> ${Utils.formatMoney(data.invoice.credited_amount)}</p>
                `);

                CreditNoteHandlers.updateNetBalance(0);

                // Populate products table
                const tbody = $('#products-table tbody').empty();
                data.products.forEach(product => {
                    tbody.append(`
                        <tr>
                            <td>${product.name}</td>
                            <td class="text-right">${product.original_quantity}</td>
                            <td class="text-right">${product.credited_quantity}</td>
                            <td class="text-right">${product.available_quantity}</td>
                            <td>
                                <input type="number" class="form-control form-control-sm credit-quantity"
                                    data-product-id="${product.id}"
                                    data-unit-price="${product.unit_price}"
                                    data-available="${product.available_quantity}"
                                    min="0" max="${product.available_quantity}" value="0">
                            </td>
                            <td class="text-right">${Utils.formatMoney(product.unit_price)}</td>
                            <td class="text-right subtotal">0.00</td>
                        </tr>
                    `);
                });

                CreditNoteHandlers.initializeQuantityHandlers();
            }
        });
    });

    $('#save-credit-note').on('click', function() {
        console.log("Save button clicked"); // Debug log
        CreditNoteHandlers.saveCreditNote();
    });

    // Export functionality
    const checkboxes = document.querySelectorAll('.export-checkbox');
    const exportButton = document.getElementById('export-selected');

    checkboxes.forEach(function(checkbox) {
        checkbox.addEventListener('click', function() {
            const checkedBoxes = document.querySelectorAll('.export-checkbox:checked');
            exportButton.disabled = checkedBoxes.length === 0;
            console.log('Checked boxes:', checkedBoxes.length);
        });
    });

    exportButton.addEventListener('click', function() {
        const selectedIds = [...checkboxes]
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        if (selectedIds.length === 0) return;

        fetch('{% url "export-invoices" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'  // Add CSRF token
            },
            body: JSON.stringify({invoice_ids: selectedIds})
        })
        .then(response => {
            if (response.ok) return response.blob();
            throw new Error('Export failed');
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `accounting_export_${new Date().toISOString().slice(0,19).replace(/[:-]/g, '')}.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            location.reload();
        })
        .catch(error => {
            alert('Failed to export invoices: ' + error.message);
        });
    });

    // Unexport functionality
    const unexportButtons = document.querySelectorAll('.unexport-btn');
    unexportButtons.forEach(button => {
        button.addEventListener('click', function() {
            const invoiceId = this.dataset.invoiceId;
            
            if (!confirm('Are you sure you want to unexport this invoice?')) return;

            fetch(`/testapp/invoices/${invoiceId}/unexport/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'  // Add CSRF token
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Unexport failed');
                location.reload();
            })
            .catch(error => {
                alert('Failed to unexport invoice: ' + error.message);
            });
        });
    });

    // Initialize Filter Events


    $('#supplier-filter').select2({
        placeholder: 'Select supplier',
        allowClear: true,
        ajax: {
            url: '/testapp/suppliers/autocomplete/',
            dataType: 'json',
            delay: 250,
            processResults: function(data) {
                return {
                    results: data.map(item => ({
                        id: item.value,
                        text: item.label
                    }))
                };
            }
        }
    });

    $('#product-filter').select2({
        placeholder: 'Select product',
        allowClear: true,
        ajax: {
            url: "{% url 'product-autocomplete' %}",
            dataType: 'json',
            delay: 250,
            processResults: function(data) {
                return {
                    results: data.map(item => ({
                        id: item.value,
                        text: item.label
                    }))
                };
            }
        }
    });

    // Connect filter handlers to buttons
    $('#apply-filters').on('click', function(e) {
            e.preventDefault();
            console.log("Apply filters clicked");  // Debug log
            
            const filters = {};
            const formData = $('#filter-form').serializeArray();
            console.log("Form data:", formData);  // Debug log
            
            formData.forEach(function(item) {
                if (item.value) {
                    filters[item.name] = item.value;
                }
            });
            
            console.log("Filters to apply:", filters);  // Debug log
            window.location.search = new URLSearchParams(filters).toString();
        });

        $('#reset-filters').on('click', function(e) {
            e.preventDefault();
            console.log("Reset filters clicked");  // Debug log
            $('#filter-form')[0].reset();
            $('#supplier-filter').val(null).trigger('change');
            window.location.search = '';
        });
        
    // Remove individual filters
    $(document).on('click', '.active-filters-tags .close', function() {
        const param = $(this).data('param');
        $(`[name="${param}"]`).val('').trigger('change');
        FilterHandlers.applyFilters();
    });

    
    
    // Initialize autocomplete for existing forms
    document.querySelectorAll('.product-form').forEach(addAutocomplete);
    
});
       
</script>

{% endblock %}
