{% extends 'base.html' %}
{% load check_tags %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Checks</h2>
        <div class="btn-group">
            <button class="btn btn-primary" id="toggle-filters">
                <i class="fas fa-filter"></i> Filters
                <span class="badge badge-light ml-2 active-filters-count" style="display:none">0</span>
            </button>
        </div>
    </div>

    <!-- Filter Panel -->
    <div class="filter-panel card mb-4" style="display:none">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <select class="form-control" id="bankFilter">
                        <option value="">All Banks</option>
                        {% for bank in banks %}
                            <option value="{{ bank.bank }}">{{ bank.get_bank_display }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-control" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="delivered">Delivered</option>
                        <option value="paid">Paid</option>
                        <option value="rejected">Rejected</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-control select2" id="beneficiaryFilter">
                        <option value="">All Beneficiaries</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" id="searchCheck" placeholder="Search...">
                </div>
            </div>
        </div>
    </div>

    <!-- Checks Table -->
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Reference</th>
                    <th>Bank</th>
                    <th>Creation Date</th>
                    <th>Beneficiary</th>
                    <th>Invoice Ref</th>
                    <th>Amount Due</th>
                    <th>Amount</th>
                    <th>Due Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="checksTableBody">
                {% include 'checker/partials/checks_table.html' %}
            </tbody>
        </table>
    </div>
</div>

{% include 'checker/partials/check_action_modals.html' %}

<script>
function formatMoney(amount) {
    return new Intl.NumberFormat('fr-FR', {
        style: 'currency',
        currency: 'MAD',
        minimumFractionDigits: 2
    }).format(amount);
}

const CheckFilters = {
    init() {
        console.log("Initializing check filters");
        this.bindFilters();
        this.setupSelect2();
        this.setupActionHandlers();
    },

    bindFilters() {
        console.log("Binding filter events");
        $('#bankFilter, #statusFilter').on('change', () => {
            console.log("Filter changed");
            this.applyFilters();
        });

        let timeout;
        $('#searchCheck').on('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => this.applyFilters(), 300);
        });
    },

    setupSelect2() {
        $('#beneficiaryFilter').select2({
            placeholder: 'Search beneficiary...',
            allowClear: true,
            ajax: {
                url: "{% url 'supplier-autocomplete' %}",
                dataType: 'json',
                delay: 250,
                processResults: function(data) {
                    return {
                        results: data.map(item => ({
                            id: item.value,
                            text: item.label
                        }))
                    };
                }
            }
        }).on('change', () => this.applyFilters());
    },


    async applyFilters() {
        console.log("Applying filters");
        const filters = {
            bank: $('#bankFilter').val(),
            status: $('#statusFilter').val(),
            beneficiary: $('#beneficiaryFilter').val(),
            search: $('#searchCheck').val()
        };

        try {
            const response = await fetch(`/testapp/checks/filter/?${new URLSearchParams(filters)}`);
            if (!response.ok) throw new Error('Filter request failed');
            
            const data = await response.json();
            $('#checksTableBody').html(data.html);
            
            // Update filter count badge
            const activeFilters = Object.values(filters).filter(Boolean).length;
            const badge = $('.active-filters-count');
            activeFilters > 0 ? badge.show().text(activeFilters) : badge.hide();
            
        } catch (error) {
            console.error('Error applying filters:', error);
        }
    },

    setupActionHandlers() {
        // Handle check actions (deliver, pay, etc.)
        $(document).on('click', '.check-action', (e) => {
            const button = $(e.currentTarget);
            this.handleCheckAction(
                button.data('action'),
                button.data('check-id')
            );
        });

        // Handle status badge clicks
        $(document).on('click', '.status-badge', (e) => {
            const checkId = $(e.currentTarget).data('check-id');
            this.showCheckDetails(checkId);
        });

        // Use delegate events for modal buttons
        $(document).on('click', '#confirm-cancel', (e) => {
            e.preventDefault();
            console.log("Cancel confirm clicked");
            this.handleCancel();
        });

        $(document).on('click', '#confirm-reject', (e) => {
            e.preventDefault();
            console.log("Reject confirm clicked");
            this.handleReject();
        });
        
        $(document).on('click', '#confirm-receive', (e) => {
            e.preventDefault();
            this.handleReceiveAction();
        });
        
        $(document).on('click', '#create-replacement', (e) => {
            e.preventDefault();
            this.handleCreateReplacement();
        });
        
        $(document).on('click', '#confirm-receive', (e) => {
            e.preventDefault();
            this.handleReceiveAction();
        });

    },

    async handleCheckAction(action, checkId) {
        switch (action) {
            case 'cancel':
                console.log("Opening cancel modal for check:", checkId);
                $('#cancelModal').modal('show');
                $('#confirm-cancel').data('check-id', checkId);
                break;

            case 'reject':
                console.log("Opening reject modal for check:", checkId);
                $('#rejectModal').modal('show');
                $('#confirm-reject').data('check-id', checkId);
                break;

            case 'receive':
                console.log("Opening receive modal for check:", checkId);
                $('#receiveModal').modal('show');
                $('#confirm-receive').data('check-id', checkId);
                break;
                
            case 'replace':
                console.log("Opening replace modal for check:", checkId);
                await this.handleReplaceAction(checkId);
                break;
            case 'deliver':
            case 'pay':
                await this.updateCheckStatus(checkId, action);
                break;
            case 'print':
                console.log("Printing check:", checkId);
                await this.updateCheckStatus(checkId);
                break;
        }
    },

    async handleCancel() {
        console.log("Cancel button:", $('#confirm-cancel').length);
        console.log("Cancel reason field:", $('#cancellation-reason').length);
        const checkId = $('#confirm-cancel').data('check-id');
        const reason = $('#cancellation-reason').val();
        
        if (!reason) {
            alert('Please provide a cancellation reason');
            return;
        }

        try {
            const response = await fetch(`/testapp/checks/${checkId}/action/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    action: 'cancel',
                    reason: reason
                })
            });

            if (!response.ok) throw new Error('Failed to cancel check');
            
            $('#cancelModal').modal('hide');
            $('#cancellation-reason').val('');
            await this.applyFilters();
            await this.showCheckDetails(checkId);
        } catch (error) {
            console.error('Error cancelling check:', error);
            alert('Failed to cancel check: ' + error.message);
        }
    },

    async handleReject() {
        const checkId = $('#confirm-reject').data('check-id');
        const reason = $('#rejection-reason').val();
        const notes = $('#rejection-notes').val();
        
        if (!reason) {
            alert('Please select a rejection reason');
            return;
        }

        try {
            const response = await fetch(`/testapp/checks/${checkId}/action/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    action: 'reject',
                    rejection_reason: reason,
                    rejection_note: notes
                })
            });

            if (!response.ok) throw new Error('Failed to reject check');
            
            $('#rejectModal').modal('hide');
            $('#rejection-reason').val('');
            $('#rejection-notes').val('');
            await this.applyFilters();
            await this.showCheckDetails(checkId);
        } catch (error) {
            console.error('Error rejecting check:', error);
            alert('Failed to reject check: ' + error.message);
        }
    },

    async handleReceiveAction() {
        const checkId = $('#confirm-receive').data('check-id');
        const notes = $('#receive-notes').val();

        try {
            const response = await fetch(`/testapp/checks/${checkId}/action/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    action: 'receive',
                    notes: notes
                })
            });

            if (!response.ok) throw new Error('Failed to receive check');
            
            $('#receiveModal').modal('hide');
            $('#receive-notes').val('');
            await this.applyFilters();
            await this.showCheckDetails(checkId);
        } catch (error) {
            console.error('Error receiving check:', error);
            alert('Failed to receive check: ' + error.message);
        }
    },

    async handleReplaceAction(checkId) {
        try {
            // Load available checkers
            const checkerResponse = await fetch('/testapp/checkers/available/');
            if (!checkerResponse.ok) throw new Error('Failed to fetch available checkers');
            const checkerData = await checkerResponse.json();
            
            // Populate checker dropdown
            const select = $('#replacement-checker');
            select.empty().append('<option value="">Select a checker...</option>');
            checkerData.checkers.forEach(checker => {
                select.append(`<option value="${checker.id}">${checker.label}</option>`);
            });
            
            // Load check details
            const checkResponse = await fetch(`/testapp/checks/${checkId}/details/`);
            if (!checkResponse.ok) throw new Error('Failed to fetch check details');
            const checkData = await checkResponse.json();
            
            // Populate form
            $('#originalCheckRef').text(checkData.reference);
            $('#replacement-amount').val(checkData.amount);
            
            // Set default due date to today+30
            const defaultDueDate = new Date();
            defaultDueDate.setDate(defaultDueDate.getDate() + 30);
            $('#replacement-due-date').val(defaultDueDate.toISOString().split('T')[0]);
            
            // Show modal and store check ID
            $('#replacementModal').modal('show');
            $('#create-replacement').data('original-check-id', checkId);
            
        } catch (error) {
            console.error('Error preparing replacement:', error);
            alert('Failed to prepare replacement: ' + error.message);
        }
    },

    async handleCreateReplacement() {
        const checkId = $('#create-replacement').data('original-check-id');
        const data = {
            action: 'replace',
            checker_id: $('#replacement-checker').val(),
            amount: $('#replacement-amount').val(),
            payment_due: $('#replacement-due-date').val(),
            observation: $('#replacement-observation').val()
        };
        
        if (!data.checker_id) {
            alert('Please select a checker');
            return;
        }

        try {
            const response = await fetch(`/testapp/checks/${checkId}/action/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error('Failed to create replacement');
            
            $('#replacementModal').modal('hide');
            await this.applyFilters();
            
        } catch (error) {
            console.error('Error creating replacement:', error);
            alert('Failed to create replacement: ' + error.message);
        }
    },
    

    async updateCheckStatus(checkId, action) {
        try {
            const response = await fetch(`/testapp/checks/${checkId}/action/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ action })
            });

            if (!response.ok) throw new Error('Failed to update check status');
            
            this.applyFilters();
        } catch (error) {
            console.error('Error updating check status:', error);
            alert('Failed to update check status: ' + error.message);
        }
    },

    async showCheckDetails(checkId) {
        try {
            const response = await fetch(`/testapp/checks/${checkId}/details/`);
            if (!response.ok) throw new Error('Failed to fetch check details');
            
            const data = await response.json();
            console.log("Check details data:", data);
            this.updateStatusModal(data);
            $('#statusInfoModal').modal('show');
        } catch (error) {
            console.error('Error loading check details:', error);
            alert('Failed to load check details');
        }
    },

    updateStatusModal(data) {
        let content = `<div class="timeline">`;
        
        // Creation
        content += this.createTimelineEntry('Created', data.creation_date, 'plus', 'info');

        // Show if this check replaces another
        if (data.replacement_info.replaces) {
            const replaces = data.replacement_info.replaces;
            content += this.createTimelineEntry(
                'Replaces Check', 
                replaces.rejection_date, 
                'sync', 
                'info',
                `<p>Replaces: ${replaces.reference}</p>
                <p>Original Amount: ${formatMoney(replaces.amount)}</p>
                <p>Rejection Reason: ${replaces.rejection_reason}</p>`
            );
        }
        
        // Delivered
        if (data.delivered_at) {
            content += this.createTimelineEntry('Delivered', data.delivered_at, 'truck', 'primary');
        }
        
        // Paid
        if (data.paid_at) {
            content += this.createTimelineEntry('Paid', data.paid_at, 'check', 'success');
        }
        
        // Rejected
        if (data.rejected_at) {
            content += this.createTimelineEntry('Rejected', data.rejected_at, 'times', 'warning', 
                `<p><strong>Reason:</strong> ${data.rejection_reason}</p>
                 ${data.rejection_note ? `<p><strong>Note:</strong> ${data.rejection_note}</p>` : ''}`
            );
        }

         // Show received status if applicable
         if (data.received_at) {
            content += this.createTimelineEntry(
                'Received Back', 
                data.received_at, 
                'hand-holding', 
                'info',
                data.received_notes ? `<p><strong>Notes:</strong> ${data.received_notes}</p>` : ''
            );
        }

        // Show replacement if exists
        if (data.replacement_info.replaced_by) {
            const replacement = data.replacement_info.replaced_by;
            content += this.createTimelineEntry(
                'Replaced', 
                replacement.date, 
                'sync', 
                'success',
                `<p><strong>New Check:</strong> ${replacement.reference}</p>
                 <p><strong>Amount:</strong> ${formatMoney(replacement.amount)}</p>`
            );
        }
        
        // Cancelled
        if (data.cancelled_at) {
            content += this.createTimelineEntry('Cancelled', data.cancelled_at, 'ban', 'danger',
                `<p><strong>Reason:</strong> ${data.cancellation_reason}</p>`
            );
        }
        
        content += '</div>';
        $('#statusInfoModal .modal-body').html(content);
    },

    createTimelineEntry(title, date, icon, color, extraContent = '') {
        return `
            <div class="timeline-item">
                <div class="timeline-badge bg-${color}">
                    <i class="fas fa-${icon} text-white"></i>
                </div>
                <div class="timeline-content">
                    <h6>${title}</h6>
                    <p>${date}</p>
                    ${extraContent}
                </div>
            </div>
        `;
    }
};

// Initialize filters
$(document).ready(() => {
    CheckFilters.init();
    
    // Toggle filter panel
    $('#toggle-filters').click(function() {
        $('.filter-panel').slideToggle();
        $(this).find('i').toggleClass('fa-filter fa-filter-slash');
    });
});
</script>
{% endblock %}