{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Checkers</h2>
        <button class="btn btn-primary" data-toggle="modal" data-target="#checkerModal">
            <i class="fas fa-plus"></i> New Checker
        </button>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <select class="form-control" id="bankFilter">
                        <option value="">All Banks</option>
                        {% for account in banks %}
                            <option value="{{ account.id }}">
                                {{ account.bank }} [{{ account.account_number }}]
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-control" id="typeFilter">
                        <option value="">All Types</option>
                        <option value="CHQ">Cheque</option>
                        <option value="LCN">LCN</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-control" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="new">New</option>
                        <option value="in_use">In Use</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" id="searchChecker" 
                           placeholder="Search code or index...">
                </div>
            </div>
        </div>
    </div>

    <!-- Checkers Table -->
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Code</th>
                    <th>Bank Account</th>
                    <th>Type</th>
                    <th>Index Range</th>
                    <th>Current Position</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="checkersTableBody">
                {% include 'checker/partials/checkers_table.html' %}
            </tbody>
        </table>
    </div>
</div>

<!-- Checker Modal -->
<div class="modal fade" id="checkerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Checker</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Bank Account</label>
                            <select class="form-control select2" id="bankAccount">
                                <option value="">Select Account</option>
                                {% for account in banks %}
                                    <option value="{{ account.id }}" 
                                            data-bank="{{ account.bank }}">
                                        {{ account.bank }} [{{ account.account_number }}]
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">Required</div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Type</label>
                            <select class="form-control" id="checkerType">
                                <option value="CHQ">Cheque</option>
                                <option value="LCN">LCN</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Number of Pages</label>
                            <select class="form-control" id="numPages">
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Index</label>
                            <input type="text" class="form-control" id="checkerIndex" 
                                   maxlength="3" style="text-transform: uppercase;">
                            <div class="invalid-feedback">1-3 uppercase letters only</div>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="form-group">
                            <label>Starting Page</label>
                            <input type="number" class="form-control" id="startingPage" min="1">
                            <div class="invalid-feedback">Must be greater than 0</div>
                        </div>
                    </div>

                    <div class="preview-section mt-3 d-none">
                        <div class="alert alert-info">
                            Preview: <strong id="checkerPreview"></strong>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveChecker" disabled>Create</button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Payment</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Payment Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Invoice Total</h6>
                                <h4 id="invoice-total" class="card-title mb-0">-</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Already Issued</h6>
                                <h4 id="already-issued" class="card-title mb-0">-</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Amount Paid</h6>
                                <h4 id="amount-paid" class="card-title mb-0">-</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Amount Available</h6>
                                <h4 id="amount-available" class="card-title mb-0">-</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <form id="payment-form">
                    <input type="hidden" id="checker_id" name="checker_id">
                    <div class="form-group">
                        <label>Position</label>
                        <input type="text" class="form-control" id="position" disabled>
                    </div>
                    <div class="form-group">
                        <label>Creation Date</label>
                        <input type="date" class="form-control" name="creation_date" 
                               value="{% now 'Y-m-d' %}">
                    </div>
                    <div class="form-group">
                        <label>Beneficiary</label>
                        <input type="text" class="form-control" id="beneficiary" 
                               placeholder="Search supplier...">
                        <input type="hidden" id="supplier_id">
                    </div>
                    <div class="form-group">
                        <label>Invoice</label>
                        <input type="text" class="form-control" id="invoice" 
                               placeholder="Search invoice..." disabled>
                        <input type="hidden" id="invoice_id" name="invoice_id">
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" class="form-control" name="amount" step="0.01" required>
                        <div class="invalid-feedback">
                            Amount cannot exceed the available amount for payment.
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Payment Due Date</label>
                        <input type="date" class="form-control" name="payment_due">
                    </div>
                    <div class="form-group">
                        <label>Observation</label>
                        <textarea class="form-control" name="observation"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="save-and-clone">Save and Clone</button>
                <button type="button" class="btn btn-primary" id="save-payment">Save</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="checkActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Check Action</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="check-details mb-4">
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Reference</small>
                            <h5 id="checkRef"></h5>
                        </div>
                        <div class="col-6 text-right">
                            <small class="text-muted">Amount</small>
                            <h5 id="checkAmount"></h5>
                        </div>
                    </div>
                </div>
 
                <div class="action-section">
                    <div class="form-group">
                        <label>Action</label>
                        <select class="form-control" id="checkAction">
                            <option value="deliver">Deliver</option>
                            <option value="pay">Mark as Paid</option>
                            <option value="reject">Reject</option>
                            <option value="replace">Replace</option>
                        </select>
                    </div>
 
                    <!-- Rejection Fields -->
                    <div id="rejectionFields" style="display: none;">
                        <div class="form-group">
                            <label>Rejection Reason</label>
                            <select class="form-control" id="rejectionReason">
                                <option value="insufficient_funds">Insufficient Funds</option>
                                <option value="signature_mismatch">Signature Mismatch</option>
                                <option value="amount_error">Amount Error</option>
                                <option value="date_error">Date Error</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Rejection Note</label>
                            <textarea class="form-control" id="rejectionNote" rows="3"></textarea>
                        </div>
                    </div>
 
                    <!-- Replacement Fields -->
                    <div id="replacementFields" style="display: none;">
                        <div class="alert alert-info">
                            This will create a new check with the same details.
                            You can modify the amount and date in the next step.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAction">Confirm</button>
            </div>
        </div>
    </div>
 </div>
 
 <!-- Replacement Modal -->
 <div class="modal fade" id="replacementModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Replacement Check</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>Replacing check:</strong> <span id="oldCheckRef"></span>
                </div>
                
                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" class="form-control" id="newAmount" step="0.01">
                </div>
 
                <div class="form-group">
                    <label>Payment Due Date</label>
                    <input type="date" class="form-control" id="newDueDate">
                </div>
 
                <div class="form-group">
                    <label>Observation</label>
                    <textarea class="form-control" id="newObservation" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="createReplacement">Create</button>
            </div>
        </div>
    </div>
</div>

<style>
    .ui-autocomplete {
        position: absolute;
        z-index: 2000; /* Make sure it appears above the modal */
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 5px 0;
        max-height: 200px;
        overflow-y: auto;
        list-style: none;
    }

    .ui-menu-item {
        padding: 8px 12px;
        cursor: pointer;
    }

    .ui-menu-item:hover {
        background-color: #f8f9fa;
    }

    .ui-helper-hidden-accessible {
        display: none;
    }
</style>


<script>
const Utils = {
    formatMoney: (amount) => {
        return new Intl.NumberFormat('fr-FR', {
            style: 'currency', 
            currency: 'MAD',
            minimumFractionDigits: 2
        }).format(amount);
    },

    showError: (message) => {
        const alert = $('<div>').addClass('alert alert-danger')
            .text(message)
            .prependTo('.modal-body');
        setTimeout(() => alert.remove(), 5000);
    },

    validateAmount: (amount, available) => {
        return amount > 0 && amount <= available;
    }
};

const CheckerFilters = {
    init() {
        console.log("Initializing checker filters");
        this.bankFilter = $('#bankFilter');
        this.typeFilter = $('#typeFilter');
        this.statusFilter = $('#statusFilter');
        this.searchInput = $('#searchChecker');

        this.setupSelect2();
        this.bindEvents();
    },

    setupSelect2() {
        this.bankFilter.select2({
            theme: 'bootstrap',
            width: '100%',
            placeholder: 'All Banks',
            allowClear: true
        });
    },

    bindEvents() {
        // Instant filter on select changes
        this.bankFilter.on('change', () => this.applyFilters());
        this.typeFilter.on('change', () => this.applyFilters());
        this.statusFilter.on('change', () => this.applyFilters());

        // Debounced search
        let timeout;
        this.searchInput.on('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => this.applyFilters(), 300);
        });
    },

    async applyFilters() {
        console.log("Applying filters");
        const filters = {
            bank_account: this.bankFilter.val(),
            type: this.typeFilter.val(),
            status: this.statusFilter.val(),
            search: this.searchInput.val()
        };

        console.log("Filter values:", filters);

        try {
            const response = await fetch(`/testapp/checkers/filter/?${new URLSearchParams(filters)}`);
            if (!response.ok) throw new Error('Filter request failed');

            const data = await response.json();
            $('#checkersTableBody').html(data.html);
        } catch (error) {
            console.error('Filter error:', error);
        }
    }
};

const CheckerModal = {
    init() {
        this.modal = $('#checkerModal');
        this.form = this.modal.find('form');
        this.saveBtn = $('#saveChecker');
        this.bankSelect = $('#bankAccount');
        console.log("Initializing CheckerModal...");
        console.log("BankAccount options available on init:", this.bankSelect.html());
        this.setupSelect2();
        this.setupValidation();
        this.bindEvents();
    },

    setupSelect2() {
        console.log("Setting up Select2...");
        console.log("Bank accounts available:", this.bankSelect.find('option').length);
        console.log("BankAccount dropdown options:", this.bankSelect.find('option'));
        this.bankSelect.select2({
            theme: 'bootstrap',
            dropdownParent: this.modal,
            placeholder: 'Select bank account',
            width: '100%' // Explicit width
        }).on('select2:open', () => {
            console.log("Select2 opened, options:", this.bankSelect.find('option').length);
        });
        console.log("Select2 initialized");
    },

    setupValidation() {
        const indexInput = $('#checkerIndex');
        const startInput = $('#startingPage');

        this.bankSelect.on('change', () => this.validateForm());

        indexInput.on('input', function() {
            this.value = this.value.toUpperCase();
            $(this).toggleClass('is-valid', /^[A-Z]{1,3}$/.test(this.value));
            CheckerModal.validateForm();
            CheckerModal.updatePreview();
        });

        startInput.on('input', function() {
            $(this).toggleClass('is-valid', parseInt(this.value) > 0);
            CheckerModal.validateForm();
            CheckerModal.updatePreview();
        });
    },

    validateForm() {
        const isValid = 
            this.bankSelect.val() && 
            /^[A-Z]{1,3}$/.test($('#checkerIndex').val()) &&
            parseInt($('#startingPage').val()) > 0;
        
        this.saveBtn.prop('disabled', !isValid);
        return isValid;
    },

    updatePreview() {
        const bank = this.bankSelect.find(':selected').data('bank');
        const index = $('#checkerIndex').val();
        const start = $('#startingPage').val();
        const pages = $('#numPages').val();

        if (bank && index && start) {
            const end = parseInt(start) + parseInt(pages) - 1;
            $('#checkerPreview').text(`${bank}-${index}${start} to ${bank}-${index}${end}`);
            $('.preview-alert').removeClass('d-none');
        }
    },

    async saveChecker() {
        if (!this.validateForm()) return;

        try {
            const response = await fetch('/testapp/checkers/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                body: JSON.stringify({
                    bank_account_id: this.bankSelect.val(),
                    type: $('#checkerType').val(),
                    num_pages: $('#numPages').val(),
                    index: $('#checkerIndex').val(),
                    starting_page: $('#startingPage').val()
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Creation failed');
            }

            location.reload();
        } catch (error) {
            Utils.showError(error.message);
        }
    },

    bindEvents() {
        this.saveBtn.off("click").on('click', () => this.saveChecker());
        this.modal.on('hidden.bs.modal', () => {
            if (this.form.length > 0) {
                this.form[0].reset(); // Reset only if the form exists
            }
            this.bankSelect.val(null).trigger('change');
            $('.preview-alert').addClass('d-none');
        });
        this.modal.on('shown.bs.modal', () => {
            console.log("Modal opened. Checking dropdown options:");
            console.log(this.bankSelect.find('option')); // Confirm options are there
        });

        
    }
};



$(document).ready(() => {
    CheckerModal.init();
    CheckerFilters.init();
});
</script>
{% endblock %}