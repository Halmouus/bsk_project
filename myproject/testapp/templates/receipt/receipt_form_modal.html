 <!-- Debug Info -->
 <div style="display:none">
    Receipt type from context: {{ receipt_type }}
    Is transfer? {% if receipt_type == 'transfer' %}Yes{% else %}No{% endif %}
</div>
<!-- Modal Header -->
<div class="modal-header">
    <h5 class="modal-title">
        {% if receipt_type == 'check' %}
        <i class="fas fa-money-check"></i>
        {% elif receipt_type == 'lcn' %}
        <i class="fas fa-file-invoice-dollar"></i>
        {% elif receipt_type == 'cash' %}
        <i class="fas fa-money-bill"></i>
        {% else %}
        <i class="fas fa-exchange-alt"></i>
        {% endif %}
        {{ title }}
    </h5>
    <button type="button" class="close" data-dismiss="modal">&times;</button>
</div>

<!-- Modal Body -->
<div class="modal-body">
    <form id="receiptForm" method="post" action="{% if receipt %}{% url 'receipt-edit' receipt_type receipt.id %}{% else %}{% url 'receipt-create' receipt_type %}{% endif %}">
        {% csrf_token %}
        
        <!-- Common Fields -->
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="client">Client</label>
                    <input type="text" class="form-control" id="client" name="client_display" 
                           placeholder="Search for a client..." required
                           value="{% if receipt %}{{ receipt.client.name }}{% endif %}">
                    <input type="hidden" id="client_id" name="client" 
                           value="{% if receipt %}{{ receipt.client.id }}{% endif %}" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="entity">Entity</label>
                    <input type="text" class="form-control" id="entity" name="entity_display" 
                           placeholder="Search for an entity..." required
                           value="{% if receipt %}{{ receipt.entity.name }}{% endif %}">
                    <input type="hidden" id="entity_id" name="entity" 
                           value="{% if receipt %}{{ receipt.entity.id }}{% endif %}" required>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="operation_date">Operation Date</label>
                    <input type="date" class="form-control" id="operation_date" name="operation_date" 
                           value="{% if receipt %}{{ receipt.operation_date|date:'Y-m-d' }}{% else %}{% now 'Y-m-d' %}{% endif %}" required>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="client_year">Year</label>
                    <select class="form-control" id="client_year" name="client_year" required>
                        {% for year in year_choices %}
                        <option value="{{ year }}" {% if receipt and receipt.client_year == year or year == current_year %}selected{% endif %}>{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="client_month">Month</label>
                    <select class="form-control" id="client_month" name="client_month" required>
                        {% for month in month_choices %}
                        <option value="{{ month.0 }}" {% if receipt and receipt.client_month == month.0 or month.0 == current_month %}selected{% endif %}>{{ month.1 }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="amount">Amount</label>
                    <input type="number" class="form-control" id="amount" name="amount" 
                           value="{% if receipt %}{{ receipt.amount }}{% endif %}"
                           step="0.01" min="0.01" required>
                </div>
            </div>
        </div>

        {% if receipt_type == 'check' %}
        <!-- Check-specific fields -->
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="check_number">Check Number</label>
                    <input type="text" class="form-control" id="check_number" name="check_number" 
                           value="{% if receipt %}{{ receipt.check_number }}{% endif %}" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="due_date">Due Date</label>
                    <input type="date" class="form-control" id="due_date" name="due_date" 
                           value="{% if receipt %}{{ receipt.due_date|date:'Y-m-d' }}{% endif %}" required>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="issuingBank">Issuing Bank</label>
                <input type="text" class="form-control" id="issuingBank" name="issuing_bank_display" placeholder="Select bank..." required 
                       value="{% if receipt %}{{ receipt.get_issuing_bank_display }}{% endif %}">
                <input type="hidden" id="issuingBankCode" name="issuing_bank" 
                       value="{% if receipt %}{{ receipt.issuing_bank }}{% endif %}">
            </div>
        </div>
        <div class="form-group">
            <label>Compensate Unpaid Receipt</label>
            <input type="text" id="compensate-receipt-autocomplete" class="form-control" name="compensates">
            <input type="hidden" id="compensate-receipt-id" name="compensates">
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="branch">Branch</label>
                    <input type="text" class="form-control" id="branch" name="branch" 
                           value="{% if receipt %}{{ receipt.branch }}{% endif %}">
                </div>
            </div>
        </div>
        {% endif %}

        {% if receipt_type == 'lcn' %}
        <!-- LCN-specific fields -->
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="lcn_number">LCN Number</label>
                    <input type="text" class="form-control" id="lcn_number" name="lcn_number" 
                           value="{% if receipt %}{{ receipt.lcn_number }}{% endif %}" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="due_date">Due Date</label>
                    <input type="date" class="form-control" id="due_date" name="due_date" 
                           value="{% if receipt %}{{ receipt.due_date|date:'Y-m-d' }}{% endif %}" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="issuingBank">Issuing Bank</label>
                    <input type="text" class="form-control" id="issuingBank" name="issuing_bank_display" placeholder="Select bank..." required 
                           value="{% if receipt %}{{ receipt.get_issuing_bank_display }}{% endif %}">
                    <input type="hidden" id="issuingBankCode" name="issuing_bank" 
                           value="{% if receipt %}{{ receipt.issuing_bank }}{% endif %}">
                </div>
            </div>
            <div class="form-group col-md-6">
                <label>Compensate Unpaid Receipt</label>
                <input type="text" id="compensate-receipt-autocomplete" class="form-control" name="compensates">
                <input type="hidden" id="compensate-receipt-id" name="compensates">
            </div>
        </div>
        {% endif %}

        {% if receipt_type == 'cash' or receipt_type == 'transfer' %}
        <!-- Cash/Transfer-specific fields -->
        <div class="row">
            <div class="col-md-12">
                <div class="form-group">
                    <label for="credited_account">Credited Account</label>
                    <select class="form-control" id="credited_account" name="credited_account" required>
                        {% for account in bank_accounts %}
                        <option value="{{ account.id }}" {% if receipt and receipt.credited_account.id == account.id %}selected{% endif %}>
                            {{ account.bank }} - {{ account.account_number }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label>Compensate Unpaid Receipt</label>
            <input type="text" id="compensate-receipt-autocomplete" class="form-control" name="compensates">
            <input type="hidden" id="compensate-receipt-id" name="compensates">
        </div>
        </div>
        {% endif %}

        {% if receipt_type == 'transfer' %}
        <!-- Transfer-specific fields -->
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="transfer_reference">Transfer Reference</label>
                    <input type="text" class="form-control" id="transfer_reference" name="transfer_reference" 
                           value="{% if receipt %}{{ receipt.transfer_reference }}{% endif %}" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="transfer_date">Transfer Date</label>
                    <input type="date" class="form-control" id="transfer_date" name="transfer_date" 
                           value="{% if receipt %}{{ receipt.transfer_date|date:'Y-m-d' }}{% else %}{% now 'Y-m-d' %}{% endif %}" required>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label>Compensate Unpaid Receipt</label>
            <input type="text" id="compensate-receipt-autocomplete" class="form-control" name="compensates">
            <input type="hidden" id="compensate-receipt-id" name="compensates">
        </div>
        </div>
        {% endif %}

        <div class="form-group">
            <label for="notes">Notes</label>
            <textarea class="form-control" id="notes" name="notes" rows="2">{% if receipt %}{{ receipt.notes }}{% endif %}</textarea>
        </div>
    </form>
</div>

<!-- Modal Footer -->
<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
    <button type="submit" class="btn btn-primary" form="receiptForm">Save Receipt</button>
</div>

<!-- Initialize autocomplete -->
<script>
console.log('Form loaded for receipt type:', '{{ receipt_type }}');

$(document).ready(function() {
// Initialize client autocomplete
$("#client").autocomplete({
                minLength: 0,
            source: function(request, response) {
                console.log('Client search term:', request.term);
                $.ajax({
                    url: "{% url 'client-autocomplete' %}",
                    dataType: "json",
                    data: { term: request.term },
                    success: function(data) {
                        console.log('Client data received:', data);
                        response($.map(data.results, function(item) {
                            return {
                                label: item.text,
                                value: item.id
                            };
                        }));
                    },
                    error: function(xhr, status, error) {
                        console.error('Client autocomplete error:', error);
                    }
                });
            },
            select: function(event, ui) {
                console.log('Client selected:', ui.item);
                $("#client").val(ui.item.label);
                $("#client_id").val(ui.item.value);
                return false;
            }
        }).on('focus', function() {
            console.log('Client input focused');
        });

        // Initialize entity autocomplete
        $("#entity").autocomplete({
            minLength: 0,
            source: function(request, response) {
                console.log('Entity search term:', request.term);
                $.ajax({
                    url: "{% url 'entity-autocomplete' %}",
                    dataType: "json",
                    data: { term: request.term },
                    success: function(data) {
                        console.log('Entity data received:', data);
                        response($.map(data.results, function(item) {
                            return {
                                label: item.text,
                                value: item.id
                            };
                        }));
                    },
                    error: function(xhr, status, error) {
                        console.error('Entity autocomplete error:', error);
                    }
                });
            },
            select: function(event, ui) {
                console.log('Entity selected:', ui.item);
                $("#entity").val(ui.item.label);
                $("#entity_id").val(ui.item.value);
                return false;
            }
        }).on('focus', function() {
            console.log('Entity input focused');
        });

        // Bank selection using jQuery UI autocomplete
        const banksList = [
            {% for code, name in bank_choices %}
                { label: '{{ name }}', value: '{{ code }}' },
            {% endfor %}
        ];

        $("#issuingBank").autocomplete({
            source: banksList,
            minLength: 0, // Show all options even without typing
            select: function(event, ui) {
                $("#issuingBank").val(ui.item.label);
                $("#issuingBankCode").val(ui.item.value);
                return false;
            }
        }).focus(function() {
            // Show all options when field is focused
            $(this).autocomplete("search", "");
        });

        // Add dropdown indicator and click handler
        $("#issuingBank").after('<span class="bank-dropdown-toggle"><i class="fas fa-chevron-down"></i></span>');
        $(".bank-dropdown-toggle").click(function() {
            $("#issuingBank").focus();
        });

        $("#compensate-receipt-autocomplete").autocomplete({
    source: function(request, response) {
        console.log('Unpaid Receipt search term:', request.term);
        $.ajax({
            url: "{% url 'unpaid-receipt-autocomplete' %}",
            dataType: "json",
            data: { term: request.term },
            success: function(data) {
                console.log('Unpaid Receipt data received:', data);
                response($.map(data.results, function(item) {
                    return {
                        label: item.description,
                        value: item.description,  // Display full description
                        id: item.id
                    };
                }));
            },
            error: function(xhr, status, error) {
                console.error('Unpaid Receipt autocomplete error:', error);
                console.log('XHR response:', xhr.responseText);
            }
        });
    },
    minLength: 0,
    select: function(event, ui) {
        console.log('Unpaid Receipt selected:', ui.item);
        $("#compensate-receipt-id").val(ui.item.id);
        $("#compensate-receipt-autocomplete").val(ui.item.label);
        $("#compensation-details").html(`
            Selected Receipt: ${ui.item.label}
        `);
    },
    change: function(event, ui) {
        console.log('Unpaid Receipt change event triggered');
        if (!ui.item) {
            $("#compensate-receipt-id").val('');
            $("#compensate-receipt-autocomplete").val('');
            $("#compensation-details").empty();
        }
    }
});

// Initialize tooltips
$('[data-toggle="tooltip"]').tooltip();
    
    // Enhanced status badges with tooltips
    function updateStatusBadge($element, status, details) {
        const badge = $('<span>')
            .addClass(`badge badge-${status.toLowerCase()}`)
            .text(status);
            
        if (details) {
            badge.attr('data-toggle', 'tooltip')
                 .attr('data-html', 'true')
                 .attr('title', details);
        }
        
        $element.html(badge);
        badge.tooltip();
    }
    
    // Add bulk action support
    let selectedReceipts = new Set();
    
    // Add checkboxes for bulk actions
    $('.receipt-table').find('tbody tr').each(function() {
        const $tr = $(this);
        const receiptId = $tr.data('receipt-id');
        const $checkbox = $('<input>', {
            type: 'checkbox',
            class: 'receipt-checkbox',
            'data-receipt-id': receiptId
        });
        
        $tr.prepend($('<td>').append($checkbox));
    });
    
    // Bulk action handlers
    $('.receipt-checkbox').on('change', function() {
        const receiptId = $(this).data('receipt-id');
        if (this.checked) {
            selectedReceipts.add(receiptId);
        } else {
            selectedReceipts.delete(receiptId);
        }
        updateBulkActionButtons();
    });
    
    function updateBulkActionButtons() {
        const hasSelected = selectedReceipts.size > 0;
        $('.bulk-action-btn').prop('disabled', !hasSelected);
    }
    
    // Add number formatting
    function formatCurrency(amount) {
        return new Intl.NumberFormat('fr-MA', {
            style: 'currency',
            currency: 'MAD'
        }).format(amount);
    }
    
    // Update all amount displays
    $('.amount-display').each(function() {
        const amount = $(this).data('amount');
        $(this).text(formatCurrency(amount));
    });

});
</script>

<style>
    .bank-dropdown-toggle {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
    }
    
    .ui-autocomplete {
        max-height: 200px;
        overflow-y: auto;
        overflow-x: hidden;
        z-index: 9999;

        /* Scrollbar styles */
        scrollbar-width: thin;
        scrollbar-color: #0b4d71 #f1f1f1;
        -webkit-overflow-scrolling: touch;
        -ms-overflow-style: -ms-autohiding-scrollbar;
        
    }
    
    .ui-autocomplete::-webkit-scrollbar {
        width: 6px;
    }
    
    .ui-autocomplete::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    .ui-autocomplete::-webkit-scrollbar-thumb {
        background: #888;
    }
    
    .ui-autocomplete::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    </style>