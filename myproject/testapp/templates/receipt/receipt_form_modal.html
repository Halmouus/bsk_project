<!-- Debug Info -->
<div style="display:none">
    Receipt type from context: {{ receipt_type }}
    Is transfer? {% if receipt_type == 'transfer' %}Yes{% else %}No{% endif %}
</div>

<!-- Modal Header -->
<div class="modal-header bg-gradient-primary text-white">
    <h5 class="modal-title">
        {% if receipt_type == 'check' %}
            <i class="fas fa-money-check me-2"></i>
        {% elif receipt_type == 'lcn' %}
            <i class="fas fa-file-invoice-dollar me-2"></i>
        {% elif receipt_type == 'cash' %}
            <i class="fas fa-money-bill me-2"></i>
        {% else %}
            <i class="fas fa-exchange-alt me-2"></i>
        {% endif %}
        {{ title }}
    </h5>
    <button type="button" class="btn-close btn-close-white" data-dismiss="modal"></button>
</div>

<div class="modal-body bg-light">
    <form id="receiptForm" method="post" action="{% if receipt %}{% url 'receipt-edit' receipt_type receipt.id %}{% else %}{% url 'receipt-create' receipt_type %}{% endif %}">
        {% csrf_token %}

        <!-- Basic Information Card -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h6 class="mb-0 text-primary">
                    <i class="fas fa-info-circle me-2"></i> Basic Information
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="client" name="client_display" required
                                   placeholder="Search client..." value="{% if receipt %}{{ receipt.client.name }}{% endif %}">
                            <label for="client">
                                <i class="fas fa-user text-primary me-2"></i> Client
                            </label>
                            <input type="hidden" id="client_id" name="client" value="{% if receipt %}{{ receipt.client.id }}{% endif %}">
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="entity" name="entity_display" required
                                   placeholder="Search entity..." value="{% if receipt %}{{ receipt.entity.name }}{% endif %}">
                            <label for="entity">
                                <i class="fas fa-building text-primary me-2"></i> Entity
                            </label>
                            <input type="hidden" id="entity_id" name="entity" value="{% if receipt %}{{ receipt.entity.id }}{% endif %}">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction Details Card -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h6 class="mb-0 text-primary">
                    <i class="fas fa-file-invoice me-2"></i> Transaction Details
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="form-floating">
                            <input type="date" class="form-control" id="operation_date" name="operation_date" required
                                   value="{% if receipt %}{{ receipt.operation_date|date:'Y-m-d' }}{% else %}{% now 'Y-m-d' %}{% endif %}">
                            <label for="operation_date">
                                <i class="fas fa-calendar text-primary me-2"></i> Operation Date
                            </label>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="form-floating">
                            <select class="form-control" id="client_year" name="client_year" required>
                                {% for year in year_choices %}
                                    <option value="{{ year }}" {% if receipt and receipt.client_year == year or year == current_year %}selected{% endif %}>
                                        {{ year }}
                                    </option>
                                {% endfor %}
                            </select>
                            <label for="client_year">
                                <i class="fas fa-calendar-alt text-primary me-2"></i> Year
                            </label>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="form-floating">
                            <select class="form-control" id="client_month" name="client_month" required>
                                {% for month in month_choices %}
                                    <option value="{{ month.0 }}" {% if receipt and receipt.client_month == month.0 or month.0 == current_month %}selected{% endif %}>
                                        {{ month.1 }}
                                    </option>
                                {% endfor %}
                            </select>
                            <label for="client_month">
                                <i class="fas fa-calendar-day text-primary me-2"></i> Month
                            </label>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="number" class="form-control" id="amount" name="amount" required
                                   step="0.01" min="0.01" value="{% if receipt %}{{ receipt.amount }}{% endif %}">
                            <label for="amount">
                                <i class="fas fa-coins text-primary me-2"></i> Amount
                            </label>
                        </div>
                    </div>

                    {% if receipt_type == 'check' or receipt_type == 'lcn' %}
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="issuingBank" name="issuing_bank_display" required
                                       placeholder="Select bank..." value="{% if receipt %}{{ receipt.get_issuing_bank_display }}{% endif %}">
                                <label for="issuingBank">
                                    <i class="fas fa-university text-primary me-2"></i> Issuing Bank
                                </label>
                                <input type="hidden" id="issuingBankCode" name="issuing_bank" value="{% if receipt %}{{ receipt.issuing_bank }}{% endif %}">
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Receipt Specific Details Card -->
        {% if receipt_type == 'check' or receipt_type == 'lcn' %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h6 class="mb-0 text-primary">
                    <i class="fas fa-receipt me-2"></i> {{ receipt_type|upper }} Details
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="form-floating">
                            {% if receipt_type == 'check' %}
                            <input type="text" class="form-control" id="check_number" 
                                   name="check_number" required
                                   value="{% if receipt %}{{ receipt.check_number }}{% endif %}">
                            <label for="check_number">
                                <i class="fas fa-hashtag text-primary me-2"></i> Check Number
                            </label>
                            {% elif receipt_type == 'lcn' %}
                            <input type="text" class="form-control" id="lcn_number" 
                                   name="lcn_number" required
                                   value="{% if receipt %}{{ receipt.lcn_number }}{% endif %}">
                            <label for="lcn_number">
                                <i class="fas fa-hashtag text-primary me-2"></i> LCN Number
                            </label>
                            {% endif %}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="date" class="form-control" id="due_date" name="due_date" required
                                   value="{% if receipt %}{{ receipt.due_date|date:'Y-m-d' }}{% endif %}">
                            <label for="due_date">
                                <i class="fas fa-clock text-primary me-2"></i> Due Date
                            </label>
                        </div>
                    </div>

                    {% if receipt_type == 'check' %}
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="branch" name="branch"
                                   value="{% if receipt %}{{ receipt.branch }}{% endif %}">
                            <label for="branch">
                                <i class="fas fa-code-branch text-primary me-2"></i> Branch
                            </label>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if receipt_type == 'cash' or receipt_type == 'transfer' %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h6 class="mb-0 text-primary">
                    <i class="fas fa-receipt me-2"></i> {{ receipt_type|title }} Details
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12">
                        <div class="form-floating">
                            <select class="form-control" id="credited_account" name="credited_account" required>
                                {% for account in bank_accounts %}
                                    <option value="{{ account.id }}" 
                                        {% if receipt and receipt.credited_account.id == account.id %}selected{% endif %}>
                                        {{ account.bank }} - {{ account.account_number }}
                                    </option>
                                {% endfor %}
                            </select>
                            <label for="credited_account">
                                <i class="fas fa-university text-primary me-2"></i> Credited Account
                            </label>
                        </div>
                    </div>

                    {% if receipt_type == 'transfer' %}
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="transfer_reference" 
                                   name="transfer_reference" required
                                   value="{% if receipt %}{{ receipt.transfer_reference }}{% endif %}">
                            <label for="transfer_reference">
                                <i class="fas fa-hashtag text-primary me-2"></i> Transfer Reference
                            </label>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="date" class="form-control" id="transfer_date" 
                                   name="transfer_date" required
                                   value="{% if receipt %}{{ receipt.transfer_date|date:'Y-m-d' }}{% else %}{% now 'Y-m-d' %}{% endif %}">
                            <label for="transfer_date">
                                <i class="fas fa-calendar-check text-primary me-2"></i> Transfer Date
                            </label>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Compensation Details Card -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h6 class="mb-0 text-primary">
                    <i class="fas fa-sync me-2"></i> Compensation Details
                </h6>
            </div>
            <div class="card-body">
                <div class="form-floating">
                    <input type="text" class="form-control" id="compensate-receipt-autocomplete" name="compensates"
                           placeholder="Search for unpaid receipt...">
                    <label for="compensate-receipt-autocomplete">
                        <i class="fas fa-search text-primary me-2"></i> Compensate Unpaid Receipt
                    </label>
                    <input type="hidden" id="compensate-receipt-id" name="compensates">
                </div>
                <div id="compensation-details" class="mt-2 small text-muted"></div>
            </div>
        </div>

        <!-- Notes Card -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h6 class="mb-0 text-primary">
                    <i class="fas fa-sticky-note me-2"></i> Additional Notes
                </h6>
            </div>
            <div class="card-body">
                <div class="form-floating">
                    <textarea class="form-control" id="notes" name="notes" rows="3" 
                              style="height: 100px">{% if receipt %}{{ receipt.notes }}{% endif %}</textarea>
                    <label for="notes">Notes</label>
                </div>
            </div>
        </div>
    </form>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-light" data-dismiss="modal">
        <i class="fas fa-times me-2"></i> Cancel
    </button>
    <button type="submit" class="btn btn-primary" form="receiptForm">
        <i class="fas fa-save me-2"></i> Save Receipt
    </button>
</div>

<style>
.modal-header.bg-gradient-primary {
    background: linear-gradient(45deg, #4e73df, #224abe);
}

.form-floating > label {
    padding-left: 1.75rem;
}

.form-floating > .form-control {
    padding-left: 2.5rem;
}

.form-floating > .form-control:focus {
    border-color: #4e73df;
    box-shadow: 0 0 0 0.2rem rgba(78,115,223,.25);
}

.card {
    border: none;
    transition: transform 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
}

.card-header {
    border-bottom: 2px solid rgba(0,0,0,.05);
    background-color: #fff;
}

.form-control {
    border-radius: 0.5rem;
}

.form-floating .invalid-feedback {
    margin-left: 2.5rem;
}

.btn-close-white {
    filter: brightness(0) invert(1);
}

.text-primary {
    color: #4e73df !important;
}
.bank-dropdown-toggle {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
    }
    
    .ui-autocomplete {
        max-height: 200px;
        overflow-y: auto;
        overflow-x: hidden;
        z-index: 9999;

        /* Scrollbar styles */
        scrollbar-width: thin;
        scrollbar-color: #0b4d71 #f1f1f1;
        -webkit-overflow-scrolling: touch;
        -ms-overflow-style: -ms-autohiding-scrollbar;
        
    }
    
    .ui-autocomplete::-webkit-scrollbar {
        width: 6px;
    }
    
    .ui-autocomplete::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    .ui-autocomplete::-webkit-scrollbar-thumb {
        background: #888;
    }
    
    .ui-autocomplete::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
.ui-autocomplete {
    max-height: 200px;
    overflow-y: auto;
    z-index: 9999;
    border-radius: 0.5rem;
    border: 1px solid rgba(0,0,0,.1);
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
}

.ui-autocomplete .ui-menu-item {
    padding: 0.5rem 1rem;
    border-bottom: 1px solid rgba(0,0,0,.05);
}

.ui-autocomplete .ui-menu-item:last-child {
    border-bottom: none;
}

.ui-autocomplete .ui-menu-item:hover {
    background-color: #f8f9fa;
    cursor: pointer;
}
.form-control.is-invalid {
    border-color: #dc3545;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.form-control.is-valid {
    border-color: #198754;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.invalid-feedback {
    display: block;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
}
</style>

<script>
console.log('Form loaded for receipt type:', '{{ receipt_type }}');

$(document).ready(function() {
    // Define banksList from the template context
    const banksList = [
        {% for code, name in bank_choices %}
            { label: '{{ name }}', value: '{{ code }}' },
        {% endfor %}
    ];

    // Utility functions
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Form validation state manager
    const validator = {
        errors: new Set(),
        updateSaveButton: function() {
            const saveBtn = $('button[type="submit"]');
            saveBtn.prop('disabled', this.errors.size > 0);
        },
        showError: function(field, message) {
            const $field = $(field);
            $field.addClass('is-invalid');
            let $feedback = $field.siblings('.invalid-feedback');
            if (!$feedback.length) {
                $feedback = $('<div class="invalid-feedback"></div>').insertAfter($field);
            }
            $feedback.text(message);
            this.errors.add($field.attr('id'));
            this.updateSaveButton();
        },
        clearError: function(field) {
            const $field = $(field);
            $field.removeClass('is-invalid');
            $field.siblings('.invalid-feedback').remove();
            this.errors.delete($field.attr('id'));
            this.updateSaveButton();
        }
    };

    // Client validation with strict autocomplete
    $("#client").autocomplete({
        source: function(request, response) {
            $.ajax({
                url: "{% url 'client-autocomplete' %}",
                dataType: "json",
                data: { term: request.term },
                success: function(data) {
                    response($.map(data.results, function(item) {
                        return {
                            label: item.text,
                            value: item.id
                        };
                    }));
                }
            });
        },
        minLength: 0,
        select: function(event, ui) {
            $("#client").val(ui.item.label);
            $("#client_id").val(ui.item.value);
            validator.clearError('#client');
            return false;
        },
        change: function(event, ui) {
            // If no item was selected
            if (!ui.item) {
                $("#client_id").val('');
                $("#client").val('');
                validator.showError('#client', 'Please select a valid client from the list');
            }
        }
    }).on('input', function() {
        // Clear hidden input when user starts typing
        $("#client_id").val('');
        validator.showError('#client', 'Please select a valid client from the list');
    });

    // Entity validation with strict autocomplete
    $("#entity").autocomplete({
        source: function(request, response) {
            $.ajax({
                url: "{% url 'entity-autocomplete' %}",
                dataType: "json",
                data: { term: request.term },
                success: function(data) {
                    response($.map(data.results, function(item) {
                        return {
                            label: item.text,
                            value: item.id
                        };
                    }));
                }
            });
        },
        minLength: 0,
        select: function(event, ui) {
            $("#entity").val(ui.item.label);
            $("#entity_id").val(ui.item.value);
            validator.clearError('#entity');
            return false;
        },
        change: function(event, ui) {
            // If no item was selected
            if (!ui.item) {
                $("#entity_id").val('');
                $("#entity").val('');
                validator.showError('#entity', 'Please select a valid entity from the list');
            }
        }
    }).on('input', function() {
        // Clear hidden input when user starts typing
        $("#entity_id").val('');
        validator.showError('#entity', 'Please select a valid entity from the list');
    });

    // Bank validation with strict autocomplete
    $("#issuingBank").autocomplete({
        source: banksList,
        minLength: 0,
        select: function(event, ui) {
            $("#issuingBank").val(ui.item.label);
            $("#issuingBankCode").val(ui.item.value);
            validator.clearError('#issuingBank');
            return false;
        },
        change: function(event, ui) {
            // If no item was selected
            if (!ui.item) {
                $("#issuingBankCode").val('');
                $("#issuingBank").val('');
                validator.showError('#issuingBank', 'Please select a valid bank from the list');
            }
        }
    }).on('input', function() {
        // Clear hidden input when user starts typing
        $("#issuingBankCode").val('');
        validator.showError('#issuingBank', 'Please select a valid bank from the list');
    }).focus(function() {
        $(this).autocomplete("search", "");
    });

    $("#compensate-receipt-autocomplete").autocomplete({
            source: function(request, response) {
                console.log('Unpaid Receipt search term:', request.term);
                $.ajax({
                    url: "{% url 'unpaid-receipt-autocomplete' %}",
                    dataType: "json",
                    data: { term: request.term },
                    success: function(data) {
                        console.log('Unpaid Receipt data received:', data);
                        response($.map(data.results, function(item) {
                            return {
                                label: item.description,
                                value: item.description,  // Display full description
                                id: item.id
                            };
                        }));
                    },
                    error: function(xhr, status, error) {
                        console.error('Unpaid Receipt autocomplete error:', error);
                        console.log('XHR response:', xhr.responseText);
                    }
                });
            },
            minLength: 0,
            select: function(event, ui) {
                console.log('Unpaid Receipt selected:', ui.item);
                $("#compensate-receipt-id").val(ui.item.id);
                $("#compensate-receipt-autocomplete").val(ui.item.label);
                $("#compensation-details").html(`
                    Selected Receipt: ${ui.item.label}
                `);
            },
            change: function(event, ui) {
                console.log('Unpaid Receipt change event triggered');
                if (!ui.item) {
                    $("#compensate-receipt-id").val('');
                    $("#compensate-receipt-autocomplete").val('');
                    $("#compensation-details").empty();
                }
            }
        });

    // Receipt number validation
    function setupReceiptNumberValidation() {
        const receiptInput = '{{ receipt_type }}' === 'check' ? '#check_number' : '#lcn_number';
        $(receiptInput)
            .on('input', function() {
                const value = $(this).val();
                if (!/^\d*$/.test(value)) {
                    // Remove non-numeric characters
                    $(this).val(value.replace(/\D/g, ''));
                }
            })
            .on('blur', async function() {
                const number = $(this).val();
                const entityId = $('#entity_id').val();
                const bank = $('#issuingBankCode').val();

                if (!number) {
                    validator.showError(this, 'Receipt number is required');
                    return;
                }

                if (!entityId) {
                    validator.showError(this, 'Please select an entity first');
                    return;
                }

                if (!bank) {
                    validator.showError(this, 'Please select a bank first');
                    return;
                }

                try {
                    const response = await fetch('{% url "validate-receipt-number" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                        body: JSON.stringify({
                            number: number,
                            entity_id: entityId,
                            bank: bank,
                            receipt_type: '{{ receipt_type }}',
                            current_id: '{{ receipt.id|default:"" }}'
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const data = await response.json();
                    if (data.exists) {
                        validator.showError(this, `This ${('{{ receipt_type }}' === 'check' ? 'check' : 'LCN')} number already exists for this entity and bank`);
                    } else {
                        validator.clearError(this);
                    }
                } catch (error) {
                    console.error('Validation error:', error);
                    validator.showError(this, 'Error checking for duplicate receipt number');
                }
            });

        // Also validate when entity or bank changes
        $('#entity, #issuingBank').on('change', function() {
            $(receiptInput).trigger('blur');
        });
    }

    // Amount validation
    $('#amount').on('input', function() {
        const value = $(this).val();
        if (!/^\d*\.?\d*$/.test(value)) {
            // Remove invalid characters
            $(this).val(value.replace(/[^\d.]/g, ''));
        }
    }).on('blur', function() {
        const amount = parseFloat($(this).val());
        if (isNaN(amount) || amount <= 0) {
            validator.showError(this, 'Amount must be positive');
        } else {
            validator.clearError(this);
        }
    });

    // Initialize validations
    setupReceiptNumberValidation();

    // Form submission validation
    $('#receiptForm').on('submit', function(e) {
        // Check all required fields
        $('input[required], select[required]').each(function() {
            if (!$(this).val()) {
                e.preventDefault();
                validator.showError(this, 'This field is required');
            }
        });

        if (validator.errors.size > 0) {
            e.preventDefault();
            alert('Please correct all errors before submitting.');
        }
    });
});
</script>