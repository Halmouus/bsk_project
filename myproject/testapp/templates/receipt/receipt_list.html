{% extends 'base.html' %}

{% load presentation_filters %}
{% load accounting_filters %}

<!-- Debug info -->
{% comment %}
Available filters:
{{ presentation_filters }}
{% endcomment %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="fas fa-receipt text-primary me-2"></i> Receipts Management
        </h2>
        <div class="btn-group">
            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                <i class="fas fa-plus-circle"></i> New Receipt
            </button>
            <div class="dropdown-menu">
                <a class="dropdown-item" href="#" data-toggle="modal" data-target="#receiptModal" data-type="check">
                    <i class="fas fa-money-check"></i> Check
                </a>
                <a class="dropdown-item" href="#" data-toggle="modal" data-target="#receiptModal" data-type="lcn">
                    <i class="fas fa-file-invoice-dollar"></i> LCN
                </a>
                <a class="dropdown-item" href="#" data-toggle="modal" data-target="#receiptModal" data-type="cash">
                    <i class="fas fa-money-bill"></i> Cash
                </a>
                <a class="dropdown-item" href="#" data-toggle="modal" data-target="#receiptModal" data-type="transfer">
                    <i class="fas fa-exchange-alt"></i> Transfer
                </a>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs" id="receiptTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="checks-tab" data-toggle="tab" href="#checks" role="tab">
                <i class="fas fa-money-check"></i> Checks
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="lcns-tab" data-toggle="tab" href="#lcns" role="tab">
                <i class="fas fa-file-invoice-dollar"></i> LCNs
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="cash-tab" data-toggle="tab" href="#cash" role="tab">
                <i class="fas fa-money-bill"></i> Cash
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="transfers-tab" data-toggle="tab" href="#transfers" role="tab">
                <i class="fas fa-exchange-alt"></i> Transfers
            </a>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content mt-4" id="receiptTabsContent">
        <!-- Checks Tab Content -->
        <div class="tab-pane fade show active" id="checks" role="tabpanel">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Entity</th>
                            <th>Client</th>
                            <th>Check Number</th>
                            <th>Issuing Bank</th>
                            <th>Due Date</th>
                            <th class="text-right" style="min-width: 120px;">Amount</th>
                            <th>Bank Issued To</th>
                            <th>Presentation</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for check in receipts.checks %}
                        <tr class="status-{{ check.status|lower }}">
                            <td>{{ check.operation_date|date:"Y-m-d" }}</td>
                            <td>
                                <strong>{{ check.entity.name }}</strong><br>
                                <small class="text-muted">{{ check.entity.ice_code }}</small>
                            </td>
                            <td>
                                <small>{{ check.client.name }}</small>
                            </td>
                            <td>{{ check.check_number }}</td>
                            <td>{{ check.get_issuing_bank_display }}</td>
                            <td>{{ check.due_date|date:"Y-m-d" }}</td>
                            <td class="text-right" style="min-width: 120px;">{{ check.amount|format_balance }}</td>

                            <!-- Bank Issued To column -->
                            <td>
                                {% with pres=check.check_presentations.first %}
                                    {% if pres %}
                                        {{ pres.presentation.bank_account.bank }} - {{ pres.presentation.bank_account.account_number }}
                                    {% else %}
                                        -
                                    {% endif %}
                                {% endwith %}
                            </td>
                            <td>
                                {% with pres=check.check_presentations.first %}
                                    {% if pres %}
                                        {{ pres.presentation.bank_reference }} at {{ pres.presentation.date|date:"d/m/Y" }}<br>
                                        <span class="badge badge-{{ pres.presentation.status|status_badge }}">
                                            {{ pres.presentation.get_status_display }}
                                        </span>
                                    {% else %}
                                        -
                                    {% endif %}
                                {% endwith %}
                            </td>
                            <td>
                                <span class="badge badge-{{ check.status|status_badge }}">
                                    {{ check.get_status_display }}
                                </span>
                                {% if check.status == 'UNPAID' and check.rejection_cause %}
                                    <br><small class="text-danger">{{ check.get_rejection_cause_display }}</small>
                                    {% with last_pres=check.check_presentations.last %}
                                        {% if last_pres %}
                                            <br><small class="text-muted">Represented on {{ last_pres.presentation.date|date:"Y-m-d" }}</small>
                                        {% endif %}
                                    {% endwith %}
                                {% endif %}
                                {% if check.compensation_info %}
                                    <br><small class="text-muted">{{ check.compensation_info }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-info" onclick="viewReceiptTimeline('check', '{{ check.id }}')">
                                        <i class="fas fa-history"></i>
                                    </button>
                                    {% with pres=check.check_presentations.first %}
                                        {% if not pres %}
                                            <button class="btn btn-sm btn-primary" data-toggle="modal" data-target="#receiptModal" 
                                                    data-type="check" data-action="edit" data-id="{{ check.id }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger delete-receipt" data-type="check" data-id="{{ check.id }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="11" class="text-center">No checks found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- LCNs Tab Content -->
        <div class="tab-pane fade" id="lcns" role="tabpanel">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Entity</th>
                            <th>Client</th>
                            <th>LCN Number</th>
                            <th>Issuing Bank</th>
                            <th>Due Date</th>
                            <th class="text-right" style="min-width: 120px;">Amount</th>
                            <th>Bank Issued To</th>
                            <th>Presentation</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lcn in receipts.lcns %}
                        <tr class="status-{{ lcn.status|lower }}">
                            <td>{{ lcn.operation_date|date:"Y-m-d" }}</td>
                            <td>
                                <strong>{{ lcn.entity.name }}</strong><br>
                                <small class="text-muted">{{ lcn.entity.ice_code }}</small>
                            </td>
                            <td>
                                <small>{{ lcn.client.name }}</small>
                            </td>
                            <td>{{ lcn.lcn_number }}</td>
                            <td>{{ lcn.get_issuing_bank_display }}</td>
                            <td>{{ lcn.due_date|date:"Y-m-d" }}</td>
                            <td class="text-right" style="min-width: 120px;">{{ lcn.amount|format_balance }}</td>
                            <!-- Bank Issued To column -->
                            <td>
                                {% with pres=lcn.lcn_presentations.first %}
                                    {% if pres %}
                                        {{ pres.presentation.bank_account.bank }} - {{ pres.presentation.bank_account.account_number }}
                                    {% else %}
                                        -
                                    {% endif %}
                                {% endwith %}
                            </td>
                            <td>
                                {% with pres=lcn.lcn_presentations.first %}
                                    {% if pres %}
                                        {{ pres.presentation.bank_reference }} at {{ pres.presentation.date|date:"d/m/Y" }}<br>
                                        <span class="badge badge-{{ pres.presentation.status|status_badge }}">
                                            {{ pres.presentation.get_status_display }}
                                        </span>
                                    {% else %}
                                        -
                                    {% endif %}
                                {% endwith %}
                            </td>
                            <td>
                                <span class="badge badge-{{ lcn.status|status_badge }}">
                                    {{ lcn.get_status_display }}
                                </span>
                                {% if lcn.status == 'UNPAID' and lcn.rejection_cause %}
                                    <br><small class="text-danger">{{ lcn.get_rejection_cause_display }}</small>
                                {% endif %}
                                {% if lcn.compensation_info %}
                                    <br><small class="text-muted">{{ lcn.compensation_info }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-info" onclick="viewReceiptTimeline('lcn', '{{ lcn.id }}')">
                                        <i class="fas fa-history"></i>
                                    </button>
                                    {% with pres=lcn.lcn_presentations.first %}
                                        {% if not pres %}
                                            <button class="btn btn-sm btn-primary" data-toggle="modal" data-target="#receiptModal" 
                                                    data-type="lcn" data-action="edit" data-id="{{ lcn.id }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger delete-receipt" data-type="lcn" data-id="{{ lcn.id }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="11" class="text-center">No LCNs found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Cash Tab -->
        <div class="tab-pane fade" id="cash" role="tabpanel">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Entity</th>
                            <th>Client</th>
                            <th>Reference</th>
                            <th>Credited Account</th>
                            <th class="text-right" style="min-width: 120px;">Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cash in receipts.cash %}
                        <tr>
                            <td>{{ cash.operation_date|date:"Y-m-d" }}</td>
                            <td>{{ cash.entity.name }}</td>
                            <td>{{ cash.client.name }}</td>
                            <td>{{ cash.reference_number }}</td>
                            <td>{{ cash.credited_account.bank }} - {{ cash.credited_account.account_number }}</td>
                            <td class="text-right" style="min-width: 120px;">{{ cash.amount|format_balance }}</td>
                            <td>
                                <div class="btn-group">
                                    {% if cash.can_edit %}
                                    <button class="btn btn-sm btn-info" data-toggle="modal" data-target="#receiptModal" 
                                            data-type="cash" data-action="edit" data-id="{{ cash.id }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    {% endif %}
                                    {% if cash.can_delete %}
                                    <button class="btn btn-sm btn-danger delete-receipt" data-type="cash" data-id="{{ cash.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center">No cash receipts found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Transfers Tab -->
        <div class="tab-pane fade" id="transfers" role="tabpanel">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Entity</th>
                            <th>Client</th>
                            <th>Transfer Reference</th>
                            <th>Transfer Date</th>
                            <th>Credited Account</th>
                            <th class="text-right" style="min-width: 120px;">Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transfer in receipts.transfers %}
                        <tr>
                            <td>{{ transfer.operation_date|date:"Y-m-d" }}</td>
                            <td>{{ transfer.entity.name }}</td>
                            <td>{{ transfer.client.name }}</td>
                            <td>{{ transfer.transfer_reference }}</td>
                            <td>{{ transfer.transfer_date|date:"Y-m-d" }}</td>
                            <td>{{ transfer.credited_account.bank }} - {{ transfer.credited_account.account_number }}</td>
                            <td class="text-right" style="min-width: 120px;">{{ transfer.amount|format_balance }}</td>
                            <td>
                                <div class="btn-group">
                                    {% if transfer.can_edit %}
                                    <button class="btn btn-sm btn-info" data-toggle="modal" data-target="#receiptModal" 
                                            data-type="transfer" data-action="edit" data-id="{{ transfer.id }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    {% endif %}
                                    {% if transfer.can_delete %}
                                    <button class="btn btn-sm btn-danger delete-receipt" data-type="transfer" data-id="{{ transfer.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center">No transfers found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        </div>
    </div>
</div>

<!-- Receipt Modal -->
<div class="modal fade" id="receiptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Modal content will be loaded dynamically -->
        </div>
    </div>
</div>

<!-- Timeline Modal -->
<div class="modal fade" id="timelineModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Content will be loaded dynamically -->
        </div>
    </div>
</div>

<style>
    /* Status Badge Colors */
    .badge-portfolio { background-color: #6c757d; }
    .badge-presented_collection, .badge-presented_discount { background-color: #17a2b8; }
    .badge-paid { background-color: #28a745; }
    .badge-unpaid { background-color: #dc3545; }
    .badge-compensated { background-color: #fd7e14; }  /* Orange color for compensated */
    
    /* Row Status Highlighting */
    tr.status-paid { background-color: rgba(40, 167, 69, 0.1); }     /* Light green */
    tr.status-unpaid { background-color: rgba(220, 53, 69, 0.1); }   /* Light red */
    tr.status-compensated { background-color: rgba(253, 126, 20, 0.1); } /* Light orange */
    
    /* Maintain hover effect with status background */
    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.075) !important;
    }

    .form-floating > .form-control {
        padding-left: 2.5rem;
    }

    .form-floating > label {
        padding-left: 1.75rem;
    }

    /* Autocomplete dropdown styling */
    .ui-autocomplete {
        max-height: 200px;
        overflow-y: auto;
        border-radius: 0.5rem;
        border: 1px solid rgba(0,0,0,.1);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
        z-index: 1050;
    }
</style>

<script>
    console.log("Extra JS loaded");

    const MOROCCAN_BANKS = [
        {% for code, name in bank_choices %}
            ['{{ code }}', '{{ name }}'],
        {% endfor %}
    ];

    var bankAccountsList = [
    {value: '', label: 'Select Bank Account'},
    {% for account in bank_accounts %}
        {
            value: "{{ account.id }}",
            label: "{{ account.get_bank_display }} - {{ account.account_number }}"
        }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

    // Debug helper
    const debug = {
        log: function(component, message, data = null) {
            console.log(`[${component}]`, message, data || '');
        }
    };

// Track filters per tab
let activeFilters = null;

// Handle tab switching
$('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
    debug.log('TabSwitch', 'Tab changed to:', e.target.id);
    
    // Get the target tab id (checks, lcns, cash, or transfers)
    const targetTab = $(e.target).attr('href').replace('#', '');
    debug.log('TabSwitch', 'Target tab:', targetTab);

    // Clean up existing filters if any
    if (activeFilters) {
        debug.log('TabSwitch', 'Cleaning up old filters');
        activeFilters.destroy();
        activeFilters = null;
    }

    // Initialize new filters based on tab type
    debug.log('TabSwitch', 'Initializing filters for:', targetTab);
    activeFilters = new ReceiptFilters(targetTab, '/testapp/receipts/filter/?type=' + targetTab);
});
    
$(document).ready(function() {

    // Initialize filters for each tab
    debug.log('Init', 'Initializing filters for active tab');
    const activeTab = $('.tab-pane.active').attr('id');
    debug.log('Init', 'Active tab:', activeTab);
    activeFilters = new ReceiptFilters(activeTab, '/testapp/receipts/filter/?type=' + activeTab);


    $('#receiptModal').on('show.bs.modal', function(e) {
        const button = $(e.relatedTarget);
        const type = button.data('type');
        const action = button.data('action');
        const id = button.data('id');
        
        let url = '';
        if (action === 'edit') {
            url += `edit/${type}/${id}/`;
        } else {
            url += `create/${type}/`;
        }

        // Load modal content
        $.get(url, function(data) {
            $('#receiptModal .modal-content').html(data);
            initializeForm();

            if (action === 'edit') {
                // Set form action URL for edit
                $('#receiptForm').attr('action', url);
                
                // Initialize Select2 with pre-selected values
                if (data.client) {
                    const clientOption = new Option(data.client.text, data.client.id, true, true);
                    $('#client').append(clientOption).trigger('change');
                }
                if (data.entity) {
                    const entityOption = new Option(data.entity.text, data.entity.id, true, true);
                    $('#entity').append(entityOption).trigger('change');
                }
            }
        });
    });

        // Handle form submission for both create and edit
        $(document).on('submit', '#receiptForm', function(e) {
            e.preventDefault();
            const form = $(this);
            
            // Create FormData object and append transfer fields manually
            let formData = new FormData(form[0]);
            if ($('#transfer_reference').length) {
                formData.append('transfer_reference', $('#transfer_reference').val());
                formData.append('transfer_date', $('#transfer_date').val());
            }

            // Convert FormData to URLSearchParams for jQuery
            const data = new URLSearchParams(formData).toString();

            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: data,
                success: function(response) {
                    if (response.status === 'success') {
                        $('#receiptModal').modal('hide');
                        showToast(response.message, 'success');
                        location.reload();
                    } else {
                        showFormErrors(form, response.errors);
                    }
                },
                error: function(xhr) {
                    try {
                        const errors = JSON.parse(xhr.responseText);
                        showFormErrors(form, errors);
                    } catch (e) {
                        showToast('An error occurred while saving the receipt.', 'error');
                    }
                }
            });
        });

        function showFormErrors(form, errors) {
            // Clear previous errors
            form.find('.is-invalid').removeClass('is-invalid');
            form.find('.invalid-feedback').remove();

            // Show new errors
            Object.keys(errors).forEach(field => {
                const input = form.find(`[name="${field}"]`);
                const error = errors[field].join(' ');
                input.addClass('is-invalid');
                input.after(`<div class="invalid-feedback">${error}</div>`);
            });
        }

        function showToast(message, type = 'success') {
            const toast = `
                <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-delay="3000">
                    <div class="toast-header bg-${type} text-white">
                        <strong class="mr-auto">Notification</strong>
                        <button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>
            `;

            const toastContainer = $('<div class="toast-container position-fixed top-0 right-0 p-3"></div>');
            toastContainer.html(toast);
            $('body').append(toastContainer);

            $('.toast').toast('show');
            
            // Remove toast after it's hidden
            $('.toast').on('hidden.bs.toast', function() {
                $(this).closest('.toast-container').remove();
            });
        }
    });

    // Initialize form elements after modal load
    function initializeForm() {
        console.log('Initializing form with autocomplete...');
        console.log('Client input exists:', $('#client').length);
        console.log('Entity input exists:', $('#entity').length);

    // Initialize client autocomplete
    $("#client").autocomplete({
                minLength: 0,
            source: function(request, response) {
                console.log('Client search term:', request.term);
                $.ajax({
                    url: "{% url 'client-autocomplete' %}",
                    dataType: "json",
                    data: { term: request.term },
                    success: function(data) {
                        console.log('Client data received:', data);
                        response($.map(data.results, function(item) {
                            return {
                                label: item.text,
                                value: item.id
                            };
                        }));
                    },
                    error: function(xhr, status, error) {
                        console.error('Client autocomplete error:', error);
                    }
                });
            },
            select: function(event, ui) {
                console.log('Client selected:', ui.item);
                $("#client").val(ui.item.label);
                $("#client_id").val(ui.item.value);
                return false;
            }
        }).on('focus', function() {
            console.log('Client input focused');
        });

        // Initialize entity autocomplete
        $("#entity").autocomplete({
            minLength: 0,
            source: function(request, response) {
                console.log('Entity search term:', request.term);
                $.ajax({
                    url: "{% url 'entity-autocomplete' %}",
                    dataType: "json",
                    data: { term: request.term },
                    success: function(data) {
                        console.log('Entity data received:', data);
                        response($.map(data.results, function(item) {
                            return {
                                label: item.text,
                                value: item.id
                            };
                        }));
                    },
                    error: function(xhr, status, error) {
                        console.error('Entity autocomplete error:', error);
                        console.log('XHR response:', xhr.responseText);
                    }
                });
            },
            select: function(event, ui) {
                console.log('Entity selected:', ui.item);
                $("#entity").val(ui.item.label);
                $("#entity_id").val(ui.item.value);
                return false;
            }
        }).on('focus', function() {
            console.log('Entity input focused');
        });

        

        // Add some basic styling to autocomplete dropdown
        $(".ui-autocomplete").addClass("dropdown-menu").css({
            'max-height': '200px',
            'overflow-y': 'auto',
            'overflow-x': 'hidden',
            'z-index': '9999'
        });
    }


    function initializeBankAutocomplete() {
    const banksList = [
        {% for code, name in bank_choices %}
        { label: '{{ name }}', value: '{{ code }}' },
        {% endfor %}
    ];

    $("#issuingBank").autocomplete({
        source: banksList,
        minLength: 0,
        select: function(event, ui) {
        $("#issuingBank").val(ui.item.label);
        $("#issuingBankCode").val(ui.item.value);
        return false;
        }
    }).focus(function() {
        $(this).autocomplete("search", "");
    });

    // Add dropdown indicator
    if (!$("#issuingBank").next('.bank-dropdown-toggle').length) {
        $("#issuingBank").after('<span class="bank-dropdown-toggle"><i class="fas fa-chevron-down"></i></span>');
        $(".bank-dropdown-toggle").click(function() {
        $("#issuingBank").focus();
        });
    }
    }

    // Modify the modal show event handler
    $('#receiptModal').on('show.bs.modal', function(e) {
    const button = $(e.relatedTarget);
    const type = button.data('type');
    const action = button.data('action');
    const id = button.data('id');
    
    let url = '';
    if (action === 'edit') {
        url = `edit/${type}/${id}/`;
    } else {
        url = `create/${type}/`;
    }

    $.get(url, function(data) {
        $('#receiptModal .modal-content').html(data);
        initializeForm();
        initializeBankAutocomplete(); // Add this line
    });
    });

    // Handle delete
    $('.delete-receipt').click(function() {
        if (confirm('Are you sure you want to delete this receipt?')) {
            const type = $(this).data('type');
            const id = $(this).data('id');
            
            $.ajax({
                url: `/testapp/receipts/delete/${type}/${id}/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function() {
                    location.reload();
                },
                error: function() {
                    alert('Error deleting receipt');
                }
            });
        }
    });
    class ReceiptFilters {
        constructor(tabId, filterEndpoint) {
        debug.log('ReceiptFilters', 'Initializing for tab:', tabId);
        this.tab = $(`#${tabId}`);
        this.endpoint = filterEndpoint;
        this.currentFilters = {};
        this.type = tabId; // 'checks', 'lcns', 'cash', 'transfers'
        
        this.createFilterUI();
        this.initializeFilters();
    }

    getFilterConfig() {
        debug.log('ReceiptFilters', 'Getting filter config for type:', this.type);
        
        const configs = {
            'checks': [
                {
                    type: 'client',
                    icon: 'user',
                    label: 'Client',
                    col: 3
                },
                {
                    type: 'entity',
                    icon: 'building',
                    label: 'Entity',
                    col: 3
                },
                {
                    type: 'status',
                    icon: 'tag',
                    label: 'Status',
                    col: 3,
                    isSelect: true,
                    options: [
                        {value: '', label: 'All Statuses'},
                        {value: 'PORTFOLIO', label: 'In Portfolio'},
                        {value: 'PRESENTED_COLLECTION', label: 'Presented for Collection'},
                        {value: 'PRESENTED_DISCOUNT', label: 'Presented for Discount'},
                        {value: 'DISCOUNTED', label: 'Discounted'},
                        {value: 'PAID', label: 'Paid'},
                        {value: 'UNPAID', label: 'Unpaid'},
                        {value: 'COMPENSATED', label: 'Compensated'}
                    ]
                },
                {
                    type: 'number',
                    icon: 'hashtag',
                    label: 'Check Number',
                    col: 3
                },
                // Add issuing bank dropdown
                { 
                    type: 'issuing_bank', 
                    icon: 'university', 
                    label: 'Issuing Bank', 
                    col: 4,
                    isSelect: true,
                    options: MOROCCAN_BANKS
                },
                // Add bank issued to dropdown
                { 
                    type: 'bank_issued_to', 
                    icon: 'university', 
                    label: 'Bank Issued To', 
                    col: 4,
                    isSelect: true,
                    options: bankAccountsList
                },
                // Add date ranges
                { 
                    type: 'creation_date_from', 
                    icon: 'calendar', 
                    label: 'Creation Date From', 
                    col: 4,
                    isDate: true 
                },
                { 
                    type: 'creation_date_to', 
                    icon: 'calendar', 
                    label: 'Creation Date To', 
                    col: 4,
                    isDate: true 
                },
                { 
                    type: 'due_date_from', 
                    icon: 'calendar', 
                    label: 'Due Date From', 
                    col: 4,
                    isDate: true 
                },
                { 
                    type: 'due_date_to', 
                    icon: 'calendar', 
                    label: 'Due Date To', 
                    col: 4,
                    isDate: true 
                },
                // Add amount ranges
                { 
                    type: 'amount_from', 
                    icon: 'money-bill', 
                    label: 'Amount From', 
                    col: 4,
                    isNumber: true 
                },
                { 
                    type: 'amount_to', 
                    icon: 'money-bill', 
                    label: 'Amount To', 
                    col: 4,
                    isNumber: true 
                },
                { 
                    type: 'historical_status', 
                    icon: 'history', 
                    label: 'Was Status', 
                    col: 4,
                    isSelect: true,
                    options: [
                        {value: '', label: 'All Statuses'},
                        {value: 'PORTFOLIO', label: 'In Portfolio'},
                        {value: 'PRESENTED_COLLECTION', label: 'Presented for Collection'},
                        {value: 'PRESENTED_DISCOUNT', label: 'Presented for Discount'},
                        {value: 'PAID', label: 'Paid'},
                        {value: 'REJECTED', label: 'Rejected'},
                        {value: 'COMPENSATED', label: 'Compensated'},
                        {value: 'UNPAID', label: 'Unpaid'}
                    ]
                }
            ],
            'lcns': [
                {
                    type: 'client',
                    icon: 'user',
                    label: 'Client',
                    col: 3
                },
                {
                    type: 'entity',
                    icon: 'building',
                    label: 'Entity',
                    col: 3
                },
                {
                    type: 'status',
                    icon: 'tag',
                    label: 'Status',
                    col: 3,
                    isSelect: true,
                    options: [
                        {value: '', label: 'All Statuses'},
                        {value: 'PORTFOLIO', label: 'In Portfolio'},
                        {value: 'PRESENTED_COLLECTION', label: 'Presented for Collection'},
                        {value: 'PRESENTED_DISCOUNT', label: 'Presented for Discount'},
                        {value: 'DISCOUNTED', label: 'Discounted'},
                        {value: 'PAID', label: 'Paid'},
                        {value: 'UNPAID', label: 'Unpaid'},
                        {value: 'COMPENSATED', label: 'Compensated'}
                    ]
                },
                {
                    type: 'number',
                    icon: 'hashtag',
                    label: 'LCN Number',
                    col: 3
                },
                // Add issuing bank dropdown
                { 
                    type: 'issuing_bank', 
                    icon: 'university', 
                    label: 'Issuing Bank', 
                    col: 4,
                    isSelect: true,
                    options: MOROCCAN_BANKS
                },
                { 
                    type: 'bank_issued_to', 
                    icon: 'university', 
                    label: 'Bank Issued To', 
                    col: 4,
                    isSelect: true,
                    options: bankAccountsList
                },
                { 
                    type: 'creation_date_from', 
                    icon: 'calendar', 
                    label: 'Creation Date From', 
                    col: 4,
                    isDate: true 
                },
                { 
                    type: 'creation_date_to', 
                    icon: 'calendar', 
                    label: 'Creation Date To', 
                    col: 4,
                    isDate: true 
                },
                { 
                    type: 'due_date_from', 
                    icon: 'calendar', 
                    label: 'Due Date From', 
                    col: 4,
                    isDate: true 
                },
                { 
                    type: 'due_date_to', 
                    icon: 'calendar', 
                    label: 'Due Date To', 
                    col: 4,
                    isDate: true 
                },
                { 
                    type: 'amount_from', 
                    icon: 'money-bill', 
                    label: 'Amount From', 
                    col: 4,
                    isNumber: true 
                },
                { 
                    type: 'amount_to', 
                    icon: 'money-bill', 
                    label: 'Amount To', 
                    col: 4,
                    isNumber: true 
                },
                { 
                    type: 'historical_status', 
                    icon: 'history', 
                    label: 'Was Status', 
                    col: 4,
                    isSelect: true,
                    options: [
                        {value: '', label: 'All Statuses'},
                        {value: 'PORTFOLIO', label: 'In Portfolio'},
                        {value: 'PRESENTED_COLLECTION', label: 'Presented for Collection'},
                        {value: 'PRESENTED_DISCOUNT', label: 'Presented for Discount'},
                        {value: 'PAID', label: 'Paid'},
                        {value: 'REJECTED', label: 'Rejected'},
                        {value: 'COMPENSATED', label: 'Compensated'},
                        {value: 'UNPAID', label: 'Unpaid'}
                    ]
                }
            ],
            'cash': [
                {
                    type: 'client',
                    icon: 'user',
                    label: 'Client',
                    col: 4
                },
                {
                    type: 'entity',
                    icon: 'building',
                    label: 'Entity',
                    col: 4
                },
                {
                    type: 'credited_account',
                    icon: 'university',
                    label: 'Credited Account',
                    col: 4,
                    isSelect: true,
                    options: bankAccountsList
                }
            ],
            'transfers': [
                {
                    type: 'client',
                    icon: 'user',
                    label: 'Client',
                    col: 4
                },
                {
                    type: 'entity',
                    icon: 'building',
                    label: 'Entity',
                    col: 4
                },
                {
                    type: 'credited_account',
                    icon: 'university',
                    label: 'Credited Account',
                    col: 4,
                    isSelect: true,
                    options: bankAccountsList
                }
            ]
        };

        const config = configs[this.type];
        debug.log('ReceiptFilters', 'Filter config:', config);
        return config || [];
    }

    createFilterUI() {
        debug.log('ReceiptFilters', 'Creating filter UI');
        const filters = this.getFilterConfig();
        let filterElements = [];
        filters.forEach(filter => {
            filterElements.push(this.createFilterElement(filter));
        });

        const filterHtml = `
            <div class="card mb-4" id="${this.type}-filters">
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <h6 class="mb-0">Filters</h6>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="${this.type}-reset-filters">
                            <i class="fas fa-undo me-1"></i>Reset
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="${this.type}-toggle-filters">
                            <i class="fas fa-filter me-1"></i>Hide Filters
                        </button>
                    </div>
                </div>
                <div class="card-body filter-content">
                    <div class="row g-3">
                        ${filterElements.join('')}
                    </div>
                </div>
            </div>`;

        debug.log('ReceiptFilters', 'Inserting filter HTML');
        this.tab.find('.table-responsive').before(filterHtml);

        // Set up toggle button
        $(`#${this.type}-toggle-filters`).click(() => {
            const $button = $(`#${this.type}-toggle-filters`);
            const $content = $button.closest('.card').find('.filter-content');
            $content.slideToggle();
            $button.html(
                $content.is(':visible') 
                ? '<i class="fas fa-filter me-1"></i>Hide Filters'
                : '<i class="fas fa-filter me-1"></i>Show Filters'
            );
        });

        // Set up reset button
        $(`#${this.type}-reset-filters`).click(() => {
            this.resetFilters();
        });
    }

    // Add resetFilters method to your class
    resetFilters() {
        debug.log('ReceiptFilters', 'Resetting all filters');
        
        // Reset all inputs and selects
        const filters = this.getFilterConfig();
        filters.forEach(filter => {
            const $element = $(`#${this.type}-${filter.type}-filter`);
            if ($element.is('select')) {
                $element.val('').trigger('change');
            } else {
                $element.val('').trigger('blur');
            }
        });

        // Clear current filters
        this.currentFilters = {};
        this.applyFilters();
    }

    

    createFilterElement(filter) {
        debug.log('Creating filter element:', filter);

        if (filter.isSelect) {
            return ` 
                <div class="col-md-${filter.col}">
                    <div class="form-floating">
                        <select class="form-control" id="${this.type}-${filter.type}-filter">
                            ${filter.options.map(opt => `
                                <option value="${opt.value}">${opt.label}</option>
                            `).join('')}
                        </select>
                        <label>
                            <i class="fas fa-${filter.icon} text-primary me-2"></i>${filter.label}
                        </label>
                    </div>
                </div>`;
        } else if (filter.isDate) {
            return `
                <div class="col-md-${filter.col}">
                    <div class="form-floating">
                        <input type="date" class="form-control" id="${this.type}-${filter.type}-filter">
                        <label>
                            <i class="fas fa-${filter.icon} text-primary me-2"></i>${filter.label}
                        </label>
                    </div>
                </div>`;
        } else if (filter.isNumber) {
            return `
                <div class="col-md-${filter.col}">
                    <div class="form-floating">
                        <input type="number" step="0.01" class="form-control" id="${this.type}-${filter.type}-filter">
                        <label>
                            <i class="fas fa-${filter.icon} text-primary me-2"></i>${filter.label}
                        </label>
                    </div>
                </div>`;
        }

        // Default text input
        return `
            <div class="col-md-${filter.col}">
                <div class="form-floating">
                    <input type="text" class="form-control" id="${this.type}-${filter.type}-filter">
                    <label>
                        <i class="fas fa-${filter.icon} text-primary me-2"></i>${filter.label}
                    </label>
                </div>
            </div>`;
    }

    initializeFilters() {
        debug.log('ReceiptFilters', 'Initializing filter handlers');
        const filters = this.getFilterConfig();

        filters.forEach(filter => {
            const elementId = `#${this.type}-${filter.type}-filter`;
            debug.log('Processing filter:', {
                type: filter.type,
                elementId: elementId,
                elementExists: $(elementId).length > 0,
                isSelect: filter.isSelect,
                isDate: filter.isDate,
                isNumber: filter.isNumber
            });
            if (filter.type === 'client') {
                this.initializeClientAutocomplete();
                $(elementId).on('blur', () => {
                    if (!$(elementId).val()) {
                        debug.log('Filter', 'Client input emptied on blur');
                        this.updateFilter('client', '');
                    }
                });
            } else if (filter.type === 'entity') {
                this.initializeEntityAutocomplete();
                $(elementId).on('blur', () => {
                    if (!$(elementId).val()) {
                        debug.log('Filter', 'Entity input emptied on blur');
                        this.updateFilter('entity', '');
                    }
                });
            } else if (filter.isSelect || filter.isDate || filter.isNumber) {
                debug.log('Setting up select/date/number filter:', filter.type);
                $(elementId).on('change', () => {
                    const value = $(elementId).val();
                    debug.log('Filter', `${filter.type} changed:`, value);
                    this.updateFilter(filter.type, value);
                });
                // Blur handler for date and number inputs
                if (filter.isDate || filter.isNumber) {
                    debug.log('Adding blur handler for:', filter.type);
                    $(elementId).on('blur', () => {
                        if (!$(elementId).val()) {
                            debug.log('Filter', `${filter.type} input emptied on blur`);
                            this.updateFilter(filter.type, '');
                        }
                    });
                }
            } else {
                let timeout;
                $(elementId).on('input', (e) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        debug.log('Filter', `${filter.type} input:`, e.target.value);
                        this.updateFilter(filter.type, e.target.value);
                    }, 300);
                });
                $(elementId).on('blur', (e) => {
                    if (!e.target.value) {
                        debug.log('Filter', `${filter.type} input emptied on blur`);
                        this.updateFilter(filter.type, '');
                    }
                });
            }
        });

        if (this.type === 'cash' || this.type === 'transfers') {
            const creditedAccountId = `#${this.type}-credited_account-filter`;
            debug.log('Filter', 'Initializing credited account select:', creditedAccountId);
            $(creditedAccountId).on('change', () => {
                const value = $(creditedAccountId).val();
                debug.log('Filter', 'Credited account changed:', value);
                this.updateFilter('credited_account', value);
            });
        }
    }

    initializeClientAutocomplete() {
        debug.log('ReceiptFilters', 'Initializing client autocomplete');
        $(`#${this.type}-client-filter`).autocomplete({
            minLength: 0,
            source: (request, response) => {
                $.get('/testapp/client/autocomplete', { term: request.term }).done(data => {
                    debug.log('Autocomplete', 'Client results:', data);
                    response(data.results.map(item => ({
                        label: item.text,
                        value: item.id
                    })));
                });
            },
            select: (event, ui) => {
                debug.log('Autocomplete', 'Client selected:', ui.item);
                $(`#${this.type}-client-filter`).val(ui.item.label);
                this.updateFilter('client', ui.item.value);
                return false;
            }
        });
    }

    initializeEntityAutocomplete() {
        debug.log('ReceiptFilters', 'Initializing entity autocomplete');
        $(`#${this.type}-entity-filter`).autocomplete({
            minLength: 0,
            source: function(request, response) {
                console.log('Entity search term:', request.term);
                $.ajax({
                    url: "{% url 'entity-autocomplete' %}",
                    dataType: "json",
                    data: { term: request.term },
                    success: function(data) {
                        console.log('Entity data received:', data);
                        response($.map(data.results, function(item) {
                            return {
                                label: item.text,
                                value: item.id
                            };
                        }));
                    },
                    error: function(xhr, status, error) {
                        console.error('Entity autocomplete error:', error);
                    }
                });
            },
            select: (event, ui) => {
                console.log('Entity selected:', ui.item);
                $(`#${this.type}-entity-filter`).val(ui.item.label);
                this.updateFilter('entity', ui.item.value);
                return false;
            }
        });
    }


    updateFilter(type, value) {
        debug.log('Filter', `Updating ${type} filter with value:`, value);

        // Handle empty values correctly
        if (value === '' || value === null || value === undefined) {
            debug.log('Filter', `Removing ${type} filter due to empty value`);
            delete this.currentFilters[type];
        } else {
            debug.log('Filter', `Setting ${type} filter to:`, value);
            this.currentFilters[type] = value;
        }

        // Debugging for current filters state
        debug.log('Filter', 'Current filters state:', this.currentFilters);

        // Apply filters immediately
        this.applyFilters();
    }

    applyFilters() {
        debug.log('ReceiptFilters', 'Applying filters:', this.currentFilters);
        
        $.get(this.endpoint, this.currentFilters)
            .done(response => {
                debug.log('ReceiptFilters', 'Filter response received');
                this.tab.find('tbody').html(response.html);
            })
            .fail(error => {
                console.error('Filter error:', error);
            });
    }

    destroy() {
        debug.log('ReceiptFilters', 'Destroying filters');
        // Remove filter UI
        $(`#${this.type}-filters`).remove();
        // Clean up event handlers
        const filters = this.getFilterConfig();
        filters.forEach(filter => {
            const elementId = `#${this.type}-${filter.type}-filter`;
            $(elementId).off();
            if (filter.type === 'client' || filter.type === 'entity') {
                $(elementId).autocomplete('destroy');
            }
        });
    }
}
// Keyboard shortcuts
$(document).keydown(function(e) {
    // Only trigger if no modal is open and no input is focused
    if ($('.modal:visible').length === 0 && !$(document.activeElement).is('input, textarea, select')) {
        let receiptType = null;
        
        if (e.altKey) {
            switch(e.key.toLowerCase()) {
                case 'c': // Alt + C for Check
                    receiptType = 'check';
                    break;
                case 'l': // Alt + L for LCN
                    receiptType = 'lcn';
                    break;
                case 'e': // Alt + M for Cash (Money)
                    receiptType = 'cash';
                    break;
                case 'v': // Alt + T for Transfer
                    receiptType = 'transfer';
                    break;
            }
            
            if (receiptType) {
                e.preventDefault();
                const url = "{% url 'receipt-create' 'TYPE' %}".replace('TYPE', receiptType);
                const modal = $('#receiptModal');
                modal.modal('show');
                modal.find('.modal-content').load(url, function() {
                    setTimeout(function() {
                        initializeForm();
                    }, 100);
                });
            }
        }
    }
});

// Handle presentation status update
function updatePresentation(id) {
    const bankRef = $('#bankReference').val();
    if (!bankRef) {
        showError('Bank reference is required');
        return;
    }

    $.ajax({
        url: `/testapp/presentations/${id}/edit/`,
        method: 'POST',
        contentType: 'application/json',
        headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
        data: JSON.stringify({
            bank_reference: bankRef,
            status: $('#presentationStatus').val()
        }),
        success: () => location.reload(),
        error: xhr => showError(xhr.responseJSON?.message || 'Update failed')
    });
}

// Handle receipt status update
$(document).on('change', '.receipt-status', function() {
    const $select = $(this);
    const receiptId = $select.data('receipt-id');
    const newStatus = $select.val();

    if (!confirm('This status change is irreversible. Continue?')) {
        $select.val($select.find('option').not(':selected').val());
        return;
    }

    $.ajax({
        url: `/testapp/presentations/${presentationId}/edit/`,
        method: 'POST',
        contentType: 'application/json',
        headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
        data: JSON.stringify({
            receipt_id: receiptId,
            receipt_status: newStatus
        }),
        success: () => {
            $select.prop('disabled', true);
            location.reload();
        },
        error: xhr => {
            showError(xhr.responseJSON?.message || 'Status update failed');
            $select.val($select.find('option').not(':selected').val());
        }
    });
});

function viewReceiptTimeline(receiptType, receiptId) {
    console.log(`Loading timeline for ${receiptType} ${receiptId}`);
    
    // Show loading state in modal
    $('#timelineModal').modal('show');
    $('#timelineModal .modal-content').html(`
        <div class="modal-body text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p class="mt-2">Loading timeline...</p>
        </div>
    `);

    // Load timeline content
    $.ajax({
        url: `/testapp/receipts/${receiptType}/${receiptId}/timeline/`,
        method: 'GET',
        success: function(response) {
            $('#timelineModal .modal-content').html(response);
            
            // Initialize any tooltips or popovers
            $('#timelineModal [data-toggle="tooltip"]').tooltip();
            $('#timelineModal [data-toggle="popover"]').popover();
            
            // Add animation classes to timeline items
            $('.timeline-item').each(function(index) {
                $(this)
                    .addClass('animate__animated animate__fadeInLeft')
                    .css('animation-delay', `${index * 0.1}s`);
            });
        },
        error: function(xhr) {
            let errorMessage = 'Failed to load timeline';
            try {
                const response = JSON.parse(xhr.responseText);
                errorMessage = response.message || errorMessage;
            } catch(e) {}
            
            $('#timelineModal .modal-content').html(`
                <div class="modal-header">
                    <h5 class="modal-title">Error</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        ${errorMessage}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            `);
        }
    });
}

// Optional: Add helper function for formatting dates in timeline
function formatTimelineDate(dateString) {
    const date = new Date(dateString);
    return new Intl.DateTimeFormat('fr-MA', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    }).format(date);
}

// Add modal cleanup on hide
$('#timelineModal').on('hidden.bs.modal', function() {
    $(this).find('.modal-content').html('');
});

// Optional: Add keyboard shortcut to close modal
$(document).keydown(function(e) {
    if (e.key === 'Escape' && $('#timelineModal').hasClass('show')) {
        $('#timelineModal').modal('hide');
    }
});

function showError(message) {
    const toast = `
        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-delay="3000">
            <div class="toast-header bg-danger text-white">
                <strong class="mr-auto">Error</strong>
                <button type="button" class="ml-2 mb-1 close" data-dismiss="toast">&times;</button>
            </div>
            <div class="toast-body">${message}</div>
        </div>
    `;
    
    const container = $('<div class="toast-container position-fixed top-0 right-0 p-3"></div>')
        .append(toast)
        .appendTo('body');
    
    $('.toast').toast('show').on('hidden.bs.toast', () => container.remove());
}

// Add tooltip hints for shortcuts
$('[data-toggle="modal"][data-target="#receiptModal"]').each(function() {
    const type = $(this).data('type');
    let shortcut = '';
    switch(type) {
        case 'check':
            shortcut = 'Alt+C';
            break;
        case 'lcn':
            shortcut = 'Alt+L';
            break;
        case 'cash':
            shortcut = 'Alt+M';
            break;
        case 'transfer':
            shortcut = 'Alt+T';
            break;
    }
    if (shortcut) {
        $(this).attr('title', `${$(this).text().trim()} (${shortcut})`);
    }
});
</script>
{% endblock %}